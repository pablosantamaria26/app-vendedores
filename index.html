<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#0f172a">
    <title>App Vendedores Pro - Metis IA</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

    <style>
        /* =========================================
           ESTILOS CSS (MODERN UI/UX)
           ========================================= */
        :root {
            --bg-body: #0f172a;
            --bg-card: #1e293b;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --accent: #4CC9F0;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --purple: #8b5cf6;
            --header-bg: rgba(15, 23, 42, 0.98);
        }

        [data-theme="violet"] { --accent: #7C5DFF; }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; font-family: 'Inter', sans-serif; background: var(--bg-body); color: var(--text-primary); overflow: hidden; height: 100vh; display: flex; flex-direction: column; }
        
        /* ANIMACIONES */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        /* VISTAS */
        .view { display: none; height: 100%; flex-direction: column; overflow-y: auto; padding-bottom: 90px; }
        .view.active { display: flex; animation: fadeIn 0.3s ease; }

        /* HEADER */
        .app-header { padding: 15px 20px; background: var(--header-bg); position: sticky; top: 0; z-index: 50; border-bottom: 1px solid #334155; backdrop-filter: blur(5px); }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        
        /* NUEVO: BUSCADOR INTELIGENTE */
        .search-container {
            margin-top: 10px;
            position: relative;
        }
        .smart-input {
            width: 100%; padding: 12px 15px; padding-left: 40px;
            background: #1e293b; border: 1px solid #475569; border-radius: 12px;
            color: #fff; font-size: 16px; outline: none; transition: 0.3s;
        }
        .smart-input:focus { border-color: var(--accent); box-shadow: 0 0 15px rgba(76,201,240,0.15); }
        .search-icon { position: absolute; left: 12px; top: 12px; color: #94a3b8; }
        
        .live-result {
            margin-top: 8px; padding: 10px; border-radius: 10px;
            display: flex; align-items: center; gap: 10px; font-size: 13px;
            animation: fadeIn 0.3s;
        }
        .live-result.success { background: rgba(16, 185, 129, 0.1); border: 1px solid var(--success); color: var(--success); }
        .live-result.error { background: rgba(239, 68, 68, 0.1); border: 1px solid var(--danger); color: var(--danger); }

        /* ALERTAS DE RUTA */
        .route-alert {
            background: rgba(245, 158, 11, 0.15); border: 1px solid rgba(245, 158, 11, 0.4); color: var(--warning);
            padding: 8px 12px; border-radius: 8px; font-size: 12px; font-weight: 600; margin-bottom: 10px;
            display: flex; align-items: center; gap: 8px; animation: fadeIn 0.5s ease;
        }
        .route-alert i { font-size: 14px; }
        .route-alert.normal { background: rgba(16, 185, 129, 0.1); border-color: rgba(16, 185, 129, 0.3); color: var(--success); }

        /* PROGRESO */
        .progress-ring { position: relative; width: 45px; height: 45px; }
        .progress-ring circle { fill: transparent; stroke: #334155; stroke-width: 4; }
        .progress-ring .progreso-value { stroke: var(--accent); stroke-dasharray: 126; stroke-dashoffset: 126; transition: 0.8s; transform: rotate(-90deg); transform-origin: 50% 50%; stroke-linecap: round; }
        .progress-ring span { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 10px; font-weight: 700; }
        
        /* BARRA INFO */
        .info-bar { background: linear-gradient(90deg, #1e293b, #0f172a); border-left: 4px solid var(--accent); padding: 10px; border-radius: 8px; font-size: 13px; margin-bottom: 10px; display:flex; justify-content: space-between; align-items:center; gap:8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .sync-status { font-size: 11px; color: var(--text-secondary); display: flex; align-items: center; gap: 5px; }
        .sync-status.syncing { color: var(--accent); }
        .sync-status.syncing i { animation: spin 1s infinite linear; }

        /* LISTA CLIENTES */
        .cliente-list { padding: 15px; display: flex; flex-direction: column; gap: 15px; }
        .card { background: var(--bg-card); border-radius: 16px; padding: 16px; border: 1px solid #334155; position: relative; overflow: hidden; transition: all 0.3s ease; }
        .card.expanded { border-color: var(--accent); box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3); transform: translateY(-2px); }
        
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; gap: 10px; }
        .card h3 { margin: 0; font-size: 16px; font-weight: 600; line-height: 1.3; flex: 1; }
        .client-id-span { color: var(--accent); font-weight: 800; margin-right: 4px; font-size: 15px; }

        /* BADGES */
        .badge { padding: 4px 8px; border-radius: 6px; font-size: 10px; font-weight: 700; text-transform: uppercase; white-space: nowrap; flex-shrink: 0; }
        .badge.pendiente { background: rgba(245, 158, 11, 0.15); color: var(--warning); }
        .badge.visitado { background: rgba(16, 185, 129, 0.15); color: var(--success); }
        
        /* GPS BADGE */
        .gps-badge { 
            display: inline-flex; align-items: center; gap: 6px; 
            font-size: 11px; font-weight: 600; 
            background: rgba(15, 23, 42, 0.6); 
            border: 1px solid #334155; 
            padding: 5px 10px; border-radius: 20px; margin-bottom: 10px; 
            color: var(--text-secondary);
            width: fit-content;
        }
        .gps-badge.active { background: rgba(16, 185, 129, 0.1); border-color: rgba(16, 185, 129, 0.4); color: var(--success); }

        .card-body p { margin: 4px 0; font-size: 13px; color: var(--text-secondary); display: flex; align-items: center; gap: 8px; }
        
        /* BOTONES ACCI√ìN */
        .card-actions { display: none; gap: 8px; margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.05); }
        .card.expanded .card-actions { display: flex; }
        .btn-action { flex: 1; padding: 10px 4px; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; font-size: 10px; display: flex; flex-direction: column; align-items: center; gap: 4px; transition: 0.2s; background: #334155; color: white; border: 1px solid #475569; }
        .btn-action:active { transform: scale(0.95); }
        .btn-venta { background: rgba(16, 185, 129, 0.15); color: var(--success); border-color: rgba(16, 185, 129, 0.3); }
        .btn-noventa { background: rgba(239, 68, 68, 0.15); color: var(--danger); border-color: rgba(239, 68, 68, 0.3); }
        .btn-navegar { background: rgba(245, 158, 11, 0.15); color: var(--warning); border-color: rgba(245, 158, 11, 0.3); }

        /* AGENDA CHIPS */
        .chip-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 15px; }
        .chip { background: #334155; border: 1px solid #475569; color: #fff; padding: 15px 10px; border-radius: 12px; cursor: pointer; text-align: center; display:flex; flex-direction:column; align-items:center; justify-content:center; transition:0.2s; }
        .chip.selected { background: var(--accent); color: #000; border-color: var(--accent); font-weight: 700; box-shadow: 0 4px 15px rgba(76,201,240,0.3); }
        
        /* FOOTER */
        .app-footer { position: fixed; bottom: 0; left: 0; width: 100%; background: #1e293b; border-top: 1px solid #334155; display: none; justify-content: space-around; padding: 12px 0; z-index: 100; padding-bottom: max(12px, env(safe-area-inset-bottom)); }
        body.logged-in .app-footer { display: flex !important; }
        .nav-btn { background: none; border: none; color: var(--text-secondary); display: flex; flex-direction: column; align-items: center; gap: 5px; font-size: 10px; cursor: pointer; width: 25%; }
        .nav-btn.active { color: var(--accent); }
        .nav-btn i { font-size: 20px; }

        /* LOGIN */
        .login-container { display: flex; align-items: center; justify-content: center; height: 100%; padding: 20px; background: radial-gradient(circle at top right, #1e293b 0%, #0f172a 100%); position: absolute; top:0; left:0; width:100%; z-index:200; }
        .login-card { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); padding: 30px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); width: 100%; max-width: 350px; text-align: center; }
        .input-group input { width: 100%; padding: 15px; background: #334155; border: 2px solid #475569; border-radius: 12px; color: white; font-size: 24px; text-align: center; letter-spacing: 5px; outline: none; margin: 20px 0; font-weight:700; }
        .btn-primary { width: 100%; padding: 15px; background: var(--accent); color: #000; border: none; border-radius: 12px; font-weight: 700; font-size: 16px; cursor: pointer; text-transform: uppercase; }

        /* MODALES */
        .hidden { display: none !important; }
        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index: 300; display:flex; align-items:center; justify-content:center; backdrop-filter: blur(5px); }
        .modal-card { background: var(--bg-card); width: 90%; max-width: 340px; padding: 25px; border-radius: 20px; text-align: center; border: 1px solid rgba(255,255,255,0.1); }
        
        /* NUEVO: ESTILOS MODAL DIVERTIDO */
        .fun-modal { border: 2px solid var(--accent); box-shadow: 0 0 30px rgba(76,201,240,0.2); }
        .modal-emoji { font-size: 50px; margin-bottom: 15px; display: block; animation: bounce 1s infinite; }
        .client-highlight { 
            background: #0f172a; padding: 15px; border-radius: 12px; border-left: 4px solid var(--accent);
            margin: 15px 0; text-align: left;
        }
        .client-highlight span { display: block; font-size: 18px; font-weight: 700; color: #fff; margin-bottom: 4px; }
        .client-highlight small { color: #94a3b8; font-size: 13px; }
        
        .btn-super-confirm { 
            width: 100%; padding: 15px; background: var(--accent); color: #000; 
            border: none; border-radius: 50px; font-weight: 800; font-size: 16px; 
            margin-bottom: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .btn-ghost {
            width: 100%; padding: 12px; background: transparent; color: #94a3b8;
            border: 2px solid #334155; border-radius: 50px; font-weight: 600; cursor: pointer;
        }

        .full-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-body); z-index: 200; display: flex; flex-direction: column; }
        #map { flex: 1; width: 100%; }

    </style>
</head>

<body data-view-mode="list" data-theme="blue">

    <div id="loading-toast" class="hidden" style="position:fixed; bottom:100px; left:50%; transform:translateX(-50%); background:#1e293b; padding:15px 30px; border-radius:50px; z-index:500; border:1px solid var(--accent); display:flex; gap:10px; align-items:center; box-shadow:0 10px 40px rgba(0,0,0,0.5);">
        <div style="width:20px; height:20px; border:3px solid var(--accent); border-top-color:transparent; border-radius:50%; animation:spin 1s infinite linear;"></div>
        <span id="loader-msg" style="color:#fff; font-size:14px; font-weight:600;">Cargando...</span>
    </div>

    <div id="toast-container" style="position:fixed; bottom:80px; width:100%; text-align:center; pointer-events:none; z-index:1000;"></div>

    <section id="view-login" class="view active">
        <div class="login-container">
            <div class="login-card">
                <i class="fas fa-brain" style="font-size: 40px; color: var(--purple); margin-bottom:20px;"></i>
                <h2>Vendedores Pro</h2>
                <p style="color:var(--text-secondary); margin-bottom:20px;">Powered by Metis AI</p>
                <div class="input-group">
                    <input type="password" id="claveInput" placeholder="‚óè‚óè‚óè‚óè" maxlength="4" inputmode="numeric">
                </div>
                <button id="btnIngresar" class="btn-primary">INGRESAR</button>
                <p style="margin-top:20px; font-size:12px; color:#475569;">v7.0 Autonomous</p>
            </div>
        </div>
    </section>

    <section id="view-app" class="view">
        <header class="app-header">
            <div class="header-top">
                <div>
                    <span style="font-size:11px; color:var(--accent); font-weight:700;">VENDEDOR</span>
                    <h2 id="vendedorNombre" style="margin:0; font-size:18px;">...</h2>
                </div>
                <div style="display:flex; align-items:center; gap:10px;">
                    <div style="text-align:right; font-size:11px; color:var(--text-secondary);">
                        <div id="ventas-texto">0 Ventas</div>
                        <div id="pendientes-texto">0 Pend.</div>
                    </div>
                    <div class="progress-ring">
                        <svg><circle r="20" cx="22.5" cy="22.5"></circle><circle class="progreso-value" r="20" cx="22.5" cy="22.5"></circle></svg>
                        <span id="progreso-texto">0/0</span>
                    </div>
                </div>
            </div>
            
            <div id="route-alert-box" class="hidden"></div>

            <div class="info-bar">
                <span id="mensajeCoach"><i class="fas fa-satellite-dish"></i> GPS: Iniciando...</span>
                <span id="sync-indicator" class="sync-status hidden"><i class="fas fa-sync"></i> Sincronizando</span>
            </div>

            <div class="search-container">
                <i class="fas fa-search search-icon"></i>
                <input type="tel" id="inputBuscadorCliente" class="smart-input" placeholder="Buscar Cliente (ID o Nombre)...">
                <div id="liveResultBox" class="hidden"></div>
            </div>

            <div style="display:flex; justify-content:space-between; align-items:center; margin-top:15px;">
                <div class="view-mode-switcher" style="background:#334155; padding:4px; border-radius:20px; display:inline-flex;">
                    <button id="btnViewList" class="active" style="background:var(--accent); color:#000; border:none; padding:6px 14px; border-radius:16px; font-size:12px; font-weight:700; cursor:pointer;">Lista</button>
                    <button id="btnViewFocus" style="background:transparent; color:#94a3b8; border:none; padding:6px 14px; border-radius:16px; font-size:12px; cursor:pointer;">Foco</button>
                </div>
                <button class="theme-btn" style="width:28px; height:28px; border-radius:50%; background:#7C5DFF; border:2px solid #fff; cursor:pointer;"></button>
            </div>
        </header>

        <main id="listaClientes" class="cliente-list"></main>
    </section>
    
    <section id="view-agenda" class="view">
        <div style="padding:25px 20px;">
            <h3>üìÖ Agenda Semanal</h3>
            <div style="background:var(--bg-card); padding:20px; border-radius:16px; border:1px solid #334155;">
                <div style="text-align:center; margin-bottom:20px;">
                    <span style="font-size:12px; color:#94a3b8; text-transform:uppercase;">D√≠a Activo (Metis Tracking)</span>
                    <div id="current-zone-display" style="font-size:28px; font-weight:800; color:var(--accent);">...</div>
                    <div id="current-zone-detail" style="font-size:14px; color:#fff; margin-top:5px;">...</div>
                </div>
                <p style="font-size:13px; color:#94a3b8; margin-bottom:10px; text-transform:uppercase; letter-spacing:1px; font-weight:600;">Programar Ruta Alternativa:</p>
                <div class="chip-grid" id="zone-selector"></div>
            </div>
        </div>
    </section>

    <section id="view-settings" class="view">
        <div style="padding:25px;">
            <h3>‚öôÔ∏è Ajustes</h3>
            <div style="background:var(--bg-card); border-radius:16px; overflow:hidden; border:1px solid #334155;">
                <button class="btn-primary" id="btnSync" style="width:100%; text-align:left; background:transparent; color:#fff; padding:20px; border-bottom:1px solid #334155;">
                    <i class="fas fa-sync" style="color:var(--accent); margin-right:10px;"></i> Forzar Sincronizaci√≥n
                </button>
                <button class="btn-primary" id="btnTestIA" style="width:100%; text-align:left; background:transparent; color:var(--purple); padding:20px; border-bottom:1px solid #334155;">
                    <i class="fas fa-robot" style="margin-right:10px;"></i> Test IA Coach (Demo)
                </button>
                <button class="btn-primary" id="btnLogout" style="width:100%; text-align:left; background:transparent; color:var(--danger); padding:20px;">
                    <i class="fas fa-sign-out-alt" style="margin-right:10px;"></i> Cerrar Sesi√≥n
                </button>
            </div>
        </div>
    </section>

    <nav class="app-footer">
        <button class="nav-btn active" data-target="view-app"><i class="fas fa-map-signs"></i><span>Ruta</span></button>
        <button class="nav-btn" data-target="view-agenda"><i class="fas fa-calendar-day"></i><span>Agenda</span></button>
        <button class="nav-btn" id="btnFooterMapa"><i class="fas fa-map-marked-alt"></i><span>Mapa</span></button>
        <button class="nav-btn" data-target="view-settings"><i class="fas fa-cog"></i><span>Ajustes</span></button>
    </nav>

    <div id="modal-mapa" class="full-modal hidden">
        <div style="padding:15px; background:#1e293b; display:flex; justify-content:space-between; align-items:center;">
            <h3 style="margin:0;">Mapa</h3>
            <button id="btnCerrarMapa" style="background:none; border:none; color:#fff; font-size:24px;">‚úï</button>
        </div>
        <div id="map"></div>
    </div>

    <div id="sheet-motivo" class="modal-overlay hidden">
         <div class="modal-card">
            <h3>¬øPor qu√© NO compr√≥?</h3>
            <div class="chip-grid" id="motivoOptions">
                <button class="chip" data-val="Precio">üí∏ Precio</button>
                <button class="chip" data-val="Stock">üì¶ Stock</button>
                <button class="chip" data-val="Cerrado">üîí Cerrado</button>
                <button class="chip" data-val="Dinero">üö´ $ Dinero</button>
                <button class="chip" data-val="Otro">üìù Otro...</button>
            </div>
            <textarea id="motivoOtro" class="hidden" placeholder="Especifique..." style="width:100%; margin-top:15px; background:#334155; border:1px solid #475569; color:white; padding:15px; border-radius:12px; resize:none;"></textarea>
            <div style="display:flex; gap:10px; margin-top:20px;">
                 <button id="btnCancelarMotivo" class="btn-cancel" style="flex:1; background:transparent; border:1px solid #475569; color:#fff; padding:12px; border-radius:10px;">Cancelar</button>
                 <button id="btnConfirmarMotivo" class="btn-confirm" style="flex:1; background:var(--accent); border:none; color:#000; padding:12px; border-radius:10px; font-weight:700;">Guardar</button>
            </div>
         </div>
    </div>

    <div id="modal-confirm-zona" class="modal-overlay hidden">
        <div class="modal-card">
            <div style="font-size:40px; margin-bottom:10px; color:var(--warning);">‚ö†Ô∏è</div>
            <h3 style="font-size:20px;">¬øProgramar Ruta?</h3>
            <p id="zone-confirm-msg" style="color:#94a3b8; margin:15px 0;">Esto avisar√° a la IA de tu cambio de estrategia.</p>
            <div style="display:flex; gap:10px;">
                <button id="btnCancelZona" class="btn-cancel" style="flex:1; background:transparent; border:1px solid #475569; color:#fff; padding:12px; border-radius:10px;">Cancelar</button>
                <button id="btnOkZona" class="btn-confirm" style="flex:1; background:var(--accent); border:none; color:#000; padding:12px; border-radius:10px; font-weight:700;">S√≠, Cambiar</button>
            </div>
        </div>
    </div>

    <div id="modal-cliente" class="modal-overlay hidden">
        <div class="modal-card">
            <h3 id="modal-cliente-nombre">Cliente</h3>
            <p id="modal-cliente-direccion" style="color:#94a3b8; margin-bottom:15px;">...</p>
            <div style="background:#0f172a; padding:15px; border-radius:12px; text-align:left; margin-bottom:15px;">
                <small style="color:var(--accent); font-weight:700;">√öLTIMO PEDIDO</small>
                <p id="modal-ultimo-pedido" style="margin-top:5px; font-size:13px;">Cargando...</p>
            </div>
            <button id="btnCerrarModalCliente" style="width:100%; background:#334155; border:1px solid #475569; color:white; padding:12px; border-radius:10px;">Cerrar</button>
        </div>
    </div>

    <div id="modal-confirm-order" class="modal-overlay hidden">
        <div class="modal-card fun-modal">
            <span class="modal-emoji">üöÄ</span>
            <h3>¬øConfirmar Pedido?</h3>
            
            <p style="color:#94a3b8; margin:10px 0;">Est√°s enviando pedido para:</p>
            
            <div class="client-highlight">
                <span id="confirm-client-name">Juan Perez</span>
                <small id="confirm-client-loc">San Bernardo</small>
            </div>

            <p style="font-size:12px; color:#64748b; margin-bottom:20px;">Revisa bien para evitar errores en el reparto.</p>

            <button id="btnConfirmarEnvio" class="btn-super-confirm">
                ‚úÖ S√ç, ENVIAR
            </button>
            
            <button id="btnCorregirCliente" class="btn-ghost">
                ‚úèÔ∏è No, corregir
            </button>
        </div>
    </div>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // ==========================================
        // CONFIGURACI√ìN (CLOUDFLARE WORKER)
        // ==========================================
        const API_URL = "https://frosty-term-20ea.santamariapablodaniel.workers.dev";

        // ESTADO GLOBAL
        let estado = {
            vendedor: "", nombre: "", ruta: [], ubicacionActual: null, 
            viewMode: "list", diaRutaActual: "LUN", planSemanal: {}, localidadesHoy: ""
        };
        
        let map, markers, gpsWatcher;
        let tempDia = "";
        let clienteIndexAccion = -1; 
        let pendingSyncs = 0;
        
        // NUEVA VARIABLE PARA BASE DE CLIENTES
        let baseClientesCache = [];

        document.addEventListener("DOMContentLoaded", () => {
            checkSesion();
            
            // Listeners
            document.getElementById("btnIngresar").onclick = login;
            document.querySelectorAll('.nav-btn').forEach(b => b.onclick = (e) => showView(e.currentTarget.dataset.target));
            document.getElementById("btnFooterMapa").onclick = toggleMapa;
            document.getElementById("btnCerrarMapa").onclick = toggleMapa;
            document.getElementById("btnViewList").onclick = () => setViewMode("list");
            document.getElementById("btnViewFocus").onclick = () => setViewMode("focus");
            document.querySelector(".theme-btn").onclick = () => {
                const b = document.body;
                b.setAttribute("data-theme", b.getAttribute("data-theme") === "blue" ? "violet" : "blue");
            };
            
            document.getElementById("listaClientes").onclick = manejarClicksLista;
            document.getElementById("btnCancelZona").onclick = () => document.getElementById("modal-confirm-zona").classList.add("hidden");
            document.getElementById("btnOkZona").onclick = confirmarCambioDiaAPI;

            document.getElementById("btnCancelarMotivo").onclick = () => document.getElementById("sheet-motivo").classList.add("hidden");
            document.getElementById("btnConfirmarMotivo").onclick = guardarMotivo;
            document.getElementById("motivoOptions").onclick = (e) => {
                if(e.target.classList.contains("chip")) {
                    document.querySelectorAll("#motivoOptions .chip").forEach(c => c.classList.remove("selected"));
                    e.target.classList.add("selected");
                    document.getElementById("motivoOtro").classList.toggle("hidden", e.target.dataset.val !== "Otro");
                }
            };
            document.getElementById("btnCerrarModalCliente").onclick = () => document.getElementById("modal-cliente").classList.add("hidden");
            document.getElementById("btnLogout").onclick = () => { localStorage.clear(); location.reload(); };
            document.getElementById("btnSync").onclick = () => recargarDatos();
            document.getElementById("btnTestIA").onclick = async () => {
               toast("üß† Ejecutando Metis IA...");
               await apiCall({accion: "testIA"});
               toast("‚úÖ An√°lisis completado");
            };

            // NUEVOS LISTENERS (BUSCADOR Y MODAL CONFIRMACI√ìN)
            document.getElementById("inputBuscadorCliente").addEventListener("input", buscarClienteEnVivo);
            document.getElementById("btnConfirmarEnvio").onclick = procesarEnvioFinal;
            document.getElementById("btnCorregirCliente").onclick = cerrarModalConfirmacion;
        });

        // --- API HANDLER ---
        async function apiCall(data) {
            updateSyncStatus(true);
            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                return await res.json();
            } catch (e) {
                console.error("API Error", e);
                toast("‚ö†Ô∏è Error de conexi√≥n (Datos en cola)");
                throw e;
            } finally {
                updateSyncStatus(false);
            }
        }

        function updateSyncStatus(isSyncing) {
            if(isSyncing) pendingSyncs++; else pendingSyncs = Math.max(0, pendingSyncs - 1);
            const ind = document.getElementById("sync-indicator");
            if(pendingSyncs > 0) {
                ind.classList.remove("hidden");
                ind.classList.add("syncing");
            } else {
                ind.classList.remove("syncing");
                setTimeout(() => { if(pendingSyncs === 0) ind.classList.add("hidden"); }, 1000);
            }
        }

        async function login() {
            const clave = document.getElementById("claveInput").value.trim();
            if(clave.length < 4) return alert("Clave corta");
            
            toggleLoader(true, "Conectando al N√∫cleo...");
            
            try {
                // 1. GPS Primero
                await obtenerUbicacion();
                
                // 2. Login API
                const data = await apiCall({ 
                    accion: "getRutaDelDia", 
                    clave: clave, 
                    lat: estado.ubicacionActual?.lat, 
                    lng: estado.ubicacionActual?.lng 
                });
                
                if(!data.ok) throw new Error(data.error || "Error desconocido");
                
                estado.vendedor = clave;
                estado.nombre = data.vendedor;
                estado.ruta = (data.cartera || []).map(c => ({...c, visitado:c.visitado, expanded:false})); 
                estado.diaRutaActual = data.diaAsignado || "LUN";
                estado.planSemanal = data.planSemanal || {};
                estado.localidadesHoy = data.localidadesHoy || "";
                
                localStorage.setItem("sesion_pro", JSON.stringify(estado));
                
                // 3. Registrar Token
                apiCall({accion: "registrarToken", vendedor: clave, token: "web_user_" + Date.now()});

                iniciarApp();

            } catch(e) {
                alert("Error: " + e.message);
            } finally {
                toggleLoader(false);
            }
        }

        function checkSesion() {
            const s = JSON.parse(localStorage.getItem("sesion_pro"));
            if(s && s.vendedor) {
                estado = s;
                iniciarApp();
                iniciarGPS();
            }
        }

        function iniciarApp() {
            document.getElementById("view-login").classList.remove("active");
            document.getElementById("view-app").classList.add("active");
            document.body.classList.add("logged-in");
            document.getElementById("vendedorNombre").innerText = estado.nombre;
            
            checkRouteDayAlert(); 
            renderRuta();
            initAgenda();
            
            // NUEVO: CARGAR BASE COMPLETA EN SEGUNDO PLANO
            cargarBaseClientesGlobal();
        }
        
        // NUEVA FUNCI√ìN: CARGAR BASE DE CLIENTES
        async function cargarBaseClientesGlobal() {
            try {
                // Solo si la API soporta esta acci√≥n (verificar backend)
                // Usamos GET con par√°metros en URL para Cloudflare/GAS a veces es m√°s facil
                // Aqu√≠ simulamos llamada POST
                const res = await fetch(`${API_URL}?accion=getListaClientes`);
                const data = await res.json();
                if(data.ok) {
                    baseClientesCache = data.clientes;
                    console.log("Base Clientes Cargada:", baseClientesCache.length);
                }
            } catch(e) {
                console.warn("No se pudo cargar base global clientes", e);
            }
        }

        // NUEVA FUNCI√ìN: BUSCADOR EN VIVO
        function buscarClienteEnVivo(e) {
            const val = e.target.value.toLowerCase().trim();
            const box = document.getElementById("liveResultBox");
            
            if(val.length === 0) {
                box.classList.add("hidden");
                box.innerHTML = "";
                // Restaurar lista completa
                renderRuta(); 
                return;
            }

            // 1. Filtrar la ruta actual primero (prioridad)
            const rutaFiltrada = estado.ruta.filter(c => 
                c.nombre.toLowerCase().includes(val) || 
                c.numeroCliente.toString().includes(val)
            );
            
            // Renderizar la lista filtrada abajo
            renderRuta(rutaFiltrada);

            // 2. Buscar en base global (para mostrar feedback visual r√°pido en el input)
            // Si tenemos base global cargada
            if(baseClientesCache.length > 0) {
                const encontrado = baseClientesCache.find(c => c.id === val || c.nombre.toLowerCase().includes(val));
                
                box.classList.remove("hidden");
                if(encontrado) {
                    box.className = "live-result success";
                    box.innerHTML = `<i class="fas fa-check-circle"></i> <div><strong>${encontrado.nombre}</strong><br><small>${encontrado.loc}</small></div>`;
                } else {
                    box.className = "live-result error";
                    box.innerHTML = `<i class="fas fa-times-circle"></i> Cliente no encontrado en Base Global`;
                }
            }
        }

        function checkRouteDayAlert() {
            const dias = ["DOM", "LUN", "MAR", "MI√â", "JUE", "VIE", "SAB"];
            const hoyIndex = new Date().getDay();
            let hoyNatural = dias[hoyIndex];
            if(hoyNatural === "DOM" || hoyNatural === "SAB") hoyNatural = "LUN"; 
            
            const rutaActual = estado.diaRutaActual.replace("MIE","MI√â");
            const box = document.getElementById("route-alert-box");

            if(rutaActual !== hoyNatural) {
                box.innerHTML = `<div class="route-alert"><i class="fas fa-exclamation-triangle"></i> <span>Est√°s operando en Ruta Programada: <b>${rutaActual}</b> (Hoy es ${hoyNatural})</span></div>`;
                box.classList.remove("hidden");
            } else {
                box.innerHTML = `<div class="route-alert normal"><i class="fas fa-check-circle"></i> <span>Ruta del D√≠a Asignada Correctamente (${rutaActual})</span></div>`;
                box.classList.remove("hidden");
                setTimeout(() => box.classList.add("hidden"), 5000);
            }
        }

        // --- RENDERIZADO INTELIGENTE (Modificado para aceptar filtro) ---
        function renderRuta(listaOpcional = null) {
            const list = document.getElementById("listaClientes");
            list.innerHTML = "";
            
            // Si pasamos listaOpcional es porque estamos buscando/filtrando
            let pendientes = listaOpcional ? listaOpcional : estado.ruta.filter(c => !c.visitado);
            
            if(estado.ubicacionActual && estado.viewMode === 'list' && !listaOpcional) {
                pendientes.sort((a,b) => getDistVal(a) - getDistVal(b));
            }

            if(pendientes.length === 0) {
                if(listaOpcional) {
                    list.innerHTML = `<div style="text-align:center; padding:20px; color:#94a3b8;">No hay coincidencias en esta ruta.</div>`;
                } else {
                    list.innerHTML = `<div style="text-align:center; padding:40px; color:#fff;">üéâ<br>RUTA DEL ${estado.diaRutaActual}<br>COMPLETADA</div>`;
                }
                updateStats();
                return;
            }

            const loop = (estado.viewMode === 'focus' && !listaOpcional) ? [pendientes[0]] : pendientes;

            loop.forEach(c => {
                const idxReal = estado.ruta.indexOf(c); // Importante para mantener referencia
                const isExpanded = c.expanded || estado.viewMode === 'focus' || listaOpcional; // Expandir si busco
                
                let badgeGPS = "";
                let distText = c.distanciaTexto;
                
                if(!distText && estado.ubicacionActual && c.lat && c.lng) {
                      const dKm = haversine(estado.ubicacionActual.lat, estado.ubicacionActual.lng, c.lat, c.lng);
                      distText = dKm.toFixed(1) + " km";
                }

                if(distText) badgeGPS = `<div class="gps-badge active"><i class="fas fa-car"></i> ${distText}</div>`;
                else badgeGPS = `<div class="gps-badge"><i class="fas fa-satellite-dish"></i> ...</div>`;

                const card = document.createElement("div");
                card.className = `card ${isExpanded ? 'expanded' : ''}`;
                card.dataset.idx = idxReal; 

                card.innerHTML = `
                    ${badgeGPS}
                    <div class="card-header">
                        <h3><span class="client-id-span">#${c.numeroCliente}</span> ${c.nombre}</h3>
                        <span class="badge pendiente">PENDIENTE</span>
                    </div>
                    <div class="card-body">
                        <p>üìç ${c.domicilio}</p>
                    </div>
                    <div class="card-actions">
                        <button class="btn-action btn-venta" data-action="venta" data-idx="${idxReal}">
                            <i class="fas fa-check"></i> VENTA
                        </button>
                        <button class="btn-action btn-noventa" data-action="motivo" data-idx="${idxReal}">
                            <i class="fas fa-times"></i> MOTIVO
                        </button>
                        <button class="btn-action btn-detalle" data-action="detalle" data-idx="${idxReal}">
                            <i class="fas fa-info"></i> INFO
                        </button>
                        <button class="btn-action btn-navegar" data-action="ir" data-idx="${idxReal}">
                            <i class="fas fa-location-arrow"></i> IR
                        </button>
                    </div>
                `;
                list.appendChild(card);
            });
            updateStats();
        }

        function getDistVal(c) {
            if(c.distanciaValor) return c.distanciaValor;
            if(estado.ubicacionActual && c.lat && c.lng) return haversine(estado.ubicacionActual.lat, estado.ubicacionActual.lng, c.lat, c.lng);
            return 999999;
        }

        // --- AGENDA ---
        function initAgenda() {
            const grid = document.getElementById("zone-selector");
            grid.innerHTML = "";
            const dias = ["LUN", "MAR", "MI√â", "JUE", "VIE"];
            
            document.getElementById("current-zone-display").innerText = estado.diaRutaActual;
            document.getElementById("current-zone-detail").innerText = estado.localidadesHoy || "General";

            dias.forEach(d => {
                const zoneName = estado.planSemanal[d] || "";
                const btn = document.createElement("div");
                const isSelected = estado.diaRutaActual === d;
                btn.className = `chip ${isSelected ? 'selected' : ''}`;
                btn.innerHTML = `<span style="display:block; font-size:18px; font-weight:800;">${d}</span><span style="font-size:10px;">${zoneName.substring(0,10)}..</span>`;
                
                btn.onclick = () => {
                    if(estado.diaRutaActual === d) return toast("Ya est√°s en este d√≠a");
                    tempDia = d;
                    document.getElementById("zone-confirm-msg").innerHTML = `¬øProgramar ruta del <b>${d}</b>?<br>Metis analizar√° este cambio.`;
                    document.getElementById("modal-confirm-zona").classList.remove("hidden");
                };
                grid.appendChild(btn);
            });
        }

        async function confirmarCambioDiaAPI() {
            document.getElementById("modal-confirm-zona").classList.add("hidden");
            toggleLoader(true, "Reprogramando Ruta...");
            
            try {
                await apiCall({ accion: "cambiarDiaRuta", vendedor: estado.vendedor, nuevoDia: tempDia });
                await recargarDatos();
            } catch(e) {
                alert("Error al cambiar d√≠a: " + e.message);
                toggleLoader(false);
            }
        }

        async function recargarDatos() {
            toggleLoader(true, "Sincronizando...");
            try {
                const data = await apiCall({ 
                    accion: "getRutaDelDia", 
                    clave: estado.vendedor, 
                    lat: estado.ubicacionActual?.lat, 
                    lng: estado.ubicacionActual?.lng 
                });
                
                if(data.ok) {
                    estado.ruta = (data.cartera || []).map(c => ({...c, visitado:c.visitado, expanded:false}));
                    estado.diaRutaActual = data.diaAsignado;
                    estado.localidadesHoy = data.localidadesHoy;
                    estado.planSemanal = data.planSemanal;
                    localStorage.setItem("sesion_pro", JSON.stringify(estado));
                    renderRuta();
                    initAgenda();
                    checkRouteDayAlert();
                    toast("‚úÖ Sincronizado");
                }
            } catch(e) {
                console.error(e);
            } finally {
                toggleLoader(false);
            }
        }

        // --- GPS ---
        function obtenerUbicacion() {
            return new Promise(r => {
                if(!navigator.geolocation) return r(null);
                navigator.geolocation.getCurrentPosition(
                    p => {
                        estado.ubicacionActual = { lat: p.coords.latitude, lng: p.coords.longitude };
                        r(estado.ubicacionActual);
                    },
                    () => r(null),
                    { enableHighAccuracy: true, timeout: 5000 }
                );
            });
        }

        function iniciarGPS() {
            if(!navigator.geolocation) return;
            gpsWatcher = navigator.geolocation.watchPosition(
                p => {
                    estado.ubicacionActual = { lat: p.coords.latitude, lng: p.coords.longitude };
                    document.getElementById("mensajeCoach").innerHTML = `<i class="fas fa-satellite-dish" style="color:var(--success)"></i> GPS Activo`;
                },
                e => console.log(e),
                { enableHighAccuracy: true }
            );
        }

        // --- UTILS ---
        function manejarClicksLista(e) {
            const btn = e.target.closest('button');
            if(btn) {
                const action = btn.dataset.action;
                const idx = parseInt(btn.dataset.idx);
                // MODIFICADO: AHORA ABRE CONFIRMACI√ìN
                if(action === 'venta') abrirConfirmacionVenta(idx);
                if(action === 'motivo') abrirMotivo(idx);
                if(action === 'detalle') abrirDetalle(idx);
                if(action === 'ir') navegar(idx);
                return;
            }
            const card = e.target.closest('.card');
            if(card && estado.viewMode === 'list') {
                const idx = parseInt(card.dataset.idx);
                estado.ruta.forEach((c, i) => { if(i===idx) c.expanded = !c.expanded; else c.expanded = false; });
                // Volvemos a renderizar, pero si hay filtro activo (input con texto), lo respetamos
                const filtro = document.getElementById("inputBuscadorCliente").value.trim();
                if(filtro.length > 0) {
                     // Redisparamos el filtro
                     document.getElementById("inputBuscadorCliente").dispatchEvent(new Event('input'));
                } else {
                    renderRuta();
                }
            }
        }
        
        function navegar(idx) {
            const c = estado.ruta[idx];
            if(!c.lat || !c.lng) return toast("Sin coordenadas");
            window.open(`http://googleusercontent.com/maps.google.com/?daddr=${c.lat},${c.lng}`, '_system');
        }

        // --- L√ìGICA DE MODAL DE CONFIRMACI√ìN (NUEVO) ---
        function abrirConfirmacionVenta(idx) {
            clienteIndexAccion = idx; // Guardamos √≠ndice
            const c = estado.ruta[idx];
            
            // Llenamos datos en el modal
            document.getElementById("confirm-client-name").innerText = `${c.nombre} (#${c.numeroCliente})`;
            document.getElementById("confirm-client-loc").innerText = c.domicilio;
            
            // Mostramos
            const modal = document.getElementById("modal-confirm-order");
            modal.classList.remove("hidden");
        }

        function cerrarModalConfirmacion() {
            document.getElementById("modal-confirm-order").classList.add("hidden");
        }

        function procesarEnvioFinal() {
            cerrarModalConfirmacion();
            // Ejecutamos la venta real
            registrarVisitaOptimista(clienteIndexAccion, true);
            // Limpiar buscador si estaba en uso
            document.getElementById("inputBuscadorCliente").value = "";
            document.getElementById("liveResultBox").classList.add("hidden");
        }

        // --- OPTIMISTIC UI UPDATE ---
        function registrarVisitaOptimista(idx, venta, motivo="") {
            const c = estado.ruta[idx];
            // 1. Actualizar UI Inmediatamente
            c.visitado = true;
            c.compro = venta;
            c.motivo = motivo;
            
            renderRuta(); // Se borra de pendientes instant√°neamente
            toast(venta ? "üí∞ Venta Registrada" : "üìù Motivo Guardado");

            // 2. Enviar a Backend en Segundo Plano
            apiCall({ 
                accion: "registrarVisita", 
                vendedor: estado.vendedor, 
                cliente: c.numeroCliente, 
                compro: venta, 
                motivo: motivo, 
                lat: estado.ubicacionActual?.lat, 
                lng: estado.ubicacionActual?.lng 
            }).catch(e => {
                toast("‚ö†Ô∏è Error guardando en nube (Se reintentar√°)");
            });
        }

        function abrirMotivo(idx) {
            clienteIndexAccion = idx;
            document.getElementById("sheet-motivo").classList.remove("hidden");
            document.querySelectorAll("#motivoOptions .chip").forEach(c => c.classList.remove("selected"));
            document.getElementById("motivoOtro").classList.add("hidden");
        }

        function guardarMotivo() {
            const sel = document.querySelector("#motivoOptions .chip.selected");
            if(!sel) return toast("Selecciona motivo");
            let m = sel.dataset.val;
            if(m==="Otro") m = document.getElementById("motivoOtro").value;
            registrarVisitaOptimista(clienteIndexAccion, false, m);
            document.getElementById("sheet-motivo").classList.add("hidden");
        }

        async function abrirDetalle(idx) {
            const c = estado.ruta[idx];
            document.getElementById("modal-cliente-nombre").innerText = c.nombre;
            document.getElementById("modal-cliente-direccion").innerText = c.domicilio;
            document.getElementById("modal-ultimo-pedido").innerText = "Buscando...";
            document.getElementById("modal-cliente").classList.remove("hidden");
            
            try {
                const res = await apiCall({accion: "getUltimoPedido", cliente: c.numeroCliente});
                if(res.ok && res.ultimoPedido) {
                    document.getElementById("modal-ultimo-pedido").innerHTML = `<b>${res.ultimoPedido.fecha}</b><br>${res.ultimoPedido.texto}`;
                } else {
                    document.getElementById("modal-ultimo-pedido").innerText = "Sin datos recientes";
                }
            } catch(e) { document.getElementById("modal-ultimo-pedido").innerText = "-"; }
        }

        function haversine(lat1, lon1, lat2, lon2) {
            const R = 6371; const dLat = (lat2 - lat1) * Math.PI / 180; const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function toggleLoader(show, msg="Cargando...") {
            const l = document.getElementById("loading-toast");
            document.getElementById("loader-msg").innerText = msg;
            if(show) l.classList.remove("hidden"); else l.classList.add("hidden");
        }
        function updateStats() {
            const total = estado.ruta.length;
            const visitados = estado.ruta.filter(c => c.visitado).length;
            document.getElementById("progreso-texto").innerText = `${visitados}/${total}`;
            const c = document.querySelector('.progreso-value');
            const r = c.r.baseVal.value; const circ = 2 * Math.PI * r;
            c.style.strokeDashoffset = circ - ((visitados/total) * circ);
            document.getElementById("ventas-texto").innerText = `${estado.ruta.filter(c=>c.compro).length} Ventas`;
            document.getElementById("pendientes-texto").innerText = `${total - visitados} Pend.`;
        }
        function setViewMode(m) { 
            estado.viewMode = m; 
            renderRuta(); 
            document.getElementById("btnViewList").style.background = m === 'list' ? 'var(--accent)' : 'transparent';
            document.getElementById("btnViewList").style.color = m === 'list' ? '#000' : '#94a3b8';
            document.getElementById("btnViewFocus").style.background = m === 'focus' ? 'var(--accent)' : 'transparent';
            document.getElementById("btnViewFocus").style.color = m === 'focus' ? '#000' : '#94a3b8';
        }
        function toggleMapa() {
            const m = document.getElementById("modal-mapa");
            m.classList.toggle("hidden");
            if(!m.classList.contains("hidden") && !map) {
                map = L.map('map').setView([-34.6, -58.4], 12);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png').addTo(map);
            }
            if(!m.classList.contains("hidden")) setTimeout(()=>map.invalidateSize(), 300);
        }
        function showView(id) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(id === 'view-agenda') initAgenda();
        }
        function toast(msg) {
            const t = document.createElement("div");
            t.style.cssText = "background:rgba(0,0,0,0.8); color:#fff; padding:10px 20px; border-radius:20px; display:inline-block; margin-top:10px; font-size:14px;";
            t.innerText = msg;
            document.getElementById("toast-container").appendChild(t);
            setTimeout(() => t.remove(), 3000);
        }
    </script>
</body>
</html>
