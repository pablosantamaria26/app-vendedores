<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>üß† App de Vendedores Inteligente</title>

  <!-- Leaflet (para mapa sin API key) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Chart.js (para los gr√°ficos del resumen) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* ===========================
       ESTILOS GENERALES
    ============================ */
    body {
      margin: 0;
      font-family: "Inter", sans-serif;
      background: #f4f6f8;
      color: #222;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100dvh;
      overflow-x: hidden;
    }

    header {
      width: 100%;
      background: #007aff;
      color: white;
      padding: 14px;
      text-align: center;
      position: sticky;
      top: 0;
      z-index: 999;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    }

    header h1 {
      margin: 0;
      font-size: 1.3rem;
    }

    .menu {
      display: flex;
      justify-content: space-around;
      background: #fff;
      width: 100%;
      border-top: 1px solid #ccc;
      position: fixed;
      bottom: 0;
      left: 0;
      z-index: 1000;
    }

    .menu button {
      flex: 1;
      padding: 10px;
      border: none;
      background: #fff;
      font-size: 1rem;
      cursor: pointer;
      transition: 0.3s;
    }

    .menu button.activo {
      background: #007aff;
      color: white;
      font-weight: bold;
    }

    main {
      width: 100%;
      max-width: 700px;
      padding: 10px;
      margin-bottom: 80px;
    }

    h2 {
      text-align: center;
      margin-top: 10px;
      color: #007aff;
    }

    /* ===========================
       LOGIN
    ============================ */
    #login {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100dvh;
      background: linear-gradient(135deg, #007aff, #00b4d8);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: white;
      z-index: 10000;
    }

    .login-card {
      background: white;
      color: #222;
      border-radius: 15px;
      padding: 20px;
      width: 85%;
      max-width: 350px;
      text-align: center;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .login-card input {
      font-size: 1.4rem;
      padding: 10px;
      text-align: center;
      margin: 10px 0;
      border: 2px solid #007aff;
      border-radius: 10px;
      width: 80%;
    }

    .teclado-numerico button {
      width: 30%;
      margin: 5px;
      padding: 10px;
      font-size: 1.2rem;
      border: none;
      border-radius: 10px;
      background: #007aff;
      color: white;
      cursor: pointer;
      transition: 0.2s;
    }

    .teclado-numerico button:hover {
      background: #005fcc;
    }

    /* ===========================
       TARJETAS
    ============================ */
    .cliente {
      background: white;
      border-radius: 12px;
      padding: 14px;
      margin: 10px 0;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      animation: fadeIn 0.3s ease-in-out;
    }

    .cliente h3 {
      margin: 0;
      color: #007aff;
    }

    .cliente button {
      margin-top: 8px;
      margin-right: 4px;
      background: #007aff;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 8px 12px;
      cursor: pointer;
      transition: 0.2s;
    }

    .cliente button:hover {
      background: #005fcc;
    }

    .btn-secundario {
      background: #00b894;
    }

    #mapa {
      height: 300px;
      width: 100%;
      margin-top: 10px;
      border-radius: 10px;
      overflow: hidden;
    }

    /* ===========================
       RESUMEN
    ============================ */
    .panel-resumen {
      text-align: center;
      background: white;
      padding: 15px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }

    canvas {
      max-width: 300px;
      margin: auto;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>

<body>
  <!-- ==========================
       LOGIN
  =========================== -->
  <div id="login">
    <div class="login-card">
      <h1>üß† App de Vendedores</h1>
      <h2>üîê Ingres√° tu c√≥digo</h2>
      <input type="password" id="clave" maxlength="4" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
      <div class="teclado-numerico">
        <button onclick="agregarDigito('1')">1</button>
        <button onclick="agregarDigito('2')">2</button>
        <button onclick="agregarDigito('3')">3</button>
        <button onclick="agregarDigito('4')">4</button>
        <button onclick="agregarDigito('5')">5</button>
        <button onclick="agregarDigito('6')">6</button>
        <button onclick="agregarDigito('7')">7</button>
        <button onclick="agregarDigito('8')">8</button>
        <button onclick="agregarDigito('9')">9</button>
        <button onclick="borrarDigito()">‚å´</button>
        <button onclick="agregarDigito('0')">0</button>
        <button onclick="login()">‚úîÔ∏è</button>
      </div>
      <p id="error" style="color:red;"></p>
    </div>
  </div>

  <!-- ==========================
       APP PRINCIPAL
  =========================== -->
  <header>
    <h1 id="titulo">üß† App de Vendedores</h1>
  </header>

  <main>
    <section id="seccion-ruta" class="seccion">
      <h2>üó∫Ô∏è Ruta del D√≠a</h2>
      <div id="contenedor"></div>
      <div id="mapa"></div>
    </section>

    <section id="seccion-calendario" class="seccion oculto">
      <h2>üìÖ Calendario</h2>
      <div id="contenedorCalendario"></div>
    </section>

    <section id="seccion-resumen" class="seccion oculto">
      <h2>üìà Resumen</h2>
      <div id="contenedorResumen" class="panel-resumen"></div>
      <canvas id="graficoResumen"></canvas>
    </section>
  </main>

  <div class="menu">
    <button id="btnRuta" class="activo" onclick="mostrarSeccion('ruta')">üó∫Ô∏è Ruta</button>
    <button id="btnCalendario" onclick="mostrarSeccion('calendario')">üìÖ</button>
    <button id="btnResumen" onclick="mostrarSeccion('resumen')">üìà</button>
    <button id="btnLogout" onclick="logout()">üö™</button>
  </div>

  <!-- ==========================
       SCRIPT PRINCIPAL
  =========================== -->
  <script>
    const vendedores = { "0001": "Mart√≠n", "0002": "Lucas", "0003": "Mercado Limpio" };
    const URL_API_BASE = "https://script.google.com/macros/s/AKfycbzqPMRir2VCB_C_EUsa0o8-eYCRDM4AQLsY3Jx_5jRKkYi-D2WgTEkTFrBIRFugT5MW/exec";

    function agregarDigito(n) {
      const input = document.getElementById("clave");
      if (input.value.length < 4) input.value += n;
    }
    function borrarDigito() {
      const input = document.getElementById("clave");
      input.value = input.value.slice(0, -1);
    }

    function login() {
      const clave = document.getElementById("clave").value.trim();
      const error = document.getElementById("error");
      if (!vendedores[clave]) { error.textContent = "‚ùå Clave incorrecta"; return; }
      localStorage.setItem("vendedorClave", clave);
      document.getElementById("login").style.display = "none";
      mostrarApp();
    }

    function logout() { localStorage.removeItem("vendedorClave"); location.reload(); }

    window.onload = () => {
      const clave = localStorage.getItem("vendedorClave");
      if (clave && vendedores[clave]) { document.getElementById("login").style.display = "none"; mostrarApp(); }
    };

    async function mostrarApp() {
      const clave = localStorage.getItem("vendedorClave");
      const nombre = vendedores[clave];
      document.getElementById("titulo").textContent = `üëã Hola, ${nombre}`;
      mostrarSeccion("ruta");
      cargarRuta(clave);
      cargarResumen(clave);
    }

  function mostrarSeccion(seccion) {
  // Oculta todas las secciones
  document.querySelectorAll(".seccion").forEach(s => s.classList.add("oculto"));

  // Muestra la que corresponde
  document.getElementById("seccion-" + seccion).classList.remove("oculto");

  // Actualiza los botones
  document.querySelectorAll(".menu button").forEach(b => b.classList.remove("activo"));
  const botonActivo = document.querySelector(`[onclick="mostrarSeccion('${seccion}')"]`);
  if (botonActivo) botonActivo.classList.add("activo");
}


    async function cargarRuta(clave) {
      const cont = document.getElementById("contenedor");
      cont.innerHTML = "‚è≥ Cargando clientes...";
      const resp = await fetch(`${URL_API_BASE}?accion=getRutaDelDiaPorVendedor&clave=${clave}`);
      const data = await resp.json();
      cont.innerHTML = "";
      let puntos = [];
      data.forEach(c => {
        const div = document.createElement("div");
        div.className = "cliente";
        div.innerHTML = `
          <h3>${c.nombre}</h3>
          <p>üìç ${c.direccion}, ${c.localidad}</p>
          <button class="btn-secundario" onclick='irCliente(${c.lat}, ${c.lng})'>üöó Ir a este cliente</button>
          <button onclick='registrarVisita(${JSON.stringify(c)})'>üíæ Registrar Visita</button>
        `;
        cont.appendChild(div);
        if (c.lat && c.lng) puntos.push([c.lat, c.lng, c.nombre]);
      });
      mostrarMapa(puntos);
    }

    function irCliente(lat, lng) {
      if (!lat || !lng) { alert("üìç Este cliente no tiene coordenadas cargadas."); return; }
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
          const url = `https://www.google.com/maps/dir/?api=1&origin=${pos.coords.latitude},${pos.coords.longitude}&destination=${lat},${lng}&travelmode=driving`;
          window.open(url, "_blank");
        });
      } else alert("‚ö†Ô∏è Geolocalizaci√≥n no disponible.");
    }

    function mostrarMapa(puntos) {
      const mapaDiv = document.getElementById("mapa");
      mapaDiv.innerHTML = "";
      const map = L.map("mapa").setView([-34.7, -58.4], 11);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
      puntos.forEach(p => L.marker([p[0], p[1]]).addTo(map).bindPopup(p[2]));
    }

    function registrarVisita(c) {
      const vendedor = localStorage.getItem("vendedorClave");
      const params = new URLSearchParams({
        accion: "registrarVisita",
        numero: c.numero,
        nombre: c.nombre,
        direccion: c.direccion,
        localidad: c.localidad,
        visitado: true,
        compro: false,
        comentario: "",
        vendedor,
      });
      fetch(`${URL_API_BASE}?${params}`).then(r => r.json()).then(d => alert(d.estado));
    }

    async function cargarResumen(clave) {
      const cont = document.getElementById("contenedorResumen");
      cont.innerHTML = "‚è≥ Analizando desempe√±o...";
      const resp = await fetch(`${URL_API_BASE}?accion=getResumenVendedor&clave=${clave}`);
      const pred = await fetch(`${URL_API_BASE}?accion=getPrediccionesVendedor&clave=${clave}`);
      const resumen = await resp.json();
      const analisis = await pred.json();

      cont.innerHTML = `
        <h3>${resumen.fecha}</h3>
        <p>üö∂ Visitas: <b>${resumen.totalHoy || 0}</b></p>
        <p>üõí Compraron: <b>${resumen.compraronHoy || 0}</b></p>
        <p>üéØ Tasa: <b>${resumen.tasa || 0}%</b></p>
        <p>‚è±Ô∏è Frecuencia: <b>${resumen.frecuenciaProm || "N/D"}</b> d√≠as</p>
        <p>ü§ñ ${analisis.mensaje}</p>
      `;

      const ctx = document.getElementById("graficoResumen").getContext("2d");
      new Chart(ctx, {
        type: "doughnut",
        data: {
          labels: ["Compraron", "No compraron"],
          datasets: [{
            data: [resumen.compraronHoy, resumen.totalHoy - resumen.compraronHoy],
            backgroundColor: ["#00c851", "#ff4444"],
          }]
        },
        options: { plugins: { legend: { display: false } } }
      });
    }
  </script>
</body>
</html>
