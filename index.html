<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>App de Vendedores Inteligente</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body>
<!-- ==========================
     LOGIN FULLSCREEN
=========================== -->
<div id="login" class="login pantalla-login">
  <div class="login-card">
    <h1>ğŸ§  App de Vendedores</h1>
    <h2>ğŸ” IngresÃ¡ tu cÃ³digo</h2>

    <input
      type="password"
      id="clave"
      maxlength="4"
      inputmode="numeric"
      pattern="[0-9]*"
      placeholder="â€¢â€¢â€¢â€¢"
      autocomplete="off"
      autofocus
    />

    <div class="teclado-numerico">
      <button onclick="agregarDigito('1')">1</button>
      <button onclick="agregarDigito('2')">2</button>
      <button onclick="agregarDigito('3')">3</button>
      <button onclick="agregarDigito('4')">4</button>
      <button onclick="agregarDigito('5')">5</button>
      <button onclick="agregarDigito('6')">6</button>
      <button onclick="agregarDigito('7')">7</button>
      <button onclick="agregarDigito('8')">8</button>
      <button onclick="agregarDigito('9')">9</button>
      <button onclick="borrarDigito()">âŒ«</button>
      <button onclick="agregarDigito('0')">0</button>
      <button onclick="login()">âœ”ï¸</button>
    </div>

    <p id="error" class="error"></p>
  </div>
</div>

<script>
  function agregarDigito(n) {
    const input = document.getElementById("clave");
    if (input.value.length < 4) input.value += n;
  }

  function borrarDigito() {
    const input = document.getElementById("clave");
    input.value = input.value.slice(0, -1);
  }
</script>


  <!-- ==========================
       APP PRINCIPAL
  =========================== -->
  <div id="app" class="oculto">
    <header>
      <h1 id="titulo"></h1>
      <div class="modo-toggle" id="modoToggle" onclick="alternarModo()">ğŸŒ™</div>

      <div class="menu">
        <button id="btnRuta" class="activo" onclick="mostrarSeccion('ruta')">ğŸ—ºï¸ Ruta del DÃ­a</button>
        <button id="btnCalendario" onclick="mostrarSeccion('calendario')">ğŸ“… Calendario</button>
        <button id="btnResumen" onclick="mostrarSeccion('resumen')">ğŸ“ˆ Resumen</button>
        <button id="btnLogout" onclick="logout()">ğŸšª Salir</button>
      </div>
      <p id="estado"></p>
    </header>

    <!-- ==========================
         CONTENIDO PRINCIPAL
    =========================== -->
    <main>
      <!-- ğŸ—ºï¸ Ruta del DÃ­a -->
      <section id="seccion-ruta" class="seccion oculto pantalla">
        <div id="contenedor"></div>
      </section>

      <!-- ğŸ“… Calendario -->
      <section id="seccion-calendario" class="seccion oculto pantalla">
        <h2>ğŸ“… Calendario de Visitas</h2>
        <div id="contenedorCalendario" class="tabla-calendario"></div>
      </section>

      <!-- ğŸ“ˆ Resumen Inteligente -->
      <section id="seccion-resumen" class="seccion visible pantalla">
        <h2>ğŸ“Š DesempeÃ±o y Predicciones</h2>
        <div id="contenedorResumen" class="panel-resumen">
          <p>â³ Cargando informaciÃ³n...</p>
        </div>
      </section>
    </main>
  </div>

  <!-- ==========================
       JS PRINCIPAL
  =========================== -->
  <script src="app.js"></script>

  <!-- ==========================
       CONTROL DE SECCIONES / MODO OSCURO / RESUMEN
  =========================== -->
  <script>
    /* ================================
       ğŸ”„ CONTROL DE SECCIONES
    ================================ */
    function mostrarSeccion(seccion) {
      const secciones = ["ruta", "calendario", "resumen"];

      secciones.forEach((s) => {
        document.getElementById("btn" + s.charAt(0).toUpperCase() + s.slice(1))?.classList.remove("activo");
        document.getElementById("seccion-" + s)?.classList.add("oculto");
      });

      const btn = document.getElementById("btn" + seccion.charAt(0).toUpperCase() + seccion.slice(1));
      const sec = document.getElementById("seccion-" + seccion);

      btn?.classList.add("activo");
      sec?.classList.remove("oculto");

      // Cargar contenido dinÃ¡mico segÃºn la secciÃ³n
      if (seccion === "calendario") cargarCalendario();
      if (seccion === "resumen") cargarResumenInteligente();

      // Scroll al inicio
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    /* ================================
       ğŸŒ™ / â˜€ï¸ MODO OSCURO
    ================================ */
    function alternarModo() {
      const body = document.body;
      const esOscuro = body.dataset.dark === "true";
      body.dataset.dark = esOscuro ? "false" : "true";
      localStorage.setItem("modoOscuro", body.dataset.dark);
      document.getElementById("modoToggle").textContent = esOscuro ? "ğŸŒ™" : "â˜€ï¸";
    }

    window.addEventListener("load", () => {
      const guardado = localStorage.getItem("modoOscuro");
      if (guardado) {
        document.body.dataset.dark = guardado;
        document.getElementById("modoToggle").textContent =
          guardado === "true" ? "â˜€ï¸" : "ğŸŒ™";
      }
    });

    /* ================================
       ğŸ§  CARGAR RESUMEN INTELIGENTE
    ================================ */
    async function cargarResumenInteligente() {
      const clave = localStorage.getItem("vendedorClave");
      const cont = document.getElementById("contenedorResumen");

      if (!clave) {
        cont.innerHTML = "<p>âš ï¸ Debes iniciar sesiÃ³n primero.</p>";
        return;
      }

      cont.innerHTML = "â³ Analizando tus datos...";

      try {
        const resumenURL = `${URL_API_BASE}?accion=getResumenVendedor&clave=${clave}`;
        const predURL = `${URL_API_BASE}?accion=getPrediccionesVendedor&clave=${clave}`;

        const [r1, r2] = await Promise.all([fetch(resumenURL), fetch(predURL)]);
        const resumen = await r1.json();
        const pred = await r2.json();

        cont.innerHTML = `
          <div class="tarjeta-resumen pantalla-tarjeta">
            <h3>ğŸ“… Fecha: ${resumen.fecha || "Sin datos"}</h3>
            <p>ğŸ§â€â™‚ï¸ Clientes visitados: <strong>${resumen.totalHoy || 0}</strong></p>
            <p>ğŸ›’ Compraron hoy: <strong>${resumen.compraronHoy || 0}</strong></p>
            <p>ğŸ“ˆ Tasa de conversiÃ³n: <strong>${resumen.tasa || 0}%</strong></p>
            <p>â±ï¸ Frecuencia promedio: <strong>${resumen.frecuenciaProm || "Sin datos"} dÃ­as</strong></p>
          </div>

          <div class="tarjeta-prediccion pantalla-tarjeta">
            <h3>ğŸ¤– RecomendaciÃ³n Inteligente</h3>
            <p>${pred.mensaje || "No hay registros suficientes para anÃ¡lisis inteligente."}</p>
          </div>
        `;
      } catch (e) {
        console.error("Error en cargarResumenInteligente:", e);
        cont.innerHTML = "âŒ Error al cargar resumen inteligente.";
      }
    }

    /* ================================
       ğŸšª SALIR
    ================================ */
    function logout() {
      localStorage.removeItem("vendedorClave");
      location.reload();
    }
  </script>
</body>
</html>
