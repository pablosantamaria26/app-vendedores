<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>App de Vendedores Inteligente</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <!-- LOGIN -->
  <div id="login" class="login">
    <h2>üîê Ingres√° tu clave</h2>
    <input type="password" id="clave" maxlength="4" placeholder="4 d√≠gitos" />
    <button onclick="login()">Entrar</button>
    <p id="error" class="error"></p>
  </div>

  <!-- APP PRINCIPAL -->
  <div id="app" class="oculto">
    <header>
      <h1 id="titulo"></h1>
      <div class="modo-toggle" id="modoToggle" onclick="alternarModo()">üåô</div>

      <div class="menu">
        <button id="btnRuta" class="activo" onclick="mostrarSeccion('ruta')">üó∫Ô∏è Ruta del D√≠a</button>
        <button id="btnCalendario" onclick="mostrarSeccion('calendario')">üìÖ Calendario</button>
        <button id="btnLogout" onclick="logout()">üö™ Salir</button>
      </div>
      <p id="estado"></p>
    </header>

    <main>
      <section id="seccion-ruta" class="seccion visible">
        <div id="contenedor"></div>
      </section>

      <section id="seccion-calendario" class="seccion oculto">
        <h2>üìÖ Calendario de Visitas</h2>
        <div id="contenedorCalendario" class="tabla-calendario"></div>
      </section>
    </main>
  </div>

  <script src="app.js"></script>

  <script>
    /* ================================
       CONTROL DE SECCIONES
    ================================ */
    function mostrarSeccion(seccion) {
      const rutaBtn = document.getElementById("btnRuta");
      const calBtn = document.getElementById("btnCalendario");
      const rutaSec = document.getElementById("seccion-ruta");
      const calSec = document.getElementById("seccion-calendario");

      rutaBtn.classList.remove("activo");
      calBtn.classList.remove("activo");
      rutaSec.classList.add("oculto");
      calSec.classList.add("oculto");
      rutaSec.classList.remove("visible");
      calSec.classList.remove("visible");

      if (seccion === "ruta") {
        rutaBtn.classList.add("activo");
        rutaSec.classList.add("visible");
        rutaSec.classList.remove("oculto");
      } else {
        calBtn.classList.add("activo");
        calSec.classList.add("visible");
        calSec.classList.remove("oculto");
        cargarCalendario();
      }
    }
    window.mostrarSeccion = mostrarSeccion;

    /* ================================
       CALENDARIO
    ================================ */
    async function cargarCalendario() {
      const clave = localStorage.getItem("vendedorClave");
      const cont = document.getElementById("contenedorCalendario");
      if (!clave) {
        cont.innerHTML = "‚ö†Ô∏è Debes iniciar sesi√≥n primero.";
        return;
      }

      cont.innerHTML = "‚è≥ Cargando calendario...";
      const url = `${URL_API_BASE}?accion=getCalendarioVisitas&clave=${clave}`;

      try {
        const resp = await fetch(url);
        const data = await resp.json();
        if (!data || data.length === 0) {
          cont.innerHTML = "üì≠ No hay visitas programadas.";
          return;
        }

        let html = `
          <table>
            <thead>
              <tr>
                <th>Fecha</th><th>D√≠a</th><th>Localidades</th><th>√öltima visita</th><th>Compr√≥</th>
              </tr>
            </thead>
            <tbody>
        `;

        data.forEach(fila => {
          html += `
            <tr>
              <td>${fila.fecha}</td>
              <td>${fila.dia}</td>
              <td>${fila.localidad}</td>
              <td>${fila.ultimaVisita || "-"}</td>
              <td>${fila.compro ? "‚úÖ" : "‚ùå"}</td>
            </tr>`;
        });

        html += "</tbody></table>";
        cont.innerHTML = html;
      } catch (e) {
        console.error("Error al cargar calendario:", e);
        cont.innerHTML = "‚ùå Error al cargar calendario.";
      }
    }
    window.cargarCalendario = cargarCalendario;

    /* ================================
       MODO OSCURO üåô / ‚òÄÔ∏è
    ================================ */
    function alternarModo() {
      const body = document.body;
      const icono = document.getElementById("modoToggle");
      const esOscuro = body.dataset.dark === "true";
      body.dataset.dark = esOscuro ? "false" : "true";
      localStorage.setItem("modoOscuro", body.dataset.dark);
      icono.textContent = esOscuro ? "üåô" : "‚òÄÔ∏è";
    }
    window.alternarModo = alternarModo;

    (function initModo() {
      const guardado = localStorage.getItem("modoOscuro");
      if (guardado) {
        document.body.dataset.dark = guardado;
        document.getElementById("modoToggle").textContent =
          guardado === "true" ? "‚òÄÔ∏è" : "üåô";
      } else {
        const hora = new Date().getHours();
        document.body.dataset.dark = hora >= 19 || hora < 7 ? "true" : "false";
      }
    })();

    /* ================================
       LOGOUT
    ================================ */
    function logout() {
      localStorage.removeItem("vendedorClave");
      location.reload();
    }
    window.logout = logout;
  </script>
</body>
</html>
