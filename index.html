<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>ğŸ§  App de Vendedores Inteligente</title>

  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/png" sizes="32x32" href="ml-favicon-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="ml-favicon-16.png">
  <link rel="apple-touch-icon" href="ml-icon-192.png">
  <meta name="theme-color" content="#007aff">

  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-messaging-compat.js"></script>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


</head>

<body>
  <div id="login">
    <div class="login-card">
      <h1>ğŸ§  App de Vendedores</h1>
      <h2>ğŸ” IngresÃ¡ tu cÃ³digo</h2>
      <input type="password" id="clave" maxlength="4" placeholder="â€¢â€¢â€¢â€¢" />
      <div class="teclado-numerico">
        <button onclick="agregarDigito('1')">1</button><button onclick="agregarDigito('2')">2</button><button onclick="agregarDigito('3')">3</button>
        <button onclick="agregarDigito('4')">4</button><button onclick="agregarDigito('5')">5</button><button onclick="agregarDigito('6')">6</button>
        <button onclick="agregarDigito('7')">7</button><button onclick="agregarDigito('8')">8</button><button onclick="agregarDigito('9')">9</button>
     
       <button onclick="borrarDigito()">âŒ«</button><button onclick="agregarDigito('0')">0</button><button onclick="login()">âœ”ï¸</button>
      </div>
      <p id="error"></p>
    </div>
  </div>

  <header>
    <h1 id="titulo">ğŸ§  App de Vendedores</h1>
    <div class="modo-toggle" onclick="toggleModoOscuro()">ğŸŒ™</div>
  </header>

  <main>
    <section id="seccion-ruta" class="seccion visible">
      <h2>ğŸ—ºï¸ Ruta del DÃ­a</h2>
      <div id="estado" style="text-align:center;
      margin:6px 0 10px"></div>
      <div id="contenedor"></div>
    </section>

    <section id="seccion-mapa" class="seccion">
      <h2>ğŸ“ Mapa</h2>
      <div id="mapaFull"></div>
    </section>

    <section id="seccion-calendario" class="seccion">
      <h2>ğŸ“… Calendario</h2>
      <div id="contenedorCalendario"></div>
    </section>

    <section id="seccion-resumen" class="seccion">
      <h2>ğŸ“ˆ Resumen</h2>
      <div 
      id="contenedorResumen" class="panel-resumen"></div>
      <canvas id="graficoResumen"></canvas>
    </section>
  </main>

  <div class="menu">
    <button id="btnRuta" class="activo" onclick="mostrarSeccion('ruta')">ğŸ—ºï¸ Ruta</button>
    <button id="btnMapa" onclick="mostrarSeccion('mapa')">ğŸ“ Mapa</button>
    <button id="btnCalendario" onclick="mostrarSeccion('calendario')">ğŸ“…</button>
    <button id="btnResumen" onclick="mostrarSeccion('resumen')">ğŸ“ˆ</button>
    <button id="btnLogout" onclick="logout()">ğŸšª</button>
  </div>

<script>
src="App.js"

    /* ================================
       âš™ï¸ Config principal
    ================================ */
    const vendedores = { "0001": "MartÃ­n", "0002": "Lucas", "0003": "Mercado Limpio" };
    // igual a tu app
    const URL_API_BASE = "https://script.google.com/macros/s/AKfycbzUdCXrwY9AkmtOB4T5ycNJKE17-_HeCQIVYZcUXCynNcQy3XQ1n51M5OKBgQoSL-pl/exec";
    // tu endpoint
    let clientesData = [];
    let posicionActual = null;
    let mapaFull = null;
    let dragSrc = null;

    /* ================================
       ğŸ” Login
    ================================ */
    function agregarDigito(n){const i=document.getElementById("clave");
    if(i.value.length<4) i.value+=n;}
    function borrarDigito(){const i=document.getElementById("clave"); i.value=i.value.slice(0,-1);}
    function login(){
      const c=document.getElementById("clave").value.trim();
      const e=document.getElementById("error");
      if(!vendedores[c]){ e.textContent="âŒ Clave incorrecta"; return; }
      localStorage.setItem("vendedorClave", c);
      document.getElementById("login").style.display="none";
      mostrarApp();
    }
    function logout(){ localStorage.removeItem("vendedorClave"); location.reload(); }
    window.onload=()=>{
      const c=localStorage.getItem("vendedorClave");
      if(c && vendedores[c]){ document.getElementById("login").style.display="none"; mostrarApp(); }
    };
    /* ================================
       ğŸ§­ NavegaciÃ³n de secciones
    ================================ */
    function mostrarSeccion(s){
      document.querySelectorAll(".seccion").forEach(sec=>sec.classList.remove("visible"));
      document.getElementById("seccion-"+s).classList.add("visible");
      document.querySelectorAll(".menu button").forEach(b=>b.classList.remove("activo"));
      const btn=document.querySelector(`[onclick="mostrarSeccion('${s}')"]`); if(btn) btn.classList.add("activo");
      if(s==="mapa") renderMapaFull();
    }

    /* ================================
       ğŸš€ App
    ================================ */
    async function mostrarApp(){
      const clave=localStorage.getItem("vendedorClave");
      const nombre=vendedores[clave];
      document.getElementById("titulo").textContent=`ğŸ‘‹ Hola, ${nombre}`;
      mostrarSeccion("ruta");
      await cargarRuta(clave);
      await cargarResumen(clave);
      await cargarCalendario();
      inicializarNotificaciones(clave);
      // FCM se inicializa aquÃ­
    }

    /* ================================
       ğŸ“ Distancia (Haversine)
    ================================ */
    const toRad = (d)=> d*Math.PI/180;
    function distanciaKm(aLat,aLng,bLat,bLng){
      const R=6371, dLat=toRad(bLat-aLat), dLng=toRad(bLng-aLng);
      const A = Math.sin(dLat/2)**2 + Math.cos(toRad(aLat))*Math.cos(toRad(bLat))*Math.sin(dLng/2)**2;
      return R*2*Math.atan2(Math.sqrt(A), Math.sqrt(1-A));
    }

    /* ================================
       ğŸ—‚ï¸ Orden + bloqueo por cliente
    ================================ */
    function keyOrden(){ return "ordenClientes_"+localStorage.getItem("vendedorClave");
    }
    function keyLock(){ return "clientesLock_"+localStorage.getItem("vendedorClave"); }
    function cargarOrden(){ try{ return JSON.parse(localStorage.getItem(keyOrden())||"[]"); }catch{ return [];
    } }
    function guardarOrden(ids){ localStorage.setItem(keyOrden(), JSON.stringify(ids)); }
    function locks(){ try{ return JSON.parse(localStorage.getItem(keyLock())||"{}");
    }catch{ return {}; } }
    function setLock(id, val){ const m=locks(); m[id]=val; localStorage.setItem(keyLock(), JSON.stringify(m));
    }

    /* ================================
       ğŸš— Cargar ruta
    ================================ */
    async function cargarRuta(clave){
      const cont=document.getElementById("contenedor");
      cont.innerHTML="â³ Cargando clientes...";
      try{
        const [r1, predR] = await Promise.all([
          fetch(`${URL_API_BASE}?accion=getRutaDelDiaPorVendedor&clave=${clave}`),
          fetch(`${URL_API_BASE}?accion=getPrediccionesVendedor&clave=${clave}`)
        ]);
        clientesData = await r1.json();
        const pred = await predR.json();

        // estado header
        const ahora = new Date().toLocaleString("es-AR", { timeZone:"America/Argentina/Buenos_Aires" });
        document.getElementById("estado").textContent = `Ruta cargada (${clientesData.length} clientes) â€” Ãšltima actualizaciÃ³n: ${ahora}`;
        // aplicar orden guardado
        const orden = cargarOrden();
        if(orden.length){
          const map = new Map(clientesData.map(c=>[String(c.numero), c]));
          clientesData = orden.map(id=>map.get(String(id))).filter(Boolean)
            .concat(clientesData.filter(c=>!orden.includes(String(c.numero))));
        }

        // tomar ubicaciÃ³n actual (para distancias)
        if(navigator.geolocation){
          navigator.geolocation.getCurrentPosition(pos=>{
            posicionActual = { lat:pos.coords.latitude, lng:pos.coords.longitude };
            renderClientes();
          }, ()=>renderClientes(), { enableHighAccuracy:true, maximumAge:15000, timeout:8000 });
        }else{
          renderClientes();
        }

        // panel de IA/resumen rÃ¡pido en la secciÃ³n Resumen si querÃ©s usarlo
        // (tu backend ya envÃ­a `mensaje`, `tasa`, etc)
        if(pred && pred.mensaje){
          // se muestra en cargarResumen para unificar
        }

      }catch(e){
        console.error(e);
        cont.innerHTML="âŒ Error al cargar clientes.";
      }
    }

    /* ================================
       ğŸ§± Render de tarjetas + drag&drop
    ================================ */
    function renderClientes(){
      const cont=document.getElementById("contenedor");
      cont.innerHTML="";

      const mlocks = locks();

      clientesData.forEach((c, idx)=>{
        const card = document.createElement("div");
        card.className = "cliente";
        card.id = "c_"+c.numero;
        const tieneGeo = typeof c.lat==="number" && typeof c.lng==="number";
        const dist = (posicionActual && tieneGeo) ? distanciaKm(posicionActual.lat,posicionActual.lng,c.lat,c.lng) : null;

        const lock = !!mlocks[c.numero];
        card.classList.toggle("bloqueado", lock);
        card.setAttribute("draggable", String(!lock));

  
    card.innerHTML = `
  <h3>${c.nombre}</h3>
  <div class="fila">
    <span>ğŸ“ ${c.direccion || ""}${c.localidad ? ", "+c.localidad : ""}</span>
    ${dist!==null ? `<span class="badge">ğŸ“ ${dist.toFixed(1)} km</span>` : ""}
  </div>
  <div class="fila" style="margin-top:6px">
    <label><input type="checkbox" id="visitado-${c.numero}"> Visitado</label>
    <label><input type="checkbox" id="compro-${c.numero}"> ComprÃ³</label>
  </div>
  <textarea id="coment-${c.numero}" placeholder="Comentario..." rows="2" style="width:100%;margin-top:6px"></textarea>
  <div class="acciones">
    <button onclick="registrarVisita(${c.numero})">ğŸ’¾ Guardar</button>
    <button class="btn-secundario" onclick="irCliente(${tieneGeo?c.lat:"null"},${tieneGeo?c.lng:"null"})">ğŸš— Ir</button>
  </div>
`;

        // Drag & Drop
        card.addEventListener("dragstart", (ev)=>{ dragSrc = idx; ev.dataTransfer.effectAllowed="move"; });
        card.addEventListener("dragover", (ev)=>{ ev.preventDefault(); ev.dataTransfer.dropEffect="move"; });
        card.addEventListener("drop", (ev)=>{
          ev.preventDefault();
          const target = Array.from(cont.children).indexOf(card);
          if(dragSrc===null || dragSrc===target) return;
          const moved = clientesData.splice(dragSrc,1)[0];
          clientesData.splice(target,0,moved);
          dragSrc = null;
          // guardar orden
          guardarOrden(clientesData.map(x=>String(x.numero)));
 
           renderClientes();
        });

        cont.appendChild(card);
      });
    }

    function toggleLock(numero){
      const m=locks();
      const now = !m[numero];
      setLock(numero, now);
      toast(now?"ğŸ”’ Tarjeta bloqueada":"ğŸ”“ Tarjeta desbloqueada");
      renderClientes();
    }

    /* ================================
       ğŸ—ºï¸ Mapa (vista separada)
    ================================ */
    function renderMapaFull(){
      const el = document.getElementById("mapaFull");
      if(!el) return;
      el.innerHTML = "";
      mapaFull = L.map("mapaFull").setView([-34.7,-58.4], 11);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(mapaFull);

      const group = [];
      clientesData.forEach(c=>{
        if(typeof c.lat==="number" && typeof c.lng==="number"){
          const mk = L.marker([c.lat, c.lng]).addTo(mapaFull).bindPopup(c.nombre);
          group.push(mk);
        }
      });
      if(group.length){ const gl = L.featureGroup(group); mapaFull.fitBounds(gl.getBounds().pad(0.3)); }

      if(posicionActual){
        L.marker([posicionActual.lat,posicionActual.lng],{
          icon: L.icon({ iconUrl:"https://cdn-icons-png.flaticon.com/512/684/684908.png", iconSize:[32,32] })
        }).addTo(mapaFull).bindPopup("ğŸ“ EstÃ¡s aquÃ­");
      }else if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(pos=>{
          posicionActual={lat:pos.coords.latitude,lng:pos.coords.longitude};
          renderMapaFull();
        });
      }
    }

    /* ==================================
       INICIO DE LA SECCIÃ“N CORREGIDA
       (AquÃ­ estaba el SyntaxError que rompÃ­a todo)
    ================================== */
    function irCliente(lat, lng) {
      if (!lat || !lng) {
        alert("ğŸ“ Este cliente no tiene coordenadas.");
        return;
      }
      
      // Usamos la URL estÃ¡ndar de Google Maps para direcciones
      const baseUrl = "https://www.google.com/maps/dir/?api=1";
      // Usamos backticks (`) y ${} para insertar las variables
      const destino = `&destination=${lat},${lng}&travelmode=driving`;

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
          // Si tenemos la ubicaciÃ³n, armamos la URL con origen y destino
          const origen = `&origin=${pos.coords.latitude},${pos.coords.longitude}`;
          window.open(`${baseUrl}${origen}${destino}`, "_blank");
        }, () => {
          // Si falla la geolocalizaciÃ³n (ej. no dio permiso), abre solo el destino
          window.open(`${baseUrl}${destino}`, "_blank");
        });
      } else {
        // Si el navegador no soporta geolocalizaciÃ³n, abre solo el destino
        window.open(`${baseUrl}${destino}`, "_blank");
      }
    }
    /* ================================
       FIN DE LA SECCIÃ“N CORREGIDA
    ================================ */

    /* ================================
       ğŸ’¾ Registrar visita (+ offline)
    ================================ */
    function getClientePorNumero(num){ return clientesData.find(x=>String(x.numero)===String(num));
    }

    async function registrarVisita(numero){
      const c = getClientePorNumero(numero);
      if(!c){ toast("âŒ Cliente no encontrado"); return; }
      const visitado = document.getElementById(`visitado-${numero}`).checked;
      const compro   = document.getElementById(`compro-${numero}`).checked;
      const comentario = (document.getElementById(`coment-${numero}`).value||"").trim();
      const vendedor = localStorage.getItem("vendedorClave");
      const params = new URLSearchParams({
        accion:"registrarVisita",
        numero:c.numero, nombre:c.nombre, direccion:c.direccion||"", localidad:c.localidad||"",
        visitado, compro, comentario, vendedor
      });
      try{
        const r = await fetch(`${URL_API_BASE}?${params.toString()}`);
        const js = await r.json();
        toast(js.estado || "âœ… Visita registrada");
        // marcar en UI
        if(visitado) document.getElementById(`visitado-${numero}`).checked = true;
      }catch{
        // offline queue
        queueOffline({ t:"visita", params:Object.fromEntries(params) });
        toast("ğŸ“¶ Sin conexiÃ³n. Guardado offline y se sincroniza despuÃ©s.");
      }
    }

    function queueOffline(item){
      const k="offlineQueue";
      let q=[];
      try{ q=JSON.parse(localStorage.getItem(k)||"[]"); }catch{}
      q.push(item); localStorage.setItem(k, JSON.stringify(q));
    }

    async function syncOffline(){
      if(!navigator.onLine) return;
      const k="offlineQueue"; let q=[];
      try{ q=JSON.parse(localStorage.getItem(k)||"[]");
      }catch{}
      if(!q.length) return;

      const rest=[];
      // reintentos fallidos
      for(const it of q){
        try{
          if(it.t==="visita"){
            const p = new URLSearchParams(it.params);
            const r = await fetch(`${URL_API_BASE}?${p.toString()}`);
            await r.json();
          }
        }catch{ rest.push(it);
        }
      }
      localStorage.setItem(k, JSON.stringify(rest));
      if(q.length && rest.length===0) toast("âœ… SincronizaciÃ³n completada");
    }
    window.addEventListener("online", syncOffline);

    /* ================================
       ğŸ“ˆ Resumen + grÃ¡fico
    ================================ */
    async function cargarResumen(clave){
      const cont=document.getElementById("contenedorResumen");
      cont.innerHTML="â³ Analizando desempeÃ±o...";
      try{
        const [r1,r2]=await Promise.all([
          fetch(`${URL_API_BASE}?accion=getResumenVendedor&clave=${clave}`),
          fetch(`${URL_API_BASE}?accion=getPrediccionesVendedor&clave=${clave}`)
        ]);
        const res=await r1.json(), ana=await r2.json();
        cont.innerHTML = `
          <h3>${res.fecha||""}</h3>
          <p>ğŸš¶ Visitas: <b>${res.totalHoy||0}</b> â€” ğŸ›’ Compraron: <b>${res.compraronHoy||0}</b></p>
          <p>ğŸ¯ Tasa: <b>${res.tasa||0}%</b> â€” â±ï¸ Frecuencia: <b>${res.frecuenciaProm||"N/D"}</b> dÃ­as</p>
          <p>ğŸ¤– ${ana.mensaje||""}</p>
        `;
        const ctx=document.getElementById("graficoResumen").getContext("2d");
        new Chart(ctx,{type:"doughnut",data:{labels:["Compraron","No compraron"],datasets:[{data:[res.compraronHoy||0,(res.totalHoy||0)-(res.compraronHoy||0)],backgroundColor:["#00c851","#ff4444"]}]} ,options:{plugins:{legend:{display:false}}}});
      }catch(e){
        console.error(e); cont.innerHTML="âŒ Error al cargar resumen.";
      }
    }

    /* ================================
       ğŸ“… Calendario
    ================================ */
    async function cargarCalendario(){
      const cont = document.getElementById("contenedorCalendario");
      const clave=localStorage.getItem("vendedorClave");
      if(!clave){ cont.innerHTML="âš ï¸ Debes iniciar sesiÃ³n primero."; return; }
      cont.innerHTML="â³ Cargando calendario...";
      try{
        const resp = await fetch(`${URL_API_BASE}?accion=getCalendarioVisitas&clave=${clave}`);
        const data = await resp.json();
        if(!data || !data.length){ cont.innerHTML="ğŸ“­ No hay visitas programadas."; return; }
        let html = `<div class="panel-resumen">`;
        data.forEach(f=>{
          html += `<div style="display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--borde);padding:8px 0">
            <div><b>${f.fecha}</b> â€” ${f.dia}<br><span>ğŸ“ ${f.localidad||""}</span></div>
            <div style="font-size:1.1rem">${f.compro?"âœ…":"âŒ"}</div>
          </div>`;
        });
        html += `</div>`;
        cont.innerHTML = html;
      }catch(e){ console.error(e); cont.innerHTML="âŒ Error al cargar calendario.";
      }
    }

   /* ==================================================
   ğŸ”” Inicializar notificaciones Firebase (versiÃ³n final con Worker)
   ================================================== */
function inicializarNotificaciones(vendedor) {
  console.log("ğŸš€ Inicializando notificaciones para", vendedor);

  // ğŸ”§ ConfiguraciÃ³n de Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyAKEZoMaPwAcLVRFVPVTQEOoQUuEEUHpwk",
    authDomain: "app-vendedores-inteligente.firebaseapp.com",
    projectId: "app-vendedores-inteligente",
    storageBucket: "app-vendedores-inteligente.appspot.com",
    messagingSenderId: "583313989429",
    appId: "1:583313989429:web:c4f78617ad957c3b11367c"
  };

  // ğŸ§© Inicializa Firebase si no estÃ¡ iniciado
  if (typeof firebase === "undefined") {
    console.error("âš ï¸ Firebase no estÃ¡ cargado.");
    return;
  }
  if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);

  const messaging = firebase.messaging();

  if ("serviceWorker" in navigator) {
    navigator.serviceWorker
      .register("firebase-messaging-sw.js")
      .then(async (registration) => {
        console.log("âœ… Service Worker registrado correctamente. Esperando activaciÃ³n...");
        await navigator.serviceWorker.ready;
        console.log("ğŸŸ¢ Service Worker activo. Solicitando permiso de notificaciones...");

        const permiso = await Notification.requestPermission();
        if (permiso !== "granted") {
          console.warn("âš ï¸ Permiso de notificaciones denegado por el usuario.");
          return;
        }

        console.log("ğŸ”‘ Obteniendo token FCM...");
        const token = await messaging.getToken({
          vapidKey: "BN480IhH70femCH6611oE699tLXFGYbS4MWcTbcEMbOUkR0vIwxXPrzTjhJEB9JcizJxqu4xs91-bQsal1_Hi8o",
          serviceWorkerRegistration: registration
        });

        if (token && vendedor) {
          console.log("ğŸ“¬ Token generado correctamente:", token.slice(0, 40) + "...");

          /* ==================================================
             ğŸš€ EnvÃ­o del token usando el Worker como proxy
             --------------------------------------------------
             Evita por completo el error CORS y permite
             funcionar desde GitHub Pages y mÃ³vil.
          ================================================== */
          const WORKER_URL = "https://frosty-term-20ea.santamariapablodaniel.workers.dev/";

          try {
            const respuesta = await fetch(WORKER_URL, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ vendedor, token })
            });

            const texto = await respuesta.text();
            console.log("âœ… Token enviado correctamente vÃ­a Worker:", texto);
          } catch (err) {
            console.error("âŒ Error enviando token vÃ­a Worker:", err);
          }
        } else {
          console.warn("âš ï¸ No se obtuvo token FCM (posible bloqueo o permiso denegado).");
        }

        // ğŸ”” Escuchar notificaciones en primer plano
        messaging.onMessage((payload) => {
          console.log("ğŸ“¢ NotificaciÃ³n recibida (foreground):", payload);
          const n = payload.notification;
          if (n) toast(`${n.title} â€” ${n.body}`);
        });
      })
      .catch((err) => console.error("âŒ Error al registrar el Service Worker:", err));
  } else {
    console.warn("âš ï¸ Este navegador no soporta Service Workers ni notificaciones push.");
  }
}



    /* ================================
       ğŸŒ™ Modo oscuro
    ================================ */
    function toggleModoOscuro(){
      const dark = document.body.getAttribute("data-dark")==="true";
      document.body.setAttribute("data-dark", !dark);
      localStorage.setItem("modoOscuro", String(!dark));
    }
    if(localStorage.getItem("modoOscuro")==="true"){ document.body.setAttribute("data-dark", "true");
    }

    /* ================================
       ğŸ’¬ Toast
    ================================ */
    function toast(msg){
      const t = document.createElement("div");
      t.className = "toast"; t.textContent = msg;
      document.body.appendChild(t);
      setTimeout(()=>t.remove(), 2900);
    }

    /* ================================
       ğŸ” SincronizaciÃ³n al iniciar
    ================================ */
    (async function bootstrap(){
      await syncOffline();
    })();
  </script>
</body>
</html>
