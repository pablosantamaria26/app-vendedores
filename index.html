<!DOCTYPE html>
<html lang="es" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Mercado Limpio Ventas</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />

  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'sans-serif'] },
          colors: {
            dark: { bg: '#0f172a', card: '#1e293b', text: '#f8fafc' },
            light: { bg: '#f1f5f9', card: '#ffffff', text: '#1e293b' }
          }
        }
      }
    }
  </script>

  <style>
    body { overflow: hidden; -webkit-tap-highlight-color: transparent; transition: background-color 0.3s, color 0.3s; }
    .no-scrollbar::-webkit-scrollbar { display: none; }

    .btn-press:active { transform: scale(0.96); transition: 0.1s; }
    @keyframes popIn { 0% { opacity: 0; transform: scale(0.95); } 100% { opacity: 1; transform: scale(1); } }
    .animate-pop { animation: popIn 0.22s cubic-bezier(0.175, 0.885, 0.32, 1.15); }

    .view-section { display: none; height: 100vh; flex-direction: column; }
    .view-section.active { display: flex; }

    .chat-bubble { max-width: 85%; padding: 12px 16px; border-radius: 18px; margin-bottom: 8px; font-size: 0.95rem; line-height: 1.4; word-wrap: break-word; }
    html:not(.dark) .chat-user { background: #2563eb; color: white; align-self: flex-end; border-bottom-right-radius: 2px; margin-left: auto; }
    html:not(.dark) .chat-bot { background: #ffffff; color: #1e293b; align-self: flex-start; border-bottom-left-radius: 2px; border: 1px solid #e2e8f0; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    html.dark .chat-user { background: #3b82f6; color: white; align-self: flex-end; border-bottom-right-radius: 2px; margin-left: auto; }
    html.dark .chat-bot { background: #334155; color: #e2e8f0; align-self: flex-start; border-bottom-left-radius: 2px; border: 1px solid #475569; }

    .ticket-box { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; padding: 10px; border-radius: 12px; margin-top: 6px; font-size: 0.85rem; border: 2px dashed; }
    html:not(.dark) .ticket-box { background: #f8fafc; color: #334155; border-color: #cbd5e1; }
    html.dark .ticket-box { background: #0b1224; color: #cbd5e1; border-color: #475569; }

    .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; padding: 10px 20px; border-radius: 50px; font-weight: bold; pointer-events: none; opacity: 0; transition: 0.3s; display: flex; align-items: center; gap: 8px; box-shadow: 0 10px 20px rgba(0,0,0,0.3); }

    .btn-copy-order { margin-top:10px; width:100%; padding:10px 12px; border-radius:12px; font-weight:900; font-size:12px; display:flex; justify-content:center; gap:8px; background:#2563eb; color:#fff; }
    html.dark .btn-copy-order { background:#3b82f6; }

    .typing-row { display:flex; align-items:center; gap:6px; }
    .typing-dot { width:6px; height:6px; border-radius:50%; opacity:.7; }
    html:not(.dark) .typing-dot { background:#334155; }
    html.dark .typing-dot { background:#e2e8f0; }
    @keyframes bounceDot { 0%, 80%, 100% { transform: translateY(0); opacity: .5; } 40% { transform: translateY(-4px); opacity: 1; } }
    .d1 { animation: bounceDot 1s infinite; }
    .d2 { animation: bounceDot 1s infinite .15s; }
    .d3 { animation: bounceDot 1s infinite .30s; }

    .opp-card { border-radius:16px; padding:12px; border:1px solid; }
    html:not(.dark) .opp-card { background:#ffffff; border-color:#e2e8f0; }
    html.dark .opp-card { background:#0f172a; border-color:#334155; }
    .opp-title { font-weight:900; font-size:13px; text-transform: uppercase; }
    .opp-sub { font-size:12px; opacity:.8; margin-top:2px; }
    .opp-actions { display:grid; grid-template-columns: 1fr 1fr; gap:8px; margin-top:10px; }
    .opp-btn { padding:10px 10px; border-radius:14px; font-weight:900; font-size:12px; display:flex; justify-content:center; align-items:center; gap:8px; border:1px solid transparent; }
    .opp-btn-primary { background:#16a34a; color:white; }
    .opp-btn-secondary { background:transparent; border-color:#64748b; color:#e2e8f0; }
    html:not(.dark) .opp-btn-secondary { color:#334155; border-color:#cbd5e1; }
    .opp-meta { margin-top:8px; font-size:11px; opacity:.8; display:flex; gap:10px; flex-wrap:wrap; }

    .zone-meta { margin-top: 10px; display:flex; flex-direction:column; gap:6px; }
    .zone-chip { font-size:10px; font-weight:900; text-transform:uppercase; letter-spacing:.18em; opacity:.85; }
    .zone-last-row { font-size:11px; font-weight:800; display:flex; gap:8px; align-items:center; opacity:.9; }
    html.dark .zone-last-row { color: #cbd5e1; }
    html:not(.dark) .zone-last-row { color: #475569; }
    .zone-last-label { opacity:.7; font-weight:900; font-size:10px; letter-spacing:.22em; }
    .zone-last-motivo { font-weight:900; }

    /* mini chips */
    .mini-chip { font-size:10px; font-weight:900; letter-spacing:.14em; text-transform:uppercase; padding:6px 10px; border-radius:999px; border:1px solid; }
    html.dark .mini-chip { border-color:#334155; background:#0b1224; color:#cbd5e1; }
    html:not(.dark) .mini-chip { border-color:#e2e8f0; background:#ffffff; color:#334155; }

    /* subtle skeleton */
    .skeleton { position: relative; overflow: hidden; }
    .skeleton:before {
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(90deg, rgba(255,255,255,0), rgba(255,255,255,.08), rgba(255,255,255,0));
      transform: translateX(-100%);
      animation: shimmer 1.1s infinite;
    }
    @keyframes shimmer { 100% { transform: translateX(100%); } }

    /* better focus for inputs */
    input:focus, textarea:focus { outline: none; box-shadow: 0 0 0 3px rgba(59,130,246,.25); border-color: rgba(59,130,246,.7) !important; }

    /* ====== NUEVO: dropdown search ====== */
    .search-dd {
      position: absolute;
      left: 0; right: 0;
      top: calc(100% + 8px);
      z-index: 40;
      border-radius: 18px;
      overflow: hidden;
      border: 1px solid rgba(148,163,184,.35);
      backdrop-filter: blur(10px);
    }
    html:not(.dark) .search-dd { background: rgba(255,255,255,.98); }
    html.dark .search-dd { background: rgba(15,23,42,.98); border-color: rgba(51,65,85,.9); }
    .search-dd-row { display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 12px; cursor:pointer; }
    .search-dd-row:hover { background: rgba(59,130,246,.08); }
    .search-dd-title { font-weight: 900; font-size: 12px; text-transform: uppercase; }
    .search-dd-sub { font-size: 11px; opacity: .8; margin-top: 2px; }
  </style>
</head>

<body class="bg-light-bg dark:bg-dark-bg text-light-text dark:text-dark-text">

  <div id="loader" class="fixed inset-0 z-[100] bg-black/80 flex flex-col items-center justify-center hidden backdrop-blur-sm">
    <div class="w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
    <p class="mt-4 text-xs font-bold text-blue-400 tracking-widest animate-pulse">CARGANDO...</p>
  </div>

  <div id="toast" class="toast bg-slate-800 text-white border border-slate-600"></div>

  <!-- LOGIN -->
  <section id="view-login" class="view-section active justify-center p-8 bg-slate-900 relative">
    <div class="w-full max-w-sm text-center mx-auto z-10">
      <div class="w-20 h-20 bg-blue-600 rounded-2xl mx-auto flex items-center justify-center mb-6 shadow-2xl shadow-blue-500/30 rotate-3">
        <i class="fas fa-box text-3xl text-white"></i>
      </div>
      <h1 class="text-3xl font-black mb-2 text-white">MERCADO<span class="text-blue-500">LIMPIO</span></h1>
      <p class="text-slate-400 text-xs font-bold uppercase tracking-[0.3em] mb-10">Ventas & Logística</p>

      <input id="login-user" type="text" class="w-full bg-slate-800 border border-slate-700 rounded-xl p-4 mb-3 text-center font-bold uppercase placeholder-slate-500 text-white focus:border-blue-500 outline-none" placeholder="USUARIO" autocomplete="username" />
      <input id="login-pass" type="password" inputmode="numeric" class="w-full bg-slate-800 border border-slate-700 rounded-xl p-4 mb-6 text-center font-bold uppercase placeholder-slate-500 text-white focus:border-blue-500 outline-none" placeholder="PIN" autocomplete="current-password" />

      <button id="btn-login" onclick="handleLogin()" class="btn-press w-full bg-blue-600 p-4 rounded-xl font-bold shadow-lg shadow-blue-900/40 text-white">INGRESAR</button>

      <p class="mt-6 text-[10px] text-slate-500 font-bold uppercase tracking-[0.25em]">Tip: ENTER en el PIN</p>
    </div>
  </section>

  <!-- DASHBOARD -->
  <section id="view-dashboard" class="view-section bg-slate-50 dark:bg-slate-950">
    <div class="px-6 pt-10 pb-4 bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-800 sticky top-0 z-10 flex justify-between items-end">
      <div>
        <p class="text-[10px] text-blue-500 font-bold uppercase mb-1">Bienvenido</p>
        <h2 class="text-2xl font-black leading-none">HOLA, <span id="lbl-saludo">...</span></h2>
        <div class="mt-2 flex gap-2 flex-wrap">
          <span id="chip-turno" class="mini-chip"><i class="fas fa-sun"></i> TURNO: —</span>
          <span id="chip-semana" class="mini-chip cursor-pointer btn-press" onclick="openWeekModal()"><i class="fas fa-calendar-week"></i> SEMANA</span>
        </div>
      </div>
      <div class="flex gap-2">
        <button onclick="toggleTheme()" class="w-9 h-9 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-500 dark:text-slate-400 flex items-center justify-center border border-slate-200 dark:border-slate-700">
          <i class="fas fa-adjust"></i>
        </button>
        <button onclick="logout()" class="w-9 h-9 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-500 dark:text-slate-400 hover:text-red-500 flex items-center justify-center border border-slate-200 dark:border-slate-700">
          <i class="fas fa-power-off text-xs"></i>
        </button>
      </div>
    </div>

    <div class="px-4 py-3 bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-800">
      <div class="flex gap-2">
        <div class="flex-1 relative">
          <div class="flex items-center gap-2 bg-slate-100 dark:bg-slate-800 px-3 py-2 rounded-2xl border border-slate-200 dark:border-slate-700">
            <i class="fas fa-magnifying-glass text-slate-400"></i>
            <input id="q-client" type="text" inputmode="numeric" placeholder="Buscar cliente por ID..." class="flex-1 bg-transparent border-0 text-sm dark:text-white outline-none" />
            <button class="btn-press px-3 py-2 rounded-xl bg-blue-600 text-white font-black text-xs" onclick="searchClientById()">IR</button>
            <!-- NUEVO: abre el modal de búsqueda si querés (opcional, no rompe) -->
            <button class="btn-press px-3 py-2 rounded-xl bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-100 font-black text-xs" onclick="openClientSearchModal()">
              <i class="fas fa-list"></i>
            </button>
          </div>

          <!-- NUEVO: dropdown live results -->
          <div id="q-dd" class="search-dd hidden"></div>
        </div>
      </div>
      <p class="mt-2 text-[10px] font-bold uppercase tracking-widest text-slate-400">
        
      </p>
    </div>

    <div class="flex-1 overflow-y-auto p-4 pb-24 no-scrollbar">
      <p class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-3 ml-1">Zonas Disponibles</p>
      <div id="zones-grid" class="grid grid-cols-2 gap-3"></div>
    </div>

    <div id="footer-dashboard" class="p-4 bg-white dark:bg-slate-900 border-t border-slate-200 dark:border-slate-800 fixed bottom-0 w-full hidden z-20">
      <button onclick="startRoute()" class="btn-press w-full bg-blue-600 text-white py-4 rounded-xl font-bold shadow-lg flex justify-center items-center gap-2">
        <i class="fas fa-location-arrow"></i> <span id="btn-start-lbl">INICIAR</span>
      </button>
    </div>

    <button onclick="toggleAIChat(true)" class="fixed bottom-6 right-6 w-14 h-14 bg-indigo-600 rounded-full shadow-xl flex items-center justify-center z-30 btn-press text-white border-2 border-white dark:border-slate-700">
      <i class="fas fa-headset text-xl"></i>
    </button>
  </section>

  <!-- RUTA -->
  <section id="view-route" class="view-section bg-slate-100 dark:bg-slate-950">
    <div class="px-4 py-3 bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-800 sticky top-0 z-10 flex justify-between items-center shadow-sm h-16">
      <button onclick="switchView('view-dashboard')" class="w-10 h-10 bg-slate-50 dark:bg-slate-800 rounded-xl text-slate-500 dark:text-slate-400 border border-slate-200 dark:border-slate-700">
        <i class="fas fa-chevron-left"></i>
      </button>

      <div class="flex items-center gap-2 bg-slate-100 dark:bg-slate-800 px-3 py-1 rounded-full border border-slate-200 dark:border-slate-700">
        <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
        <span id="route-count" class="text-sm font-bold">0</span>
      </div>

      <div class="flex gap-2">
        <button onclick="toggleViewMode()" class="w-10 h-10 bg-slate-50 dark:bg-slate-800 rounded-xl text-blue-500 border border-slate-200 dark:border-slate-700" title="Modo lista / foco">
          <i id="icon-view-mode" class="fas fa-list"></i>
        </button>
        <button onclick="openNoLlegueZoneModal()" class="w-10 h-10 bg-slate-50 dark:bg-slate-800 rounded-xl text-red-500 border border-slate-200 dark:border-slate-700" title="Finalizar zona como No llegué">
          <i class="fas fa-ban"></i>
        </button>
      </div>
    </div>

    <div class="px-4 py-2 bg-slate-50 dark:bg-slate-900 border-b border-slate-200 dark:border-slate-800 flex justify-center gap-4 text-[10px] font-bold text-slate-500 uppercase">
      <div class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-green-500"></span> Al día</div>
      <div class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-yellow-500"></span> +30 Días</div>
      <div class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-red-500"></span> +60 Días</div>
    </div>

    <div id="route-container" class="flex-1 overflow-y-auto p-4 pb-20 no-scrollbar relative space-y-3"></div>

    <div class="fixed bottom-0 w-full p-4 bg-white dark:bg-slate-900 border-t border-slate-200 dark:border-slate-800">
      <button onclick="finalizeTurnOrDay()" class="btn-press w-full bg-slate-900 dark:bg-blue-600 text-white py-3 rounded-xl font-black flex items-center justify-center gap-2">
        <i class="fas fa-flag-checkered"></i> Finalizar (turno / día)
      </button>
      <p class="mt-2 text-[10px] font-bold uppercase tracking-widest text-slate-400 text-center">Se guarda offline si no hay señal</p>
    </div>
  </section>

  <!-- MODAL SUGGESTIONS -->
  <div id="modal-suggestions" class="fixed inset-0 z-50 bg-black/60 flex items-center justify-center hidden p-4 backdrop-blur-sm">
    <div class="bg-white dark:bg-slate-800 w-full max-w-sm rounded-3xl p-6 shadow-2xl animate-pop">
      <div class="text-center mb-6">
        <h3 class="text-xl font-black dark:text-white">Plan Sugerido</h3>
        <p class="text-sm text-slate-500 dark:text-slate-400">Selecciona las zonas para hoy:</p>
      </div>
      <div id="suggestions-list" class="space-y-2 mb-6 max-h-60 overflow-y-auto"></div>
      <div class="grid grid-cols-2 gap-3">
        <button onclick="el('modal-suggestions').classList.add('hidden')" class="btn-press py-3 rounded-xl font-bold bg-slate-100 dark:bg-slate-700 text-slate-500 dark:text-slate-300">Omitir</button>
        <button onclick="applySuggestions()" class="btn-press py-3 rounded-xl font-bold bg-blue-600 text-white">Confirmar</button>
      </div>
    </div>
  </div>

  <!-- MODAL NO LLEGUE ZONA (NUEVO, LINDO) -->
  <div id="modal-no-llegue-zone" class="fixed inset-0 z-[70] bg-black/70 hidden items-center justify-center p-4 backdrop-blur-sm">
    <div class="bg-white dark:bg-slate-900 w-full sm:max-w-lg rounded-3xl p-6 shadow-2xl animate-pop border border-slate-200 dark:border-slate-700">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-[10px] font-black uppercase tracking-widest text-red-500">Finalizar zona</p>
          <h3 class="text-lg font-black dark:text-white">Marcar como “No llegué”</h3>
          <p id="nlz-sub" class="text-xs mt-1 text-slate-500 dark:text-slate-400">...</p>
        </div>
        <button onclick="closeNoLlegueZoneModal()" class="w-10 h-10 rounded-xl bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 border border-slate-200 dark:border-slate-700">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="mt-4 grid grid-cols-2 gap-3">
        <div class="p-4 rounded-2xl border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800">
          <div class="text-[10px] font-black uppercase tracking-widest text-slate-400">Pendientes</div>
          <div id="nlz-count" class="text-3xl font-black mt-1">0</div>
        </div>
        <div class="p-4 rounded-2xl border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800">
          <div class="text-[10px] font-black uppercase tracking-widest text-slate-400">Zona(s)</div>
          <div id="nlz-zones" class="text-sm font-black mt-1 truncate">—</div>
        </div>
      </div>

      <div class="mt-4">
        <label class="text-[10px] font-black uppercase tracking-widest text-slate-400">Nota (opcional)</label>
        <textarea id="nlz-note" class="w-full mt-2 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-2xl p-3 text-sm h-20 resize-none dark:text-white" placeholder="Ej: Sin señal / cliente cerrado / lluvia / me fui a otra zona..."></textarea>
      </div>

      <div class="mt-4 flex items-center gap-2">
        <input id="nlz-also-week" type="checkbox" class="w-4 h-4" checked />
        <label for="nlz-also-week" class="text-xs font-bold text-slate-600 dark:text-slate-300">Guardar esto en “Semana” (para que quede marcado)</label>
      </div>

      <div class="mt-5 grid grid-cols-2 gap-3">
        <button onclick="closeNoLlegueZoneModal()" class="btn-press py-3 rounded-xl font-black bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-200 border border-slate-200 dark:border-slate-700">
          Cancelar
        </button>
        <button onclick="confirmNoLlegueZone()" class="btn-press py-3 rounded-xl font-black bg-red-600 text-white flex items-center justify-center gap-2">
          <i class="fas fa-ban"></i> Confirmar No llegué
        </button>
      </div>
    </div>
  </div>

  <!-- MODAL SEMANA (NUEVO) -->
  <div id="modal-week" class="fixed inset-0 z-[65] bg-black/70 hidden items-center justify-center p-4 backdrop-blur-sm">
    <div class="bg-white dark:bg-slate-900 w-full sm:max-w-lg rounded-3xl p-6 shadow-2xl animate-pop border border-slate-200 dark:border-slate-700">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-[10px] font-black uppercase tracking-widest text-blue-500">Semana</p>
          <h3 class="text-lg font-black dark:text-white">Zonas hechas y pendientes</h3>
          <p id="week-sub" class="text-xs mt-1 text-slate-500 dark:text-slate-400">...</p>
        </div>
        <button onclick="closeWeekModal()" class="w-10 h-10 rounded-xl bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 border border-slate-200 dark:border-slate-700">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="mt-4 grid grid-cols-2 gap-3">
        <div class="p-4 rounded-2xl border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800">
          <div class="text-[10px] font-black uppercase tracking-widest text-slate-400">Hechas</div>
          <div id="week-done" class="text-3xl font-black mt-1">0</div>
        </div>
        <div class="p-4 rounded-2xl border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800">
          <div class="text-[10px] font-black uppercase tracking-widest text-slate-400">Pendientes</div>
          <div id="week-pending" class="text-3xl font-black mt-1">0</div>
        </div>
      </div>

      <div class="mt-4">
        <div class="text-[10px] font-black uppercase tracking-widest text-slate-400 mb-2">Detalle</div>
        <div id="week-list" class="max-h-72 overflow-y-auto no-scrollbar space-y-2"></div>
      </div>

      <div class="mt-5 grid grid-cols-2 gap-3">
        <button onclick="resetWeekProgress()" class="btn-press py-3 rounded-xl font-black bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-200 border border-slate-200 dark:border-slate-700">
          Reset semana
        </button>
        <button onclick="askAIWeekPlan()" class="btn-press py-3 rounded-xl font-black bg-blue-600 text-white flex items-center justify-center gap-2">
          <i class="fas fa-brain"></i> Pedir plan a soporte
        </button>
      </div>
    </div>
  </div>

  <!-- MODAL ONBOARDING (NUEVO) -->
  <div id="modal-onboard" class="fixed inset-0 z-[90] bg-black/70 hidden items-center justify-center p-4 backdrop-blur-sm">
    <div class="bg-white dark:bg-slate-900 w-full sm:max-w-lg rounded-3xl p-6 shadow-2xl animate-pop border border-slate-200 dark:border-slate-700">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-[10px] font-black uppercase tracking-widest text-indigo-500">Primera vez</p>
          <h3 class="text-lg font-black dark:text-white">Dejame conocerte 30 segundos</h3>
          <p class="text-xs mt-1 text-slate-500 dark:text-slate-400">
            Esto se guarda como “hilo” del chat para que el soporte te hable distinto.
          </p>
        </div>
        <button onclick="closeOnboard(false)" class="w-10 h-10 rounded-xl bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 border border-slate-200 dark:border-slate-700">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="mt-4 space-y-3">
        <div>
          <label class="text-[10px] font-black uppercase tracking-widest text-slate-400">Cómo querés que te llame</label>
          <input id="ob-name" type="text" class="w-full mt-2 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-2xl p-3 text-sm dark:text-white" placeholder="Ej: Martín / Rami / El Toro..." />
        </div>

        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="text-[10px] font-black uppercase tracking-widest text-slate-400">Tu estilo</label>
            <select id="ob-style" class="w-full mt-2 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-2xl p-3 text-sm dark:text-white">
              <option value="directo">Directo y firme</option>
              <option value="calmo">Calmo y paciente</option>
              <option value="humor">Con humor</option>
              <option value="coach">Modo coach (motivación)</option>
            </select>
          </div>
          <div>
            <label class="text-[10px] font-black uppercase tracking-widest text-slate-400">Turnos</label>
            <select id="ob-shift" class="w-full mt-2 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-2xl p-3 text-sm dark:text-white">
              <option value="manana">Solo mañana</option>
              <option value="tarde">Solo tarde</option>
              <option value="doble" selected>Ambos (mañana + tarde)</option>
            </select>
          </div>
        </div>

        <div>
          <label class="text-[10px] font-black uppercase tracking-widest text-slate-400">Qué te cuesta más (1 frase)</label>
          <input id="ob-pain" type="text" class="w-full mt-2 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-2xl p-3 text-sm dark:text-white" placeholder="Ej: Me dicen 'tengo proveedor' y me bloqueo" />
        </div>
      </div>

      <div class="mt-5 grid grid-cols-2 gap-3">
        <button onclick="closeOnboard(false)" class="btn-press py-3 rounded-xl font-black bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-200 border border-slate-200 dark:border-slate-700">
          Omitir
        </button>
        <button onclick="closeOnboard(true)" class="btn-press py-3 rounded-xl font-black bg-indigo-600 text-white flex items-center justify-center gap-2">
          <i class="fas fa-check"></i> Guardar
        </button>
      </div>
    </div>
  </div>

  <!-- CHAT -->
  <div id="modal-chat" class="fixed inset-0 z-50 bg-black/50 hidden flex flex-col justify-end sm:justify-center items-center backdrop-blur-sm">
    <div id="chat-panel" class="bg-slate-50 dark:bg-slate-950 w-full sm:max-w-md h-[80vh] sm:rounded-3xl rounded-t-3xl shadow-2xl flex flex-col transform translate-y-full transition-transform duration-300">
      <div class="p-4 bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-800 flex justify-between items-center rounded-t-3xl">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-full bg-indigo-600 flex items-center justify-center text-white"><i class="fas fa-robot"></i></div>
          <div>
            <h3 class="font-bold text-sm dark:text-white">Mercado Limpio</h3>
            <p id="chat-sub" class="text-[10px] font-bold uppercase tracking-widest text-slate-400">Soporte</p>
          </div>
        </div>
        <button onclick="toggleAIChat(false)" class="w-8 h-8 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-500 flex items-center justify-center"><i class="fas fa-times"></i></button>
      </div>

      <div id="chat-msgs" class="flex-1 overflow-y-auto p-4 flex flex-col gap-3">
        <div class="chat-bubble chat-bot">Hola. ¿Qué necesitás?</div>
      </div>

      <div class="p-4 bg-white dark:bg-slate-900 border-t border-slate-200 dark:border-slate-800 pb-6">
        <div class="flex gap-2 bg-slate-100 dark:bg-slate-800 p-1.5 rounded-2xl border border-slate-200 dark:border-slate-700">
          <input id="chat-in" type="text" placeholder="Escribe tu consulta..." class="flex-1 bg-transparent border-0 px-3 text-sm dark:text-white outline-none" />
          <button onclick="sendChat()" class="w-10 h-10 bg-blue-600 rounded-xl text-white flex items-center justify-center"><i class="fas fa-paper-plane text-xs"></i></button>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL REG -->
  <div id="modal-reg" class="fixed inset-0 z-[60] bg-black/80 hidden flex items-center justify-center p-6 backdrop-blur-sm">
    <div class="bg-white dark:bg-slate-800 w-full max-w-sm rounded-3xl p-6 shadow-2xl animate-pop">
      <h3 id="reg-title" class="text-xl font-black mb-1 dark:text-white">CLIENTE</h3>
      <div id="reg-info" class="text-xs text-slate-500 mb-4">...</div>
      <div class="grid grid-cols-2 gap-3 mb-4">
        <button onclick="selectReason('Stock', this)" class="reason-btn btn-press bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 p-4 rounded-xl text-left">
          <i class="fas fa-box text-blue-500 block mb-2 text-xl"></i><span class="text-[10px] font-bold uppercase text-slate-600 dark:text-slate-300">Tiene Stock</span>
        </button>
        <button onclick="selectReason('Dinero', this)" class="reason-btn btn-press bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 p-4 rounded-xl text-left">
          <i class="fas fa-wallet text-red-500 block mb-2 text-xl"></i><span class="text-[10px] font-bold uppercase text-slate-600 dark:text-slate-300">Sin Dinero</span>
        </button>
        <button onclick="selectReason('Cerrado', this)" class="reason-btn btn-press bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 p-4 rounded-xl text-left">
          <i class="fas fa-store-slash text-yellow-500 block mb-2 text-xl"></i><span class="text-[10px] font-bold uppercase text-slate-600 dark:text-slate-300">Cerrado</span>
        </button>
        <button onclick="selectReason('Volver', this)" class="reason-btn btn-press bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 p-4 rounded-xl text-left">
          <i class="fas fa-clock text-purple-500 block mb-2 text-xl"></i><span class="text-[10px] font-bold uppercase text-slate-600 dark:text-slate-300">Volver</span>
        </button>
        <button onclick="selectReason('No llegué', this)" class="reason-btn btn-press bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 p-4 rounded-xl text-left col-span-2">
          <i class="fas fa-ban text-red-500 block mb-2 text-xl"></i><span class="text-[10px] font-bold uppercase text-slate-600 dark:text-slate-300">No llegué</span>
        </button>
      </div>
      <textarea id="reg-obs" class="w-full bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl p-3 text-sm h-20 mb-4 resize-none dark:text-white outline-none" placeholder="Nota opcional..."></textarea>
      <div class="flex gap-3">
        <button onclick="el('modal-reg').classList.add('hidden')" class="flex-1 py-3 bg-slate-100 dark:bg-slate-700 rounded-xl font-bold dark:text-white">Cancelar</button>
        <button onclick="commitSave()" class="flex-1 py-3 bg-slate-900 dark:bg-blue-600 text-white rounded-xl font-bold">GUARDAR</button>
      </div>
    </div>
  </div>

  <!-- MODAL PEDIDO -->
  <div id="modal-order" class="fixed inset-0 z-[80] bg-black/70 hidden items-center justify-center p-4 backdrop-blur-sm">
    <div class="bg-white dark:bg-slate-900 w-full sm:max-w-lg rounded-3xl p-5 shadow-2xl animate-pop border border-slate-200 dark:border-slate-700">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-[10px] font-black uppercase tracking-widest text-blue-500">Último pedido</p>
          <h3 id="order-title" class="text-lg font-black dark:text-white">Cliente</h3>
        </div>
        <button onclick="closeOrderModal()" class="w-10 h-10 rounded-xl bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 border border-slate-200 dark:border-slate-700">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="mt-4">
        <div class="ticket-box">
          <div id="order-ticket" style="white-space: pre-wrap;"></div>
        </div>
      </div>

      <div class="mt-4 grid grid-cols-2 gap-3">
        <button onclick="copyCurrentOrder()" class="btn-press py-3 rounded-xl font-black bg-blue-600 text-white flex items-center justify-center gap-2">
          <i class="fas fa-copy"></i> Copiar
        </button>
        <button onclick="closeOrderModal()" class="btn-press py-3 rounded-xl font-black bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-200 border border-slate-200 dark:border-slate-700">
          Cerrar
        </button>
      </div>
    </div>
  </div>

  <!-- ✅ NUEVO: MODAL CLIENTE (BUSCADOR) -->
  <div id="modal-client" class="fixed inset-0 z-[85] bg-black/70 hidden items-center justify-center p-4 backdrop-blur-sm">
    <div class="bg-white dark:bg-slate-900 w-full sm:max-w-lg rounded-3xl p-6 shadow-2xl animate-pop border border-slate-200 dark:border-slate-700">
      <div class="flex items-center justify-between">
        <div class="min-w-0">
          <p class="text-[10px] font-black uppercase tracking-widest text-blue-500">Cliente</p>
          <h3 id="client-title" class="text-lg font-black dark:text-white truncate">—</h3>
          <p id="client-sub" class="text-xs mt-1 text-slate-500 dark:text-slate-400 truncate">—</p>
        </div>
        <button onclick="closeClientModal()" class="w-10 h-10 rounded-xl bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 border border-slate-200 dark:border-slate-700">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="mt-4 grid grid-cols-2 gap-3">
        <div class="p-4 rounded-2xl border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800">
          <div class="text-[10px] font-black uppercase tracking-widest text-slate-400">ID</div>
          <div id="client-id" class="text-2xl font-black mt-1">—</div>
        </div>
        <div class="p-4 rounded-2xl border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800">
          <div class="text-[10px] font-black uppercase tracking-widest text-slate-400">Zona</div>
          <div id="client-zone" class="text-sm font-black mt-1 truncate">—</div>
        </div>
      </div>

      <div class="mt-4">
        <div class="text-[10px] font-black uppercase tracking-widest text-slate-400 mb-2">Dirección</div>
        <div id="client-address" class="p-4 rounded-2xl border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 text-sm font-bold text-slate-700 dark:text-slate-200">
          —
        </div>
      </div>

      <div class="mt-4">
        <div class="text-[10px] font-black uppercase tracking-widest text-slate-400 mb-2">Último pedido</div>
        <div class="ticket-box">
          <div id="client-ticket" style="white-space: pre-wrap;"></div>
        </div>
      </div>

      <div class="mt-4 grid grid-cols-2 gap-3">
        <button onclick="clientGoTo()" class="btn-press py-3 rounded-xl font-black bg-green-600 text-white flex items-center justify-center gap-2">
          <i class="fas fa-location-crosshairs"></i> Ir a cliente
        </button>
        <button onclick="clientOpenTicket()" class="btn-press py-3 rounded-xl font-black bg-blue-600 text-white flex items-center justify-center gap-2">
          <i class="fas fa-receipt"></i> Ver ticket
        </button>
      </div>

      <div class="mt-3 grid grid-cols-2 gap-3">
        <button onclick="clientCopyAddress()" class="btn-press py-3 rounded-xl font-black bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-200 border border-slate-200 dark:border-slate-700 flex items-center justify-center gap-2">
          <i class="fas fa-copy"></i> Copiar dirección
        </button>
        <button onclick="closeClientModal()" class="btn-press py-3 rounded-xl font-black bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-200 border border-slate-200 dark:border-slate-700">
          Cerrar
        </button>
      </div>
    </div>
  </div>

  <!-- ✅ NUEVO: MODAL BUSCADOR (lista grande, opcional) -->
  <div id="modal-client-search" class="fixed inset-0 z-[84] bg-black/70 hidden items-center justify-center p-4 backdrop-blur-sm">
    <div class="bg-white dark:bg-slate-900 w-full sm:max-w-lg rounded-3xl p-6 shadow-2xl animate-pop border border-slate-200 dark:border-slate-700">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-[10px] font-black uppercase tracking-widest text-indigo-500">Buscador</p>
          <h3 class="text-lg font-black dark:text-white">Buscar cliente</h3>
          <p class="text-xs mt-1 text-slate-500 dark:text-slate-400">Escribí nombre, dirección o ID (en vivo).</p>
        </div>
        <button onclick="closeClientSearchModal()" class="w-10 h-10 rounded-xl bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 border border-slate-200 dark:border-slate-700">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="mt-4">
        <div class="flex items-center gap-2 bg-slate-100 dark:bg-slate-800 px-3 py-2 rounded-2xl border border-slate-200 dark:border-slate-700">
          <i class="fas fa-magnifying-glass text-slate-400"></i>
          <input id="q-client-modal" type="text" placeholder="Ej: 1234 / almacén / calle..." class="flex-1 bg-transparent border-0 text-sm dark:text-white outline-none" />
          <button class="btn-press px-3 py-2 rounded-xl bg-blue-600 text-white font-black text-xs" onclick="clientModalSearchNow()">BUSCAR</button>
        </div>
      </div>

      <div class="mt-4">
        <div class="text-[10px] font-black uppercase tracking-widest text-slate-400 mb-2">Resultados</div>
        <div id="client-search-list" class="max-h-72 overflow-y-auto no-scrollbar space-y-2"></div>
      </div>

      <div class="mt-5 grid grid-cols-2 gap-3">
        <button onclick="closeClientSearchModal()" class="btn-press py-3 rounded-xl font-black bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-200 border border-slate-200 dark:border-slate-700">
          Cerrar
        </button>
        <button onclick="closeClientSearchModal()" class="btn-press py-3 rounded-xl font-black bg-indigo-600 text-white flex items-center justify-center gap-2">
          <i class="fas fa-check"></i> Listo
        </button>
      </div>
    </div>
  </div>

  <script>
    // =========================
    // CONFIG / STATE
    // =========================
    const WORKER = 'https://frosty-term-20ea.santamariapablodaniel.workers.dev/';
    const OUTBOX_KEY = 'ml_outbox_v1';

    const CACHE_VER = 'v2';
    const APP_CACHE_TTL_MS = 1000 * 60 * 12; // 12 min
    const APP_CACHE_KEY = (v) => `ml_app_cache_${CACHE_VER}_${String(v||'GEN').toUpperCase()}`;
    const APP_CACHE_META_KEY = (v) => `ml_app_cache_meta_${CACHE_VER}_${String(v||'GEN').toUpperCase()}`;
    const ONBOARD_KEY = (v) => `ml_onboard_done_${CACHE_VER}_${String(v||'GEN').toUpperCase()}`;

    const WEEK_KEY = (v) => `ml_week_progress_${CACHE_VER}_${String(v||'GEN').toUpperCase()}`; // {weekId, zones:{ZONA:{ts,turno,motivo}}}
    const ZONE_LAST_KEY = (v) => `ml_zone_last_${CACHE_VER}_${String(v||'GEN').toUpperCase()}`;

    const state = {
      user: JSON.parse(localStorage.getItem('ml_user')),
      db: {},
      route: { active: [], done: new Set(), currentZones: [] },
      sel: new Set(),
      mode: 'list',
      cliId: null,
      tempReason: null,
      location: null,
      currentOrder: { title: '', ticket: '' },
      outboxFlushing: false,
      jornada: { activa:false, jornadaId:null, turno:null, zonas:[] },

      // ✅ NUEVO: buscador + cliente modal
      search: { ddOpen:false, ddItems:[], lastQ:'', busy:false, t:null },
      clientView: { id:null, cliente:null, ultimoPedido:null, ticket:'' }
    };

    const el = id => document.getElementById(id);

    const toast = (m, t) => {
      const d = el('toast');
      if (!d) return;
      d.innerHTML = t === 'error'
        ? `<i class="fas fa-exclamation-circle text-red-400"></i> ${m}`
        : `<i class="fas fa-check-circle text-green-400"></i> ${m}`;
      d.style.opacity = 1;
      d.style.top = '30px';
      setTimeout(() => { d.style.opacity = 0; d.style.top = '20px'; }, 2400);
    };

    async function api(act, pl, timeoutMs=20000) {
      const ctrl = new AbortController();
      const to = setTimeout(() => ctrl.abort(), timeoutMs);
      try {
        const r = await fetch(WORKER, { method: 'POST', body: JSON.stringify({ action: act, payload: pl }), signal: ctrl.signal });
        const j = await r.json();
        if (j.status !== 'success') throw new Error(j.message || 'Error');
        return j.data;
      } finally {
        clearTimeout(to);
      }
    }

    // =========================
    // BOOT
    // =========================
    document.addEventListener('DOMContentLoaded', () => {
      if (localStorage.getItem('ml_theme') === 'light') document.documentElement.classList.remove('dark');

      // Enter para login
      el('login-user')?.addEventListener('keydown', (e)=>{ if (e.key === 'Enter') el('login-pass')?.focus(); });
      el('login-pass')?.addEventListener('keydown', (e)=>{ if (e.key === 'Enter') handleLogin(); });

      // chat enter
      el('chat-in')?.addEventListener('keydown', (e) => { if (e.key === 'Enter') sendChat(); });

      // ✅ NUEVO: buscador en vivo (dropdown + modal)
      initClientSearchUX_();

      // geoloc
      if (navigator.geolocation) navigator.geolocation.watchPosition(updateDistances, null, { enableHighAccuracy: true });

      // fast offline sync
      window.addEventListener('online', () => flushOutbox());
      setTimeout(() => flushOutbox(), 1200);

      // daily boundary
      ensureDailyBoundaryReset_();

      if (state.user) init(); else switchView('view-login');
    });

    // =========================
    // Utils: Dates / Keys
    // =========================
    function normKey(s) { return String(s || '').trim().toUpperCase(); }
    function todayKey_() {
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${dd}`;
    }
    function weekId_() {
      // ISO week approx
      const d = new Date();
      d.setHours(0,0,0,0);
      d.setDate(d.getDate() + 3 - ((d.getDay() + 6) % 7));
      const week1 = new Date(d.getFullYear(), 0, 4);
      const w = 1 + Math.round(((d.getTime() - week1.getTime()) / 86400000 - 3 + ((week1.getDay() + 6) % 7)) / 7);
      return `${d.getFullYear()}-W${String(w).padStart(2,'0')}`;
    }
    function turnoNow_() {
      const h = new Date().getHours();
      return (h >= 14) ? 'Tarde' : 'Mañana';
    }
    function setTurnoChip_() {
      const c = el('chip-turno');
      if (!c) return;
      const t = turnoNow_();
      c.innerHTML = (t === 'Tarde')
        ? `<i class="fas fa-moon"></i> TURNO: TARDE`
        : `<i class="fas fa-sun"></i> TURNO: MAÑANA`;
    }

    function parseDateValue(v) {
      if (v == null) return null;
      if (typeof v === 'number' && isFinite(v)) {
        const ms = v < 1e12 ? v * 1000 : v;
        const d = new Date(ms);
        return isNaN(d.getTime()) ? null : d;
      }
      const s = String(v).trim();
      if (!s) return null;
      const iso = new Date(s);
      if (!isNaN(iso.getTime())) return iso;

      const m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{2,4})(?:\s+(\d{1,2}):(\d{2})(?::(\d{2}))?)?$/);
      if (m) {
        const dd = Number(m[1]), mm = Number(m[2]) - 1, yy = Number(m[3]) < 100 ? 2000 + Number(m[3]) : Number(m[3]);
        const HH = Number(m[4] || 0), MI = Number(m[5] || 0), SS = Number(m[6] || 0);
        const d = new Date(yy, mm, dd, HH, MI, SS);
        return isNaN(d.getTime()) ? null : d;
      }
      return null;
    }

    function fmtDateTime(d, mode='short') {
      if (!(d instanceof Date) || isNaN(d.getTime())) return '—';
      const dd = String(d.getDate()).padStart(2,'0');
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const HH = String(d.getHours()).padStart(2,'0');
      const MI = String(d.getMinutes()).padStart(2,'0');
      if (mode === 'date') return `${dd}/${mm}`;
      return `${dd}/${mm} ${HH}:${MI}`;
    }

    // =========================
    // Cache app data (instant load)
    // =========================
    function getAppCache_(v) {
      try {
        const raw = localStorage.getItem(APP_CACHE_KEY(v));
        return raw ? JSON.parse(raw) : null;
      } catch (_) { return null; }
    }
    function setAppCache_(v, data) {
      try {
        localStorage.setItem(APP_CACHE_KEY(v), JSON.stringify(data || {}));
        localStorage.setItem(APP_CACHE_META_KEY(v), JSON.stringify({ ts: Date.now(), day: todayKey_() }));
      } catch (_) {}
    }
    function isAppCacheFresh_(v) {
      try {
        const meta = JSON.parse(localStorage.getItem(APP_CACHE_META_KEY(v)) || '{}');
        if (!meta || meta.day !== todayKey_()) return false;
        return (Date.now() - Number(meta.ts || 0)) <= APP_CACHE_TTL_MS;
      } catch (_) { return false; }
    }

    // =========================
    // Weekly progress (persist)
    // =========================
    function getWeekProgress_() {
      const v = state.user?.vendedor ?? state.user?.user ?? 'GEN';
      try {
        const raw = localStorage.getItem(WEEK_KEY(v));
        const obj = raw ? JSON.parse(raw) : null;
        const wid = weekId_();
        if (!obj || obj.weekId !== wid) return { weekId: wid, zones: {} };
        if (!obj.zones || typeof obj.zones !== 'object') obj.zones = {};
        return obj;
      } catch (_) {
        return { weekId: weekId_(), zones: {} };
      }
    }
    function setWeekProgress_(obj) {
      const v = state.user?.vendedor ?? state.user?.user ?? 'GEN';
      try { localStorage.setItem(WEEK_KEY(v), JSON.stringify(obj || { weekId: weekId_(), zones: {} })); } catch (_) {}
    }
    function markWeekZone_(zoneName, motivo='OK') {
      const z = normKey(zoneName);
      if (!z) return;
      const wk = getWeekProgress_();
      wk.zones[z] = { ts: Date.now(), turno: turnoNow_(), motivo: String(motivo||'') };
      setWeekProgress_(wk);
    }

    // =========================
    // Zone last cache (per vendor)
    // =========================
    function zoneLastStorageKey() {
      const v = state.user?.vendedor ?? state.user?.user ?? 'GEN';
      return ZONE_LAST_KEY(v);
    }
    function getZoneLastMap() {
      try {
        const raw = localStorage.getItem(zoneLastStorageKey());
        const obj = raw ? JSON.parse(raw) : {};
        return (obj && typeof obj === 'object') ? obj : {};
      } catch (_) {
        return {};
      }
    }
    function setZoneLastMap(map) {
      try { localStorage.setItem(zoneLastStorageKey(), JSON.stringify(map || {})); } catch (_) {}
    }

    function getZoneLastInfo(zoneName, backendFallbackObj) {
      const zKey = normKey(zoneName);
      const map = getZoneLastMap();
      if (map[zKey]) return map[zKey];

      const bf = backendFallbackObj || {};
      const candidates = [ bf.ultima_visita_ts, bf.ultima_visita, bf.ultima, bf.last_ts ];
      for (const c of candidates) {
        const d = parseDateValue(c);
        if (d) return { ts: d.getTime(), motivo: bf.ultima_motivo || bf.motivo || '', tipo: bf.ultima_tipo || bf.tipo || '' };
      }
      return null;
    }

    function touchZoneLast(zoneName, tipo, motivo) {
      const zKey = normKey(zoneName);
      if (!zKey) return;

      const map = getZoneLastMap();
      map[zKey] = { ts: Date.now(), tipo: String(tipo||''), motivo: String(motivo||'') };
      setZoneLastMap(map);

      document.querySelectorAll('[data-zone-key]').forEach(card => {
        if (card?.dataset?.zoneKey === zKey) {
          const lastEl = card.querySelector('.zone-last');
          const motEl = card.querySelector('.zone-last-motivo');
          if (lastEl) lastEl.textContent = fmtDateTime(new Date(map[zKey].ts), 'short');
          if (motEl) motEl.textContent = map[zKey].motivo ? `· ${map[zKey].motivo}` : '';
        }
      });
    }

    function getClientZoneKey(cli) { return normKey(cli?.localidad_key || cli?.localidad || ''); }

    // =========================
    // Base
    // =========================
    function displayName(cli) {
      if (!cli) return '';
      const a = String(cli.apellido || '').trim();
      const n = String(cli.nombre || '').trim();
      const full = String(cli.nombre_full || '').trim();
      const merged = [n, a].filter(Boolean).join(' ').trim();
      return (full || merged || n || a || 'SIN NOMBRE').trim();
    }

    function toggleTheme() {
      const html = document.documentElement;
      if (html.classList.contains('dark')) { html.classList.remove('dark'); localStorage.setItem('ml_theme', 'light'); }
      else { html.classList.add('dark'); localStorage.setItem('ml_theme', 'dark'); }
    }

    function switchView(id) {
      document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
      el(id)?.classList.add('active');
    }

    async function handleLogin() {
      const u = el('login-user')?.value?.trim(), p = el('login-pass')?.value?.trim();
      if (!u || !p) return toast('Faltan datos', 'error');
      el('loader')?.classList.remove('hidden');
      try {
        const d = await api('login', { user: u, pass: p }, 25000);
        state.user = d;
        localStorage.setItem('ml_user', JSON.stringify(d));
        init();
      } catch (e) {
        toast(e.message, 'error');
      } finally {
        el('loader')?.classList.add('hidden');
      }
    }
    function logout() { localStorage.removeItem('ml_user'); location.reload(); }

    // =========================
    // Daily reset boundary
    // =========================
    function ensureDailyBoundaryReset_() {
      const key = 'ml_day_key';
      const today = todayKey_();
      const prev = localStorage.getItem(key);
      if (prev !== today) {
        // reset only daily ephemeral things
        try {
          localStorage.setItem(key, today);
          localStorage.removeItem(OUTBOX_KEY); // opcional: si preferís mantener cola, comentá esta línea
          // NO tocamos week progress
        } catch (_) {}
      }
      // schedule check (every 2 minutes)
      setInterval(() => {
        const t = todayKey_();
        const p = localStorage.getItem(key);
        if (p !== t) location.reload();
      }, 120000);
    }

    // =========================
    // INIT (instant cache + refresh)
    // =========================
    async function init() {
      switchView('view-dashboard');
      el('lbl-saludo').innerText = (state.user?.user || '').toUpperCase();
      setTurnoChip_();

      // 1) instant render from cache if exists
      const vend = state.user?.vendedor;
      const cached = getAppCache_(vend);
      if (cached && cached.zonas && cached.clientes) {
        state.db = cached;
        renderGrid(true);
      } else {
        // skeleton
        renderGridSkeleton_();
      }

      // 2) refresh in background (fast)
      el('loader')?.classList.remove('hidden');
      try {
        const d = await api('get_app_data', { vendedor: vend }, 25000);
        state.db = d || {};
        setAppCache_(vend, state.db);
        renderGrid(false);

        // sugerencias IA
        if (d?.sugerencia_ia?.sugerencias?.rutas_sugeridas?.length) showSuggestions(d.sugerencia_ia.sugerencias.rutas_sugeridas);

        // jornada activa backend
        if (d?.jornada_activa?.activa) {
          state.jornada = {
            activa: true,
            jornadaId: d.jornada_activa.jornadaId,
            turno: d.jornada_activa.turno,
            zonas: d.jornada_activa.zonas || []
          };
        } else {
          state.jornada = { activa:false, jornadaId:null, turno: turnoNow_(), zonas: [] };
        }
        updateChatSub_();

        // onboard first time
        maybeShowOnboard_();

        flushOutbox();
      } catch (e) {
        toast('Error cargando (usando cache)', 'error');
      } finally {
        el('loader')?.classList.add('hidden');
      }
    }

    function updateChatSub_() {
      const s = el('chat-sub');
      if (!s) return;
      const t = turnoNow_();
      const j = state.jornada?.activa ? `Jornada activa (${state.jornada.turno})` : `Sin jornada`;
      s.textContent = `${t} · ${j}`;
    }

    function renderGridSkeleton_() {
      const g = el('zones-grid'); if (!g) return;
      g.innerHTML = '';
      for (let i=0;i<6;i++){
        const d = document.createElement('div');
        d.className = 'p-4 rounded-2xl border bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700 shadow-sm skeleton h-28';
        g.appendChild(d);
      }
    }

    function renderGrid(fromCache=false) {
      const g = el('zones-grid'); if (!g) return;
      g.innerHTML = '';

      const wk = getWeekProgress_();
      const doneMap = wk?.zones || {};

      (state.db.zonas || []).forEach(z => {
        const crit = Number(z.criticos || 0) > 0;
        const zName = String(z.nombre || '');
        const zKey = normKey(zName);

        const info = getZoneLastInfo(zName, z);
        const lastText = info?.ts ? fmtDateTime(new Date(info.ts), 'short') : '—';
        const lastMot = info?.motivo ? `· ${String(info.motivo)}` : '';

        // week badge
        const wkInfo = doneMap[zKey] || null;
        const wkTxt = wkInfo?.ts ? `Semana: ${fmtDateTime(new Date(wkInfo.ts),'short')} · ${wkInfo.turno || ''}` : '';

        const d = document.createElement('div');
        d.dataset.zoneKey = zKey;
        d.className = `p-4 rounded-2xl border transition-all cursor-pointer relative overflow-hidden bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700 shadow-sm hover:border-blue-500`;
        d.onclick = () => toggleSel(zName, d);

        d.innerHTML = `
          <h3 class="font-bold text-sm uppercase dark:text-white truncate">${escapeHtml(zName)}</h3>

          <div class="flex justify-between items-end mt-3">
            <span class="text-xs text-slate-500 font-medium bg-slate-100 dark:bg-slate-700 px-2 py-1 rounded-lg">${escapeHtml(String(z.total_clientes || 0))} Clientes</span>
            ${crit ? '<i class="fas fa-exclamation-circle text-red-500 animate-pulse"></i>' : '<i class="fas fa-map-pin text-slate-300"></i>'}
          </div>

          <div class="zone-meta">
            <div class="zone-last-row">
              <span class="zone-last-label">ÚLTIMA</span>
              <span class="zone-last">${escapeHtml(lastText)}</span>
              <span class="zone-last-motivo">${escapeHtml(lastMot)}</span>
            </div>
            ${wkTxt ? `
              <div class="text-[10px] font-black uppercase tracking-widest mt-1 text-emerald-600 dark:text-emerald-400">
                <i class="fas fa-check-circle"></i> ${escapeHtml(wkTxt)}
              </div>` : `
              <div class="text-[10px] font-black uppercase tracking-widest mt-1 text-slate-400">
                <i class="far fa-circle"></i> Semana: pendiente
              </div>`}
          </div>

          <div class="sel-overlay absolute top-2 right-2 hidden"><i class="fas fa-check-circle text-blue-600 text-xl bg-white rounded-full"></i></div>
          <div class="sel-border absolute inset-0 border-2 border-blue-600 rounded-2xl hidden pointer-events-none"></div>
          ${fromCache ? `<div class="absolute bottom-2 right-2 text-[9px] font-black uppercase tracking-widest text-slate-400">cache</div>` : ``}
        `;
        g.appendChild(d);
      });
    }

    function toggleSel(n, div) {
      const ov = div.querySelector('.sel-overlay'), bd = div.querySelector('.sel-border');
      if (state.sel.has(n)) { state.sel.delete(n); ov.classList.add('hidden'); bd.classList.add('hidden'); }
      else { state.sel.add(n); ov.classList.remove('hidden'); bd.classList.remove('hidden'); }
      const c = state.sel.size;
      el('footer-dashboard')?.classList.toggle('hidden', c === 0);
      if (el('btn-start-lbl')) el('btn-start-lbl').innerText = `INICIAR (${c})`;
    }

    // =========================
    // ✅ NUEVO: buscador live + lookup + modales
    // =========================
    function initClientSearchUX_() {
      const inp = el('q-client');
      const dd = el('q-dd');

      // Enter en buscador -> IR
      inp?.addEventListener('keydown', (e)=>{ if (e.key === 'Enter') searchClientById(); });

      // Live search (debounce)
      inp?.addEventListener('input', () => {
        const q = String(inp.value || '').trim();
        state.search.lastQ = q;
        if (state.search.t) clearTimeout(state.search.t);

        state.search.t = setTimeout(async () => {
          await liveSearchRender_(q);
        }, 180);
      });

      // Click fuera -> cerrar dropdown
      document.addEventListener('click', (ev) => {
        const t = ev.target;
        const root = inp?.closest('.relative');
        if (!root) return;
        if (root.contains(t)) return;
        hideSearchDropdown_();
      });

      // Modal search input
      el('q-client-modal')?.addEventListener('input', () => {
        const q = String(el('q-client-modal').value || '').trim();
        if (state.search.t) clearTimeout(state.search.t);
        state.search.t = setTimeout(async () => {
          await renderClientSearchList_(q);
        }, 180);
      });
      el('q-client-modal')?.addEventListener('keydown', (e)=>{ if (e.key === 'Enter') clientModalSearchNow(); });
    }

    async function liveSearchRender_(q) {
      const dd = el('q-dd');
      if (!dd) return;

      const query = String(q || '').trim();
      if (!query || query.length < 2) return hideSearchDropdown_();

      // Si es solo números y >=4, igual hacemos live (devuelve 1-2)
      let items = [];
      try {
        // Online -> backend
        if (navigator.onLine && state.user?.vendedor) {
          const res = await api('clientes_search', { vendedor: state.user.vendedor, q: query, limit: 8 }, 12000);
          items = res?.items || [];
        } else {
          // Offline -> fallback local (cache)
          items = localSearchFallback_(query, 8);
        }
      } catch (_) {
        // fallback local
        items = localSearchFallback_(query, 8);
      }

      if (!items.length) return hideSearchDropdown_();

      dd.innerHTML = '';
      items.forEach(it => {
        const row = document.createElement('div');
        row.className = 'search-dd-row';
        row.onclick = () => {
          hideSearchDropdown_();
          lookupAndOpenClient_(String(it.id || '').trim());
        };

        const title = `#${String(it.id||'')} ${String(it.nombre_full || it.nombre || '').trim() || 'SIN NOMBRE'}`;
        const sub = `${String(it.direccion || '').trim()} · ${String(it.localidad || '').trim()}`;

        row.innerHTML = `
          <div class="min-w-0">
            <div class="search-dd-title truncate">${escapeHtml(title)}</div>
            <div class="search-dd-sub truncate">${escapeHtml(sub)}</div>
          </div>
          <div class="text-blue-600 dark:text-blue-400 font-black text-xs"><i class="fas fa-arrow-right"></i></div>
        `;
        dd.appendChild(row);
      });

      dd.classList.remove('hidden');
      state.search.ddOpen = true;
    }

    function hideSearchDropdown_() {
      const dd = el('q-dd');
      if (!dd) return;
      dd.classList.add('hidden');
      dd.innerHTML = '';
      state.search.ddOpen = false;
    }

    function localSearchFallback_(q, limit=8) {
      const query = _normText_(String(q||''));
      if (!query) return [];
      const list = state.db?.clientes || [];
      const out = [];
      for (const c of list) {
        const hay = _normText_(`${c.id} ${c.nombre_full || ''} ${c.nombre || ''} ${c.apellido || ''} ${c.direccion || ''} ${c.localidad || ''}`);
        if (!hay.includes(query)) continue;
        out.push({
          id: c.id,
          nombre_full: c.nombre_full,
          nombre: c.nombre,
          apellido: c.apellido,
          direccion: c.direccion,
          localidad: c.localidad
        });
        if (out.length >= limit) break;
      }
      return out;
    }

    async function lookupAndOpenClient_(clienteId) {
      const cid = String(clienteId || '').trim();
      if (!cid) return;

      el('loader')?.classList.remove('hidden');
      try {
        // Prefer backend lookup (seguro por vendedor + ticket)
        const res = await api('cliente_lookup', { vendedor: state.user.vendedor, clienteId: cid }, 20000);
        const cli = res?.cliente || null;
        const ult = res?.ultimoPedido || null;
        const ticket = String(res?.ticket || '');

        // ✅ Inyectamos en cache local para poder "Ir a cliente"
        if (cli) upsertClientInLocalDB_(cli);

        openClientModal_(cid, cli, ult, ticket);
      } catch (e) {
        // Fallback: buscar en cache local (sin ticket seguro)
        const cli = (state.db?.clientes || []).find(c => String(c.id) === cid) || null;
        if (!cli) {
          toast(e?.message || 'No pude buscar (sin señal / no está en cache)', 'error');
          return;
        }
        openClientModal_(cid, cli, null, '');
        toast('Modo offline: sin ticket (podés pedirlo al chat)', 'error');
      } finally {
        el('loader')?.classList.add('hidden');
      }
    }

    function upsertClientInLocalDB_(cli) {
      if (!cli) return;
      if (!state.db) state.db = {};
      if (!Array.isArray(state.db.clientes)) state.db.clientes = [];

      // normalizamos shape mínimo como el resto del front
      const normalized = {
        id: String(cli.id || cli.NumeroCliente || cli.numeroCliente || cli.Numero || cli.numero || cli.clienteId || cli.ClienteId || ''),
        nombre: cli.nombre || cli.Nombre || '',
        apellido: cli.apellido || cli.Apellido || '',
        nombre_full: cli.nombre_full || cli.nombreFull || cli.NombreCompleto || cli.nombreCompleto || cli.nombre || '',
        direccion: cli.direccion || cli.Domicilio || cli.domicilio || '',
        localidad: cli.localidad || cli.Localidad || '',
        localidad_key: normKey(cli.localidad_key || cli.localidad || cli.Localidad || ''),
        lat: cli.lat ?? cli.Lat ?? '',
        lng: cli.lng ?? cli.Lng ?? '',
        vendedor: cli.vendedor || cli.Vendedor || ''
      };

      if (!normalized.id) return;

      const idx = state.db.clientes.findIndex(x => String(x.id) === String(normalized.id));
      if (idx >= 0) state.db.clientes[idx] = { ...state.db.clientes[idx], ...normalized };
      else state.db.clientes.unshift(normalized);
    }

    function openClientModal_(cid, cli, ult, ticket) {
      state.clientView = { id: String(cid||''), cliente: cli || null, ultimoPedido: ult || null, ticket: String(ticket||'') };

      const name = cli ? displayName(cli) : `#${cid}`;
      const loc = cli?.localidad || cli?.Localidad || '';
      const dir = cli?.direccion || cli?.Domicilio || cli?.domicilio || '';

      el('client-title').textContent = String(name || '').toUpperCase();
      el('client-sub').textContent = loc ? `Zona: ${String(loc).toUpperCase()}` : '—';

      el('client-id').textContent = `#${cid}`;
      el('client-zone').textContent = String(loc || '—').toUpperCase();
      el('client-address').textContent = String(dir || '—');

      let t = String(ticket || '').trim();
      if (!t) {
        // si no hay ticket pero hay ultimo pedido
        if (ult?.fechaFmt || ult?.fechaISO || ult?.productos) {
          const fecha = ult?.fechaFmt || ult?.fechaISO || '';
          const prod = ult?.productos || '';
          t = `🧾 ÚLTIMO PEDIDO\nCliente: #${cid} ${name}\nLocalidad: ${loc}\nFecha: ${fecha}\n\n${prod || '(Sin detalle de productos)'}`;
        } else {
          t = '(Sin ticket disponible. Si estás offline, pedilo por el chat.)';
        }
      }
      el('client-ticket').textContent = t;

      const m = el('modal-client');
      m.classList.remove('hidden');
      m.classList.add('flex');
    }

    function closeClientModal() {
      const m = el('modal-client');
      m.classList.add('hidden');
      m.classList.remove('flex');
    }

    function clientGoTo() {
      const id = String(state.clientView?.id || '').trim();
      if (!id) return;
      closeClientModal();
      goToClient(id);
    }

    function clientOpenTicket() {
      const id = String(state.clientView?.id || '').trim();
      const cli = state.clientView?.cliente || null;
      const name = cli ? displayName(cli) : `#${id}`;
      const ticket = String(state.clientView?.ticket || el('client-ticket')?.textContent || '');

      // si no hay ticket real, disparo chat
      if (!ticket || ticket.includes('Sin ticket')) {
        closeClientModal();
        toggleAIChat(true);
        setTimeout(()=> {
          el('chat-in').value = `Último pedido del cliente ${name} #${id}`;
          sendChat();
        }, 250);
        return;
      }

      openOrderModal(`#${id} ${name}`, ticket);
    }

    function clientCopyAddress() {
      const txt = String(el('client-address')?.textContent || '').trim();
      if (!txt || txt === '—') return toast('Sin dirección', 'error');
      copyPlainText(txt);
      toast('Dirección copiada', 'success');
    }

    function openClientSearchModal() {
      const m = el('modal-client-search');
      m.classList.remove('hidden');
      m.classList.add('flex');
      setTimeout(()=> el('q-client-modal')?.focus(), 150);

      // precarga con lo que ya escribió
      const q = String(el('q-client')?.value || '').trim();
      if (q) {
        el('q-client-modal').value = q;
        renderClientSearchList_(q);
      } else {
        renderClientSearchList_('');
      }
    }

    function closeClientSearchModal() {
      const m = el('modal-client-search');
      m.classList.add('hidden');
      m.classList.remove('flex');
    }

    function clientModalSearchNow() {
      const q = String(el('q-client-modal')?.value || '').trim();
      renderClientSearchList_(q);
    }

    async function renderClientSearchList_(q) {
      const list = el('client-search-list');
      if (!list) return;

      const query = String(q || '').trim();
      list.innerHTML = '';

      if (!query || query.length < 2) {
        list.innerHTML = `
          <div class="p-4 rounded-2xl border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 text-sm font-bold text-slate-500 dark:text-slate-300">
            Escribí al menos 2 letras o números.
          </div>`;
        return;
      }

      let items = [];
      try {
        if (navigator.onLine) {
          const res = await api('clientes_search', { vendedor: state.user.vendedor, q: query, limit: 20 }, 15000);
          items = res?.items || [];
        } else {
          items = localSearchFallback_(query, 20);
        }
      } catch (_) {
        items = localSearchFallback_(query, 20);
      }

      if (!items.length) {
        list.innerHTML = `
          <div class="p-4 rounded-2xl border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 text-sm font-bold text-slate-500 dark:text-slate-300">
            No encontré resultados.
          </div>`;
        return;
      }

      items.forEach(it => {
        const row = document.createElement('div');
        row.className = 'p-3 rounded-2xl border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 flex items-center justify-between gap-3 cursor-pointer btn-press';
        row.onclick = () => {
          closeClientSearchModal();
          lookupAndOpenClient_(String(it.id||'').trim());
        };

        const title = `#${String(it.id||'')} ${(String(it.nombre_full || it.nombre || '').trim() || 'SIN NOMBRE').toUpperCase()}`;
        const sub = `${String(it.direccion || '').trim()} · ${String(it.localidad || '').trim()}`;

        row.innerHTML = `
          <div class="min-w-0">
            <div class="font-black text-sm truncate dark:text-white">${escapeHtml(title)}</div>
            <div class="text-[11px] font-bold text-slate-500 dark:text-slate-400 truncate">${escapeHtml(sub)}</div>
          </div>
          <div class="text-blue-600 dark:text-blue-400 font-black text-xs"><i class="fas fa-arrow-right"></i></div>
        `;
        list.appendChild(row);
      });
    }

    // =========================
    // Search client (MISMA FUNCIÓN, ahora mejor)
    // =========================
    async function searchClientById() {
      const q = el('q-client')?.value?.trim();
      if (!q) return;

      // ✅ 1) Si parece ID (4-6 dígitos), uso lookup seguro (backend)
      if (/^\d{4,6}$/.test(q) && state.user?.vendedor) {
        hideSearchDropdown_();
        await lookupAndOpenClient_(q);
        return;
      }

      // ✅ 2) Si no es sólo ID, abro modal de búsqueda con query
      openClientSearchModal();
      el('q-client-modal').value = q;
      renderClientSearchList_(q);

      // -----------------------
      // LEGACY (no lo borro):
      // -----------------------
      // const cli = (state.db?.clientes || []).find(c => String(c.id) === String(q));
      // if (!cli) return toast('No lo tengo cargado. (Cargá su zona)', 'error');
      // state.sel = new Set([String(cli.localidad_key || cli.localidad || '').toUpperCase()]);
      // startRoute();
      // setTimeout(() => {
      //   state.route.active = state.route.active.filter(c => String(c.id) !== String(q));
      //   state.route.active.unshift(cli);
      //   state.route.done.delete(String(q));
      //   renderRoute();
      //   toast(`Cliente #${q} al frente`, 'success');
      // }, 50);
    }

    // =========================
    // Start route + jornada sync
    // =========================
    async function startRoute() {
      const k = Array.from(state.sel).map(x => String(x));
      if (!k.length) return;

      // reset route state
      state.route.done = new Set();
      state.route.currentZones = k.map(normKey);

      const all = (state.db.clientes || []);
      const selected = new Set(k.map(normKey));
      state.route.active = all.filter(c => selected.has(normKey(c.localidad_key)));

      // start jornada backend (si existe)
      // NOTE: no bloquea UI; si falla, no rompe
      (async () => {
        try {
          const resp = await api('start_jornada', { vendedor: state.user.vendedor, zonas: k }, 20000);
          if (resp && resp.activa) {
            state.jornada = { activa:true, jornadaId: resp.jornadaId, turno: resp.turno, zonas: resp.zonas || k };
            updateChatSub_();
          }
        } catch (_) {}
      })();

      switchView('view-route');
      renderRoute();

      // persist week as "en curso" no, solo al marcar eventos.
      toast(`Ruta lista: ${k.length} zona(s)`, 'success');
    }

    // =========================
    // Suggestions
    // =========================
    function showSuggestions(list) {
      const c = el('suggestions-list'); if (!c) return;
      c.innerHTML = '';
      list.forEach(loc => {
        const b = document.createElement('div');
        b.className = 'w-full p-3 rounded-xl bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 flex justify-between items-center mb-2 cursor-pointer';
        b.onclick = function () {
          const i = this.querySelector('i');
          if (state.sel.has(loc)) { state.sel.delete(loc); i.className = 'far fa-circle text-slate-400 text-lg'; this.classList.remove('border-blue-500'); }
          else { state.sel.add(loc); i.className = 'fas fa-check-circle text-blue-600 text-lg'; this.classList.add('border-blue-500'); }
        };
        b.innerHTML = `<span class="font-bold text-sm dark:text-white">${escapeHtml(String(loc))}</span><i class="far fa-circle text-slate-400 text-lg"></i>`;
        c.appendChild(b);
      });
      el('modal-suggestions')?.classList.remove('hidden');
    }

    function applySuggestions() {
      if (state.sel.size > 0) startRoute();
      el('modal-suggestions')?.classList.add('hidden');
    }

    // =========================
    // Route render
    // =========================
    function renderRoute() {
      const c = el('route-container'); if (!c) return;
      c.innerHTML = '';

      const pends = (state.route.active || []).filter(x => !state.route.done.has(String(x.id)));

      const rc = el('route-count');
      if (rc) rc.innerText = pends.length;

      if (!pends.length) {
        c.innerHTML = `
          <div class="text-center mt-20 opacity-60">
            <i class="fas fa-clipboard-check text-6xl text-slate-300 mb-4"></i>
            <h3 class="text-xl font-bold dark:text-white">¡Ruta Completada!</h3>
            <p class="text-xs mt-2 text-slate-400">Si te faltó alguien, usá el botón <b>No llegué</b> antes de finalizar.</p>
          </div>
        `;
        return;
      }

      const list = state.mode === 'focus' ? [pends[0]] : pends;

      list.forEach((cli) => {
        const days = Number(cli.dias_sin_comprar ?? 999);
        let col = days > 60 ? 'bg-red-500' : (days > 30 ? 'bg-yellow-500' : 'bg-green-500');

        const name = displayName(cli).toUpperCase();

        const div = document.createElement('div'); div.id = `card-${cli.id}`;
        div.className = state.mode === 'focus'
          ? 'h-[70vh] flex flex-col justify-between bg-white dark:bg-slate-900 p-6 rounded-3xl border border-slate-200 dark:border-slate-700 relative overflow-hidden shadow-xl'
          : 'bg-white dark:bg-slate-900 p-4 rounded-2xl border border-slate-200 dark:border-slate-700 relative shadow-sm';

        div.innerHTML = `
          <div class="absolute left-0 top-0 bottom-0 w-1.5 ${col}"></div>
          <div class="flex justify-between pl-3 mb-1">
            <span class="text-[10px] font-bold text-slate-400 uppercase">#${escapeHtml(String(cli.id))}</span>
            <span class="text-[10px] bg-slate-100 dark:bg-slate-800 px-2 py-0.5 rounded text-slate-500 font-bold">${escapeHtml(String(days))} días</span>
          </div>
          <h2 class="${state.mode === 'focus' ? 'text-3xl' : 'text-lg'} font-black uppercase leading-tight dark:text-white pl-3">${escapeHtml(name)}</h2>
          <p class="text-slate-500 text-xs mt-1 truncate pl-3 flex items-center gap-1"><i class="fas fa-location-dot text-slate-300"></i> ${escapeHtml(String(cli.direccion || ''))}</p>
          <div id="dist-${cli.id}" class="text-xs font-bold text-blue-600 mt-3 h-4 pl-3" data-lat="${escapeHtml(String(cli.lat || ''))}" data-lng="${escapeHtml(String(cli.lng || ''))}">...</div>
          <div class="grid grid-cols-4 gap-2 mt-4 pl-3">
            <button onclick="quickSale('${escapeAttr(String(cli.id))}')" class="col-span-3 bg-slate-900 dark:bg-blue-600 py-3 rounded-xl font-bold text-white shadow-md active:scale-95 flex justify-center items-center gap-2"><i class="fas fa-check"></i> Venta</button>
            <button onclick="openReg('${escapeAttr(String(cli.id))}')" class="col-span-1 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-600 dark:text-white rounded-xl active:scale-95"><i class="fas fa-ellipsis-h"></i></button>
          </div>
          <div class="mt-3 pl-3 flex gap-2">
            <button onclick="openChatWithClientHint('${escapeAttr(String(cli.id))}')" class="btn-press flex-1 py-2 rounded-xl font-black text-xs bg-indigo-600 text-white flex items-center justify-center gap-2">
              <i class="fas fa-headset"></i> Pedir guión
            </button>
            <button onclick="openOrderFromClient('${escapeAttr(String(cli.id))}')" class="btn-press flex-1 py-2 rounded-xl font-black text-xs bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-200 border border-slate-200 dark:border-slate-700 flex items-center justify-center gap-2">
              <i class="fas fa-receipt"></i> Último pedido
            </button>
          </div>
        `;
        c.appendChild(div);
      });

      updateDistances();
    }

    function updateDistances(pos) {
      if (pos) state.location = { lat: pos.coords.latitude, lng: pos.coords.longitude };
      if (!state.location) return;

      document.querySelectorAll('[id^="dist-"]').forEach(node => {
        const lat = node.getAttribute('data-lat'), lng = node.getAttribute('data-lng');
        if (lat && lng && isFinite(Number(lat)) && isFinite(Number(lng))) {
          const km = parseFloat(getKm(state.location.lat, state.location.lng, Number(lat), Number(lng)));
          if (!isFinite(km)) { node.innerHTML = ''; return; }
          node.innerHTML = `<i class="fas fa-route"></i> ${km.toFixed(1)} km <span class="text-slate-400 font-normal ml-2">~${Math.round((km / 20) * 60)} min</span>`;
        } else {
          node.innerHTML = '';
        }
      });
    }

    function getKm(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat / 2) * Math.sin(dLat / 2)
              + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
      return (R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a))).toFixed(1);
    }

    function toggleViewMode() {
      state.mode = state.mode === 'list' ? 'focus' : 'list';
      const ic = el('icon-view-mode');
      if (ic) ic.className = state.mode === 'list' ? 'fas fa-list' : 'fas fa-crosshairs';
      renderRoute();
    }

    // =========================
    // Registros (optimistic + batch)
    // =========================
    function openReg(id) {
      state.cliId = id;
      state.tempReason = null;
      const c = (state.db.clientes || []).find(x => String(x.id) == String(id));
      el('reg-title').innerText = displayName(c).toUpperCase();
      el('reg-obs').value = '';

      let info = `<span class="text-green-600 font-bold">Cliente Activo</span>`;
      if (c && Number(c.dias_sin_comprar) > 60) info = `<span class="text-red-500 font-bold bg-red-50 px-2 py-1 rounded border border-red-100">⚠️ CRÍTICO: +60 DÍAS</span>`;
      el('reg-info').innerHTML = info;
      el('modal-reg').classList.remove('hidden');

      document.querySelectorAll('.reason-btn').forEach(btn => btn.classList.remove('ring-2', 'ring-blue-500'));
    }

    function selectReason(r, b) {
      state.tempReason = r;
      document.querySelectorAll('.reason-btn').forEach(btn => btn.classList.remove('ring-2', 'ring-blue-500'));
      b.classList.add('ring-2', 'ring-blue-500');
    }

    function quickSale(id) {
      doRegOptimistic(id, 'pedido', 'Venta OK', 'Rápida');
    }

    function commitSave() {
      if (!state.tempReason && !el('reg-obs').value) return toast('Ingresa motivo', 'error');
      const id = state.cliId;
      const reason = state.tempReason || 'Nota';
      const obs = el('reg-obs').value || '';

      el('modal-reg').classList.add('hidden');
      doRegOptimistic(id, 'visita', reason, obs);
    }

    function doRegOptimistic(id, tipo, motivo, observacion) {
      const cid = String(id);

      // UI instant
      state.route.done.add(cid);
      renderRoute();

      // zona last + semana
      const cli = (state.db.clientes || []).find(x => String(x.id) === cid);
      const zKey = getClientZoneKey(cli);
      if (zKey) {
        touchZoneLast(zKey, tipo, motivo);
        markWeekZone_(zKey, motivo);
      }

      // backend / outbox
      const payload = { vendedor: state.user.vendedor, clienteId: cid, tipo, motivo, observacion };
      sendInBackground('registrar_movimiento', payload);
    }

    async function sendInBackground(action, payload) {
      try {
        await api(action, payload, 20000);
        toast('Guardado', 'success');
        flushOutbox();
      } catch (e) {
        enqueueOutbox(action, payload);
        toast('Sin señal: quedó en cola', 'error');
      }
    }

    // =========================
    // Outbox
    // =========================
    function enqueueOutbox(action, payload) {
      const list = getOutbox();
      list.push({ action, payload, ts: Date.now() });
      localStorage.setItem(OUTBOX_KEY, JSON.stringify(list));
    }

    function getOutbox() {
      try {
        const raw = localStorage.getItem(OUTBOX_KEY);
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr : [];
      } catch (_) {
        return [];
      }
    }

    async function flushOutbox() {
      if (state.outboxFlushing) return;
      const list = getOutbox();
      if (!list.length) return;

      state.outboxFlushing = true;
      try {
        await api('ping', {}, 15000);

        let remaining = [...list];
        let sentCount = 0;

        for (const item of list) {
          try {
            await api(item.action, item.payload, 25000);
            sentCount++;
            remaining.shift();
          } catch (_) {
            break;
          }
        }

        localStorage.setItem(OUTBOX_KEY, JSON.stringify(remaining));
        if (sentCount) toast(`Sync OK: ${sentCount}`, 'success');
      } catch (_) {
        // offline real
      } finally {
        state.outboxFlushing = false;
      }
    }

    // =========================
    // NO LLEGUÉ ZONA (modal + batch)
    // =========================
    function openNoLlegueZoneModal() {
      const pends = (state.route.active || []).filter(x => !state.route.done.has(String(x.id)));
      if (!pends.length) return toast('No hay pendientes', 'error');

      const zones = (state.route.currentZones || []).map(normKey).filter(Boolean);
      el('nlz-count').textContent = String(pends.length);
      el('nlz-zones').textContent = zones.length ? zones.join(', ') : '—';
      el('nlz-sub').textContent = `Esto registra bitácora para ${pends.length} clientes pendientes.`;

      el('nlz-note').value = '';
      el('modal-no-llegue-zone').classList.remove('hidden');
      el('modal-no-llegue-zone').classList.add('flex');
      setTimeout(()=>el('nlz-note')?.focus(), 120);
    }

    function closeNoLlegueZoneModal() {
      const m = el('modal-no-llegue-zone');
      m.classList.add('hidden');
      m.classList.remove('flex');
    }

    function confirmNoLlegueZone() {
      const pends = (state.route.active || []).filter(x => !state.route.done.has(String(x.id)));
      if (!pends.length) return closeNoLlegueZoneModal();

      const note = String(el('nlz-note').value || '').trim();
      const alsoWeek = !!el('nlz-also-week')?.checked;

      // 1) UI instant
      for (const cli of pends) state.route.done.add(String(cli.id));
      renderRoute();

      // 2) zona last + week
      const zones = (state.route.currentZones || []).map(normKey).filter(Boolean);
      zones.forEach(z => {
        touchZoneLast(z, 'visita', 'No llegué');
        if (alsoWeek) markWeekZone_(z, 'No llegué');
      });

      // 3) backend batch (1 request) + offline outbox
      const items = pends.map(cli => ({
        clienteId: String(cli.id),
        tipo: 'visita',
        motivo: 'No llegué',
        observacion: note ? `Zona · ${note}` : 'Zona'
      }));

      closeNoLlegueZoneModal();
      toast(`Marcados ${items.length} como "No llegué"`, 'success');

      // prefer batch endpoint (exists in GS)
      sendInBackground('registrar_batch', { vendedor: state.user.vendedor, items });
    }

    // =========================
    // Finalizar turno / día (jornada)
    // =========================
    function finalizeTurnOrDay() {
      // UX simple: si hay jornada activa en backend, la finalizamos.
      // Si falla o no hay, no rompe.
      const j = state.jornada;
      const nowTurn = turnoNow_();

      // si no hay jornadaId, intentamos pedirla
      if (!j?.jornadaId) {
        toast('Cerrando (sin jornada id)...', 'error');
        return;
      }

      // guardamos pendientes no tocados? (si quedan, recomendamos usar No llegué antes)
      const pends = (state.route.active || []).filter(x => !state.route.done.has(String(x.id)));
      const marcarPendientes = false; // acá NO marcamos auto (vos ya tenés modal No llegué)
      const pendientes = pends.map(x => String(x.id));

      el('loader')?.classList.remove('hidden');
      (async () => {
        try {
          await api('finalizar_jornada', {
            vendedor: state.user.vendedor,
            jornadaId: j.jornadaId,
            marcarPendientes,
            pendientes,
            notas: `Finalizado desde app · turno ahora ${nowTurn}`
          }, 25000);

          state.jornada = { activa:false, jornadaId:null, turno: nowTurn, zonas:[] };
          updateChatSub_();
          toast('Jornada finalizada', 'success');
        } catch (e) {
          toast('No pude finalizar (sin señal): queda para luego', 'error');
          // dejamos en cola
          enqueueOutbox('finalizar_jornada', {
            vendedor: state.user.vendedor,
            jornadaId: j.jornadaId,
            marcarPendientes,
            pendientes,
            notas: `Finalizado offline · turno ahora ${nowTurn}`
          });
        } finally {
          el('loader')?.classList.add('hidden');
          flushOutbox();
        }
      })();
    }

    // =========================
    // Semana modal
    // =========================
    function openWeekModal() {
      const wk = getWeekProgress_();
      const zonesDone = wk.zones || {};
      const allZones = (state.db?.zonas || []).map(z => normKey(z.nombre)).filter(Boolean);

      const doneKeys = Object.keys(zonesDone);
      const doneCount = doneKeys.length;
      const pendingCount = Math.max(0, allZones.length - doneCount);

      el('week-sub').textContent = `Semana ${wk.weekId} · Turno ahora: ${turnoNow_()}`;
      el('week-done').textContent = String(doneCount);
      el('week-pending').textContent = String(pendingCount);

      const list = el('week-list');
      list.innerHTML = '';

      // Build combined list
      const merged = [];
      for (const z of allZones) {
        const i = zonesDone[z] || null;
        merged.push({
          zona: z,
          done: !!i,
          ts: i?.ts || null,
          turno: i?.turno || '',
          motivo: i?.motivo || ''
        });
      }
      merged.sort((a,b)=> Number(b.done)-Number(a.done) || (Number(b.ts||0)-Number(a.ts||0)) || a.zona.localeCompare(b.zona));

      merged.forEach(x => {
        const row = document.createElement('div');
        row.className = 'p-3 rounded-2xl border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 flex items-center justify-between gap-3';

        const left = document.createElement('div');
        left.className = 'min-w-0';
        left.innerHTML = `
          <div class="font-black uppercase text-sm truncate ${x.done ? 'text-emerald-600 dark:text-emerald-400' : 'text-slate-700 dark:text-slate-200'}">
            ${x.done ? '<i class="fas fa-check-circle"></i>' : '<i class="far fa-circle"></i>'} ${escapeHtml(x.zona)}
          </div>
          <div class="text-[11px] font-bold text-slate-500 dark:text-slate-400 truncate">
            ${x.done ? `${escapeHtml(fmtDateTime(new Date(x.ts),'short'))} · ${escapeHtml(x.turno || '')}${x.motivo ? ' · ' + escapeHtml(x.motivo) : ''}` : 'Pendiente esta semana'}
          </div>
        `;

        const btn = document.createElement('button');
        btn.className = 'btn-press px-3 py-2 rounded-xl font-black text-xs bg-blue-600 text-white shrink-0';
        btn.innerHTML = `<i class="fas fa-location-arrow"></i> Ir`;
        btn.onclick = () => {
          closeWeekModal();
          state.sel = new Set([x.zona]);
          startRoute();
        };

        row.appendChild(left);
        row.appendChild(btn);
        list.appendChild(row);
      });

      el('modal-week').classList.remove('hidden');
      el('modal-week').classList.add('flex');
    }

    function closeWeekModal() {
      const m = el('modal-week');
      m.classList.add('hidden');
      m.classList.remove('flex');
    }

    function resetWeekProgress() {
      const ok = confirm('¿Resetear semana? (Solo borra la persistencia local)');
      if (!ok) return;
      const wk = { weekId: weekId_(), zones: {} };
      setWeekProgress_(wk);
      toast('Semana reseteada', 'success');
      closeWeekModal();
      renderGrid(false);
    }

    function askAIWeekPlan() {
      closeWeekModal();
      toggleAIChat(true);
      setTimeout(() => {
        const wk = getWeekProgress_();
        const done = Object.keys(wk.zones || {}).slice(0, 30).join(', ') || '(ninguna)';
        const msg =
`Quiero plan para esta semana.
Semana: ${wk.weekId}
Zonas hechas: ${done}
Decime qué zonas atacar hoy y cómo repartir entre mañana/tarde.`;
        el('chat-in').value = msg;
      }, 250);
    }

    // =========================
    // Onboarding (first time) -> se manda al chat para que quede LOG
    // =========================
    function maybeShowOnboard_() {
      const v = state.user?.vendedor ?? state.user?.user ?? 'GEN';
      const done = localStorage.getItem(ONBOARD_KEY(v));
      if (done) return;
      // show
      el('modal-onboard').classList.remove('hidden');
      el('modal-onboard').classList.add('flex');
      setTimeout(()=>el('ob-name')?.focus(), 150);
    }

    async function closeOnboard(save) {
      const v = state.user?.vendedor ?? state.user?.user ?? 'GEN';
      el('modal-onboard').classList.add('hidden');
      el('modal-onboard').classList.remove('flex');

      localStorage.setItem(ONBOARD_KEY(v), '1');

      if (!save) return;

      const name = String(el('ob-name').value || '').trim() || (state.user?.user || '').toUpperCase();
      const style = String(el('ob-style').value || 'directo');
      const shift = String(el('ob-shift').value || 'doble');
      const pain = String(el('ob-pain').value || '').trim();

      // Guardamos local (para UI)
      try {
        localStorage.setItem(`ml_profile_${CACHE_VER}_${String(v).toUpperCase()}`, JSON.stringify({ name, style, shift, pain, ts: Date.now() }));
      } catch (_) {}

      // Enviamos al chatbot como mensaje "perfil" (queda registrado en IA_ChatLog para hilo)
      try {
        await api('chatbot', {
          vendedor: state.user.vendedor,
          mensaje: `Perfil vendedor (para recordarlo): Me llamo ${name}. Estilo preferido: ${style}. Turnos: ${shift}. Lo que más me cuesta: ${pain || '—'}.`
        }, 25000);
        toast('Perfil guardado (hilo)', 'success');
      } catch (_) {
        // si no hay señal, no es grave
      }
    }

    // =========================
    // CHAT (typing + oportunidades + prompts rápidos)
    // =========================
    function toggleAIChat(s) {
      const m = el('modal-chat'), p = el('chat-panel');
      if (!m || !p) return;
      if (s) {
        m.classList.remove('hidden');
        setTimeout(() => p.classList.remove('translate-y-full'), 10);
        setTimeout(() => el('chat-in')?.focus(), 250);
      } else {
        p.classList.add('translate-y-full');
        setTimeout(() => m.classList.add('hidden'), 300);
      }
    }

    function openChatWithClientHint(id) {
      const cli = (state.db?.clientes || []).find(c => String(c.id) === String(id));
      const name = cli ? displayName(cli) : `#${id}`;
      toggleAIChat(true);
      setTimeout(()=> {
        el('chat-in').value = `Estoy por entrar a ${name} (#${id}). Dame un guión corto si me dice: "ya tengo proveedor" y qué registrar después.`;
      }, 250);
    }

    function openOrderFromClient(id) {
      const cli = (state.db?.clientes || []).find(c => String(c.id) === String(id));
      const name = cli ? displayName(cli) : `#${id}`;
      // pedimos al chat el ticket (backend determinístico). Mostrará ticket.
      toggleAIChat(true);
      setTimeout(()=> {
        el('chat-in').value = `Último pedido del cliente ${name} #${id}`;
        sendChat();
      }, 260);
    }

    async function sendChat() {
      const i = el('chat-in');
      const t = i?.value?.trim();
      if (!t) return;

      addMsg(t, 'user');
      i.value = '';

      const typingEl = addTyping();

      try {
        const res = await api('chatbot', { vendedor: state.user.vendedor, mensaje: t }, 30000);
        const r = res?.respuesta || {};

        removeTyping(typingEl);

        if (r.type === 'ticket') {
          addMsg(r.text || 'Listo.', 'bot');
          addTicket(r.data || '');
        } else if (r.type === 'route') {
          addMsg(r.text || 'Dale.', 'bot');
          addRouteBtn(r.data || '');
        } else {
          addMsg(r.text || "No entendí.", 'bot');
          maybeRenderOpportunities(r.data);
        }
      } catch (e) {
        removeTyping(typingEl);
        addMsg('Error de conexión', 'bot');
      }
    }

    function addMsg(h, r) {
      const d = document.createElement('div');
      d.className = `chat-bubble chat-${r} animate-pop`;
      d.innerText = h;
      el('chat-msgs')?.appendChild(d);
      const cm = el('chat-msgs');
      if (cm) cm.scrollTop = cm.scrollHeight;
    }

    function addTyping() {
      const d = document.createElement('div');
      d.className = 'chat-bubble chat-bot animate-pop';
      d.innerHTML = `
        <div class="typing-row">
          <span class="typing-dot d1"></span>
          <span class="typing-dot d2"></span>
          <span class="typing-dot d3"></span>
          <span style="font-weight:800; opacity:.75; font-size:12px;">Escribiendo...</span>
        </div>
      `;
      el('chat-msgs')?.appendChild(d);
      const cm = el('chat-msgs');
      if (cm) cm.scrollTop = cm.scrollHeight;
      return d;
    }

    function removeTyping(node) {
      try { if (node && node.parentNode) node.parentNode.removeChild(node); } catch (_) {}
    }

    function addTicket(items) {
      const ticket = String(items || '');
      const d = document.createElement('div');
      d.className = 'animate-pop';
      d.innerHTML = `
        <div class="ticket-box">
          <div class="text-[11px] font-black uppercase tracking-widest mb-2 opacity-70">PEDIDO RECUPERADO</div>
          <div style="white-space: pre-wrap;">${escapeHtml(ticket)}</div>
          <button class="btn-copy-order" type="button"><i class="fas fa-copy"></i> COPIAR</button>
        </div>
      `;
      d.querySelector('button').addEventListener('click', (ev) => {
        copyPlainText(ticket);
        const btn = ev.currentTarget;
        const prev = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-check"></i> COPIADO';
        btn.style.background = '#10b981';
        setTimeout(() => { btn.innerHTML = prev; btn.style.background = ''; }, 1500);
      });

      el('chat-msgs')?.appendChild(d);
      const cm = el('chat-msgs');
      if (cm) cm.scrollTop = cm.scrollHeight;
    }

    function addRouteBtn(zone) {
      const z = String(zone || '').trim();
      if (!z) return;
      const d = document.createElement('div');
      d.className = 'animate-pop';
      d.innerHTML = `<button type="button" class="w-full bg-green-600 text-white p-3 rounded-xl font-bold mt-2 shadow-md btn-press"><i class="fas fa-map-signs"></i> IR A ${escapeHtml(z)}</button>`;
      d.querySelector('button').addEventListener('click', () => acceptIARoute(z));
      el('chat-msgs')?.appendChild(d);
      const cm = el('chat-msgs');
      if (cm) cm.scrollTop = cm.scrollHeight;
    }

    function acceptIARoute(z) {
      toggleAIChat(false);
      state.sel = new Set([String(z).toUpperCase()]);
      startRoute();
    }

    function maybeRenderOpportunities(data) {
      if (!data) return;

      let obj = null;
      if (typeof data === 'string') {
        const s = data.trim();
        if (!s) return;
        try { obj = JSON.parse(s); } catch (_) { return; }
      } else if (typeof data === 'object') {
        obj = data;
      }

      if (!obj || !obj.suggestions || !Array.isArray(obj.suggestions) || obj.suggestions.length === 0) return;

      const wrap = document.createElement('div');
      wrap.className = 'animate-pop';
      const zone = obj.zone ? String(obj.zone) : 'Zona';

      wrap.innerHTML = `
        <div class="ticket-box">
          <div class="text-[11px] font-black uppercase tracking-widest mb-2 opacity-70">OPORTUNIDADES — ${escapeHtml(zone)}</div>
          <div id="opp-list" class="space-y-2"></div>
        </div>
      `;

      const list = wrap.querySelector('#opp-list');
      obj.suggestions.forEach((sug) => {
        const clienteId = String(sug.clienteId || '');
        const nombre = String(sug.clienteNombre || '');
        const dias = sug.diasSinComprar ?? '';
        const avg = sug.avgDias ?? null;
        const fecha = String(sug.ultimoPedidoFecha || '');
        const ticket = String(sug.ultimoPedidoTicket || '');

        const card = document.createElement('div');
        card.className = 'opp-card';
        card.innerHTML = `
          <div class="opp-title">#${escapeHtml(clienteId)} ${escapeHtml(nombre)}</div>
          <div class="opp-sub">Último: ${escapeHtml(fecha)} · ${escapeHtml(String(dias))} días sin comprar${avg ? ` · prom ${escapeHtml(String(avg))}d` : ''}</div>
          <div class="opp-meta">
            <span><i class="fas fa-clock"></i> ${escapeHtml(String(dias))}d</span>
            ${avg ? `<span><i class="fas fa-chart-line"></i> prom ${escapeHtml(String(avg))}d</span>` : ``}
          </div>
          <div class="opp-actions">
            <button type="button" class="opp-btn opp-btn-primary"><i class="fas fa-receipt"></i> Ver último pedido</button>
            <button type="button" class="opp-btn opp-btn-secondary"><i class="fas fa-location-crosshairs"></i> Ir a cliente</button>
          </div>
        `;

        const btnView = card.querySelectorAll('button')[0];
        const btnGo = card.querySelectorAll('button')[1];

        btnView.addEventListener('click', () => openOrderModal(`#${clienteId} ${nombre}`, ticket));
        btnGo.addEventListener('click', () => goToClient(clienteId));

        list.appendChild(card);
      });

      el('chat-msgs')?.appendChild(wrap);
      const cm = el('chat-msgs');
      if (cm) cm.scrollTop = cm.scrollHeight;
    }

    function goToClient(clienteId) {
      const id = String(clienteId || '').trim();
      if (!id) return;

      const cli = (state.db?.clientes || []).find(c => String(c.id) === id);
      if (!cli) {
        addMsg(`No tengo ese cliente cargado ahora. (Usá el buscador para traerlo: #${id})`, 'bot');
        return;
      }

      if (state.route.active && state.route.active.length) {
        state.route.active = state.route.active.filter(c => String(c.id) !== id);
        state.route.active.unshift(cli);
        state.route.done.delete(id);
        renderRoute();
        toggleAIChat(false);
        switchView('view-route');
        toast(`Cliente #${id} al frente`, 'success');
        return;
      }

      state.sel = new Set([String(cli.localidad_key || cli.localidad || '').toUpperCase()]);
      startRoute();
      toggleAIChat(false);
      toast(`Ruta: ${cli.localidad || ''}`, 'success');
    }

    // =========================
    // MODAL PEDIDO
    // =========================
    function openOrderModal(title, ticket) {
      state.currentOrder.title = String(title || '');
      state.currentOrder.ticket = String(ticket || '');

      el('order-title').innerText = state.currentOrder.title || 'Pedido';
      el('order-ticket').innerText = state.currentOrder.ticket || '';

      const m = el('modal-order');
      m.classList.remove('hidden');
      m.classList.add('flex');
    }

    function closeOrderModal() {
      const m = el('modal-order');
      m.classList.add('hidden');
      m.classList.remove('flex');
    }

    function copyCurrentOrder() {
      copyPlainText(state.currentOrder.ticket || '');
      toast('Pedido copiado', 'success');
    }

    // =========================
    // UTILS
    // =========================
    function copyPlainText(txt) {
      const t = String(txt || '');
      try {
        if (navigator.clipboard && window.isSecureContext) {
          navigator.clipboard.writeText(t);
        } else {
          const area = document.createElement('textarea');
          area.value = t;
          document.body.appendChild(area);
          area.select();
          document.execCommand('copy');
          document.body.removeChild(area);
        }
      } catch (_) {}
    }

    function escapeHtml(str) {
      return String(str || '')
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }

    function escapeAttr(str) {
      return String(str || '').replaceAll("'", "\\'").replaceAll('"', '&quot;');
    }

    function _normText_(s) {
      return String(s || "")
        .toLowerCase()
        .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
        .replace(/[^\w\s]/g, ' ')
        .replace(/\s+/g, ' ')
        .trim();
    }
  </script>
</body>
</html>
