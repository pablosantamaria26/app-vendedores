<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>üß† App de Vendedores Inteligente</title>

  <!-- üîπ Estilos integrados -->
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: "Inter", sans-serif;
      background: #f7f8fa;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      min-height: 100vh;
      overflow-x: hidden;
    }

    header {
      width: 100%;
      text-align: center;
      background: #007aff;
      color: white;
      padding: 12px;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    }

    header h1 {
      margin: 0;
      font-size: 1.3rem;
    }

    .menu {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 8px;
    }

    .menu button {
      background: white;
      color: #007aff;
      border: none;
      border-radius: 10px;
      padding: 8px 12px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: 0.2s;
    }

    .menu button.activo {
      background: #005bd1;
      color: white;
    }

    .pantalla {
      width: 95vw;
      max-width: 480px;
      margin: 1rem auto;
    }

    .tarjeta {
      background: white;
      border-radius: 14px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      padding: 14px;
      margin-bottom: 16px;
      transition: transform 0.2s;
    }

    .tarjeta:hover {
      transform: scale(1.02);
    }

    .nombre {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .direccion {
      font-size: 0.9rem;
      color: #555;
    }

    .boton-ir {
      background: #2a8efc;
      color: white;
      border: none;
      border-radius: 10px;
      padding: 10px 14px;
      margin-top: 10px;
      width: 100%;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.2s;
    }

    .boton-ir:hover {
      background: #0b73e0;
    }

    .oculto {
      display: none;
    }

    .visible {
      display: block;
    }

    .login {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: #007aff;
      color: white;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .login-card {
      background: white;
      color: #333;
      border-radius: 20px;
      padding: 20px;
      width: 90%;
      max-width: 340px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
      text-align: center;
    }

    .login-card input {
      width: 80%;
      font-size: 1.3rem;
      padding: 8px;
      margin-top: 8px;
      text-align: center;
      border-radius: 10px;
      border: 1px solid #ccc;
    }

    .teclado-numerico {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-top: 12px;
    }

    .teclado-numerico button {
      padding: 10px;
      font-size: 1.2rem;
      border-radius: 8px;
      border: none;
      background: #007aff;
      color: white;
      cursor: pointer;
      transition: 0.2s;
    }

    .teclado-numerico button:hover {
      background: #005bd1;
    }

    #error {
      color: red;
      font-size: 0.9rem;
    }

    footer {
      margin-top: 2rem;
      font-size: 0.8rem;
      color: #888;
    }
  </style>
</head>

<body>
  <!-- ==========================
       LOGIN FULLSCREEN
  =========================== -->
  <div id="login" class="login">
    <div class="login-card">
      <h1>üß† App de Vendedores</h1>
      <h2>üîê Ingres√° tu c√≥digo</h2>

      <input type="tel" id="clave" maxlength="4" inputmode="numeric" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="off" autofocus />

      <div class="teclado-numerico">
        <button onclick="agregarDigito('1')">1</button>
        <button onclick="agregarDigito('2')">2</button>
        <button onclick="agregarDigito('3')">3</button>
        <button onclick="agregarDigito('4')">4</button>
        <button onclick="agregarDigito('5')">5</button>
        <button onclick="agregarDigito('6')">6</button>
        <button onclick="agregarDigito('7')">7</button>
        <button onclick="agregarDigito('8')">8</button>
        <button onclick="agregarDigito('9')">9</button>
        <button onclick="borrarDigito()">‚å´</button>
        <button onclick="agregarDigito('0')">0</button>
        <button onclick="login()">‚úîÔ∏è</button>
      </div>
      <p id="error" class="error"></p>
    </div>
  </div>

  <!-- ==========================
       APP PRINCIPAL
  =========================== -->
  <div id="app" class="oculto">
    <header>
      <h1 id="titulo"></h1>
      <div class="menu">
        <button id="btnRuta" class="activo" onclick="mostrarSeccion('ruta')">üó∫Ô∏è Ruta del D√≠a</button>
        <button id="btnCalendario" onclick="mostrarSeccion('calendario')">üìÖ Calendario</button>
        <button id="btnResumen" onclick="mostrarSeccion('resumen')">üìà Resumen</button>
        <button onclick="logout()">üö™ Salir</button>
      </div>
    </header>

    <main class="pantalla">
      <!-- üó∫Ô∏è Ruta del D√≠a -->
      <section id="seccion-ruta" class="visible">
        <div id="contenedorRuta"></div>
      </section>

      <!-- üìÖ Calendario -->
      <section id="seccion-calendario" class="oculto">
        <h2>üìÖ Calendario de Visitas</h2>
        <div id="contenedorCalendario"></div>
      </section>

      <!-- üìà Resumen Inteligente -->
      <section id="seccion-resumen" class="oculto">
        <h2>üìä Desempe√±o y Predicciones</h2>
        <div id="contenedorResumen">‚è≥ Cargando...</div>
      </section>
    </main>

    <footer>v2025 ‚Ä¢ App Inteligente de Vendedores</footer>
  </div>

  <!-- ==========================
       JS PRINCIPAL
  =========================== -->
  <script>
    const URL_API_BASE = "https://script.google.com/macros/s/AKfycbzqPMRir2VCB_C_EUsa0o8-eYCRDM4AQLsY3Jx_5jRKkYi-D2WgTEkTFrBIRFugT5MW/exec";

    /* ================================
       üîê LOGIN
    ================================ */
    function agregarDigito(n) {
      const input = document.getElementById("clave");
      if (input.value.length < 4) input.value += n;
    }

    function borrarDigito() {
      const input = document.getElementById("clave");
      input.value = input.value.slice(0, -1);
    }

    async function login() {
      const clave = document.getElementById("clave").value.trim();
      if (!clave) {
        document.getElementById("error").textContent = "‚ö†Ô∏è Ingres√° un c√≥digo v√°lido.";
        return;
      }

      localStorage.setItem("vendedorClave", clave);
      document.getElementById("login").classList.add("oculto");
      document.getElementById("app").classList.remove("oculto");
      document.getElementById("titulo").textContent = `üëã Bienvenido, ${clave}`;
      await cargarRutaDelDia();
    }

    function logout() {
      localStorage.removeItem("vendedorClave");
      location.reload();
    }

    window.onload = () => {
      const clave = localStorage.getItem("vendedorClave");
      if (clave) {
        document.getElementById("login").classList.add("oculto");
        document.getElementById("app").classList.remove("oculto");
        document.getElementById("titulo").textContent = `üëã Bienvenido, ${clave}`;
        cargarRutaDelDia();
      }
    };

    /* ================================
       üîÅ SECCIONES
    ================================ */
    function mostrarSeccion(sec) {
      const secciones = ["ruta", "calendario", "resumen"];
      secciones.forEach((s) => {
        document.getElementById("seccion-" + s).classList.add("oculto");
        document.getElementById("btn" + s.charAt(0).toUpperCase() + s.slice(1)).classList.remove("activo");
      });
      document.getElementById("seccion-" + sec).classList.remove("oculto");
      document.getElementById("btn" + sec.charAt(0).toUpperCase() + sec.slice(1)).classList.add("activo");

      if (sec === "ruta") cargarRutaDelDia();
      if (sec === "resumen") cargarResumen();
    }

    /* ================================
       üöó RUTA DEL D√çA
    ================================ */
    async function cargarRutaDelDia() {
      const clave = localStorage.getItem("vendedorClave");
      const cont = document.getElementById("contenedorRuta");
      cont.innerHTML = "‚è≥ Cargando clientes del d√≠a...";

      try {
        const resp = await fetch(`${URL_API_BASE}?accion=getRutaDelDiaPorVendedor&clave=${clave}`);
        const data = await resp.json();

        if (!Array.isArray(data) || data.length === 0) {
          cont.innerHTML = "<p>üì≠ No hay clientes asignados para hoy.</p>";
          return;
        }

        cont.innerHTML = "";
        data.forEach((cli) => {
          const tarjeta = document.createElement("div");
          tarjeta.classList.add("tarjeta");
          tarjeta.innerHTML = `
            <div class="nombre">${cli.nombre}</div>
            <div class="direccion">${cli.direccion}</div>
            <div class="direccion">üìç ${cli.localidad}</div>
            <button class="boton-ir" onclick="irAlCliente(${cli.lat}, ${cli.lng})">üöó Ir a este cliente</button>
          `;
          cont.appendChild(tarjeta);
        });
      } catch (e) {
        cont.innerHTML = "‚ùå Error al cargar clientes.";
        console.error(e);
      }
    }

    function irAlCliente(lat, lng) {
      if (!navigator.geolocation) {
        alert("Geolocalizaci√≥n no disponible.");
        return;
      }

      navigator.geolocation.getCurrentPosition((pos) => {
        const oLat = pos.coords.latitude;
        const oLng = pos.coords.longitude;
        const url = `https://www.google.com/maps/dir/?api=1&origin=${oLat},${oLng}&destination=${lat},${lng}&travelmode=driving`;
        window.open(url, "_blank");
      }, () => {
        alert("‚ö†Ô∏è No se pudo obtener tu ubicaci√≥n actual.");
      });
    }

    /* ================================
       üìà RESUMEN
    ================================ */
    async function cargarResumen() {
      const clave = localStorage.getItem("vendedorClave");
      const cont = document.getElementById("contenedorResumen");
      cont.innerHTML = "‚è≥ Analizando tus datos...";

      try {
        const resumenURL = `${URL_API_BASE}?accion=getResumenVendedor&clave=${clave}`;
        const predURL = `${URL_API_BASE}?accion=getPrediccionesVendedor&clave=${clave}`;

        const [r1, r2] = await Promise.all([fetch(resumenURL), fetch(predURL)]);
        const resumen = await r1.json();
        const pred = await r2.json();

        cont.innerHTML = `
          <div class="tarjeta">
            <h3>üìÖ Fecha: ${resumen.fecha || "Sin datos"}</h3>
            <p>üßç‚Äç‚ôÇÔ∏è Visitados: <strong>${resumen.totalHoy || 0}</strong></p>
            <p>üõí Compraron: <strong>${resumen.compraronHoy || 0}</strong></p>
            <p>üìà Conversi√≥n: <strong>${resumen.tasa || 0}%</strong></p>
            <p>‚è±Ô∏è Frecuencia: <strong>${resumen.frecuenciaProm || "Sin datos"} d√≠as</strong></p>
          </div>
          <div class="tarjeta">
            <h3>ü§ñ Recomendaci√≥n</h3>
            <p>${pred.mensaje || "No hay registros suficientes para an√°lisis."}</p>
          </div>
        `;
      } catch (e) {
        cont.innerHTML = "‚ùå Error al cargar el resumen.";
        console.error(e);
      }
    }
  </script>
</body>
</html>
