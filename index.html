Hola, **Pablo Daniel**. Veo perfectamente el error en la imagen.

El problema es exactamente lo que sospechaba al ver tus archivos separados: **Conflicto de tiempos y lógica duplicada.**

1. **El conflicto:** Tu `index.html` tenía un script al final que "pisaba" (sobrescribía) la lógica de `app.js`. Ese script tenía un tiempo de espera (timeout) de **15 segundos**.
2. **La lentitud:** La IA (Gemini) + Leer las hojas de cálculo en el servidor tarda entre **20 y 30 segundos** en procesar todo.
3. **El resultado:** Tu App "se aburre" de esperar a los 15 segundos, corta la conexión y te muestra "Error de conexión con soporte", aunque el servidor siga trabajando.

Para solucionarlo y trabajar de forma **organizada** como pediste, he fusionado **TODO** (HTML + CSS + JS corregido) en un solo archivo `index.html`.

**He realizado estas correcciones críticas en el código unificado:**

1. **Aumenté el tiempo de espera (Timeout):** Pasé de 15 segundos a **90 segundos** en la función `apiCall`. Esto le da tiempo a la IA de pensar sin que la app corte la llamada.
2. **Indicador "Escribiendo...":** Agregé una burbuja visual que dice "..." mientras la IA piensa, para que sepas que no se colgó.
3. **Unificación:** Borré la lógica duplicada. Ahora el HTML depende 100% del JS integrado.

Aquí tienes el código **FINAL UNIFICADO** para `index.html`. Copia y pega esto reemplazando todo tu archivo actual.

```html
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mercado Limpio Smart</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

    <style>
        /* === ESTILOS BASE === */
        body { font-family: 'Inter', sans-serif; background-color: #111827; color: white; overflow: hidden; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Gestión de Vistas */
        .view-section { display: none; width: 100%; height: 100vh; flex-direction: column; }
        .view-section.active { display: flex; }

        input, button, textarea { font-family: inherit; outline: none; -webkit-tap-highlight-color: transparent; }

        /* Efectos Táctiles */
        .btn-press:active { transform: scale(0.96); transition: transform 0.1s; }
        
        /* Animaciones */
        @keyframes slideIn { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .animate-slide-in { animation: slideIn 0.3s ease-out forwards; }
        
        @keyframes popIn { 0% { opacity: 0; transform: scale(0.9); } 100% { opacity: 1; transform: scale(1); } }
        .animate-pop { animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }

        @keyframes pulse-dot { 0%, 100% { opacity: 0.3; } 50% { opacity: 1; } }
        .animate-pulse-dot { animation: pulse-dot 1.5s infinite; }

        /* Toast (Notificaciones) */
        #toast-container { position: fixed; top: 20px; left: 0; right: 0; display: flex; flex-direction: column; alignItems: center; pointer-events: none; z-index: 9999; }
        .toast { background: #333; color: white; padding: 12px 20px; border-radius: 12px; margin-top: 10px; font-weight: 600; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.5); pointer-events: auto; animation: popIn 0.3s; }
        .toast.error { background: #7f1d1d; border-left: 4px solid #f87171; }
        .toast.success { background: #064e3b; border-left: 4px solid #34d399; }

        /* Chat Burbujas */
        .chat-bubble { max-width: 85%; padding: 12px 16px; border-radius: 18px; margin-bottom: 8px; font-size: 0.95rem; line-height: 1.4; position: relative; word-wrap: break-word; }
        .chat-user { background: #2563eb; color: white; align-self: flex-end; border-bottom-right-radius: 4px; margin-left: auto; }
        .chat-bot { background: #374151; color: #e5e7eb; align-self: flex-start; border-bottom-left-radius: 4px; border: 1px solid #4b5563; }
        
        /* Indicador de escribiendo (Typing) */
        .typing-indicator { display: flex; gap: 4px; padding: 12px 16px; background: #374151; border-radius: 18px; width: fit-content; border-bottom-left-radius: 4px; border: 1px solid #4b5563; }
        .typing-dot { w-2 h-2 bg-gray-400 rounded-full; width: 6px; height: 6px; background: #9ca3af; border-radius: 50%; animation: pulse-dot 1.4s infinite ease-in-out; }
        .typing-dot:nth-child(1) { animation-delay: 0s; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        /* Ticket de Pedido en Chat */
        .ticket-container { background: #f3f4f6; color: #1f2937; padding: 15px; border-radius: 12px; font-family: 'Courier New', monospace; margin-top: 10px; border: 2px dashed #d1d5db; position: relative; }
        .ticket-header { text-align: center; border-bottom: 2px dashed #9ca3af; padding-bottom: 10px; margin-bottom: 10px; font-weight: bold; text-transform: uppercase; font-size: 0.85rem; }
        .ticket-row { display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 0.85rem; }
        .ticket-total { border-top: 2px dashed #9ca3af; padding-top: 10px; margin-top: 10px; font-weight: bold; font-size: 1.1em; display: flex; justify-content: space-between; }
        .btn-copy-order { width: 100%; background: #2563eb; color: white; padding: 10px; border-radius: 8px; margin-top: 12px; font-family: 'Inter', sans-serif; font-weight: 600; font-size: 0.8rem; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.2s; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); cursor: pointer; }
        .btn-copy-order:active { transform: scale(0.95); }
        .btn-copy-order.copied { background: #059669; }
    </style>
</head>
<body>

    <div id="loader" class="fixed inset-0 z-[100] bg-gray-900/95 flex flex-col items-center justify-center hidden backdrop-blur-sm">
        <div class="w-16 h-16 border-4 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
        <p class="mt-4 text-xs font-bold text-blue-400 uppercase tracking-[0.2em] animate-pulse">Procesando...</p>
    </div>

    <div id="toast-container"></div>

    <section id="view-login" class="view-section active items-center justify-center p-6 bg-gray-900 relative">
        <div class="absolute top-0 left-0 w-full h-full overflow-hidden -z-10 opacity-20">
            <div class="absolute top-[-10%] right-[-10%] w-64 h-64 bg-blue-600 rounded-full blur-[80px]"></div>
            <div class="absolute bottom-[-10%] left-[-10%] w-64 h-64 bg-purple-600 rounded-full blur-[80px]"></div>
        </div>

        <div class="w-full max-w-sm text-center z-10">
            <div class="mb-12">
                <div class="w-20 h-20 bg-gradient-to-tr from-blue-600 to-blue-400 rounded-2xl mx-auto flex items-center justify-center mb-6 shadow-2xl shadow-blue-500/20 transform rotate-3">
                    <i class="fas fa-cubes text-3xl text-white"></i>
                </div>
                <h1 class="text-4xl font-black tracking-tighter text-white">MERCADO<span class="text-blue-500">LIMPIO</span></h1>
                <p class="text-[10px] text-gray-400 font-bold uppercase tracking-[0.3em] mt-2">Logística Inteligente</p>
            </div>

            <div class="space-y-4 bg-gray-800/50 backdrop-blur-md p-6 rounded-3xl border border-gray-700/50 shadow-2xl">
                <div class="text-left group">
                    <label class="text-[10px] font-bold text-gray-500 ml-3 mb-1 block group-focus-within:text-blue-400 transition-colors">USUARIO</label>
                    <div class="relative">
                        <i class="fas fa-user absolute left-4 top-1/2 -translate-y-1/2 text-gray-500 group-focus-within:text-blue-500 transition-colors"></i>
                        <input id="login-user" type="text" class="w-full bg-gray-900/80 border border-gray-600 rounded-xl py-4 pl-12 pr-4 text-white font-bold focus:border-blue-500 focus:bg-gray-900 transition-all uppercase placeholder-gray-700" placeholder="Ej: MARTIN">
                    </div>
                </div>

                <div class="text-left group">
                    <label class="text-[10px] font-bold text-gray-500 ml-3 mb-1 block group-focus-within:text-blue-400 transition-colors">PIN DE ACCESO</label>
                    <div class="relative">
                        <i class="fas fa-lock absolute left-4 top-1/2 -translate-y-1/2 text-gray-500 group-focus-within:text-blue-500 transition-colors"></i>
                        <input id="login-pass" type="password" inputmode="numeric" class="w-full bg-gray-900/80 border border-gray-600 rounded-xl py-4 pl-12 pr-4 text-white font-bold focus:border-blue-500 focus:bg-gray-900 transition-all tracking-[0.5em] placeholder-gray-700" placeholder="••••">
                    </div>
                </div>

                <button id="btn-login" class="btn-press w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded-xl shadow-lg shadow-blue-600/30 flex items-center justify-center gap-3 mt-6">
                    <span>INGRESAR SISTEMA</span> <i class="fas fa-arrow-right text-sm"></i>
                </button>
            </div>
            
            <p class="mt-8 text-[10px] font-mono text-gray-600">V2.0 Unified • Server Online</p>
        </div>
    </section>

    <section id="view-dashboard" class="view-section bg-gray-900">
        <div class="px-6 pt-12 pb-6 bg-gradient-to-b from-gray-900 via-gray-900 to-transparent sticky top-0 z-10 flex justify-between items-end">
            <div>
                <p id="lbl-saludo" class="text-[10px] font-bold text-blue-400 uppercase tracking-widest mb-1">Bienvenido</p>
                <h2 class="text-3xl font-black text-white leading-none tracking-tight">Mis Zonas</h2>
            </div>
            <button onclick="window.logout()" class="btn-press w-10 h-10 rounded-full bg-gray-800 flex items-center justify-center text-gray-400 hover:text-white border border-gray-700">
                <i class="fas fa-power-off text-xs"></i>
            </button>
        </div>

        <div class="flex-1 overflow-y-auto px-6 pb-32 no-scrollbar">
            <div id="ia-suggestion-box" class="hidden mb-6 bg-gradient-to-r from-blue-900/40 to-indigo-900/40 border border-blue-500/20 p-5 rounded-2xl animate-pop relative overflow-hidden">
                <div class="absolute -right-4 -top-4 text-blue-500/10 text-9xl"><i class="fas fa-chart-line"></i></div>
                <div class="relative z-10">
                    <div class="flex items-center gap-2 mb-2">
                        <i class="fas fa-sparkles text-yellow-400 text-xs animate-pulse"></i>
                        <span class="text-[10px] font-bold text-blue-200 uppercase tracking-widest">Sugerencia Inteligente</span>
                    </div>
                    <p id="ia-text" class="text-sm font-medium text-white mb-3 leading-relaxed"></p>
                    <button id="btn-accept-ia" class="btn-press text-xs bg-white text-blue-900 px-4 py-2 rounded-lg font-bold shadow-md w-full flex justify-center items-center gap-2">
                        ACEPTAR RUTA <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>

            <div id="zones-grid" class="grid grid-cols-1 gap-4 pb-10"></div>
        </div>

        <div id="footer-dashboard" class="p-6 bg-gradient-to-t from-gray-900 via-gray-900 to-transparent fixed bottom-0 left-0 right-0 hidden z-20">
            <button onclick="window.startRoute()" class="btn-press w-full bg-blue-600 text-white font-bold py-4 rounded-2xl shadow-xl shadow-blue-900/40 flex items-center justify-center gap-2 border border-blue-400/20">
                <i class="fas fa-location-arrow"></i> <span id="btn-start-lbl">INICIAR RUTA</span>
            </button>
        </div>
        
        <button onclick="window.toggleAIChat(true)" class="btn-press fixed bottom-6 right-6 w-14 h-14 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-full shadow-2xl flex items-center justify-center text-white z-30 border border-white/20 animate-pop">
            <i class="fas fa-headset text-xl"></i>
        </button>
    </section>

    <section id="view-route" class="view-section bg-gray-900">
        <div class="px-5 pt-10 pb-4 bg-gray-900/95 backdrop-blur border-b border-gray-800 sticky top-0 z-10 flex justify-between items-center shadow-lg">
            <button onclick="window.switchView('view-dashboard')" class="btn-press w-10 h-10 bg-gray-800 rounded-xl flex items-center justify-center text-gray-300 border border-gray-700">
                <i class="fas fa-chevron-left"></i>
            </button>
            
            <div class="flex flex-col items-center">
                <div class="flex items-center gap-2 bg-gray-800/80 px-4 py-1.5 rounded-full border border-gray-700">
                    <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                    <span id="route-count" class="text-xs font-bold text-white tracking-wide">0 PENDIENTES</span>
                </div>
            </div>

            <button onclick="window.toggleViewMode()" class="btn-press w-10 h-10 bg-gray-800 rounded-xl flex items-center justify-center text-blue-400 border border-gray-700 relative">
                <i id="icon-view-mode" class="fas fa-crop-alt"></i>
            </button>
        </div>

        <div id="route-container" class="flex-1 overflow-y-auto p-4 pb-24 no-scrollbar relative">
            </div>
    </section>

    <div id="modal-ai-chat" class="fixed inset-0 z-50 bg-gray-900 translate-y-full transition-transform duration-300 flex flex-col">
        <div class="p-4 bg-gray-800 border-b border-gray-700 flex justify-between items-center shadow-md">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center border-2 border-gray-700">
                    <i class="fas fa-headset text-white"></i>
                </div>
                <div>
                    <h3 class="font-bold text-white leading-none">Mercado Limpio - Chat</h3>
                    <p class="text-[10px] text-green-400 font-bold mt-1 flex items-center gap-1"><span class="w-1.5 h-1.5 bg-green-500 rounded-full"></span> Soporte Activo</p>
                </div>
            </div>
            <button onclick="window.toggleAIChat(false)" class="w-8 h-8 flex items-center justify-center text-gray-400 hover:text-white">
                <i class="fas fa-chevron-down text-lg"></i>
            </button>
        </div>

        <div id="chat-messages" class="flex-1 overflow-y-auto p-4 flex flex-col gap-2 bg-gray-900">
            <div class="chat-bubble chat-bot animate-pop">
                Hola, soy el asistente de ventas. ¿En qué te puedo ayudar hoy con tus pedidos o rutas?
            </div>
            </div>

        <div id="typing-indicator" class="hidden px-6 pb-2">
            <div class="typing-indicator">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>
        </div>

        <div class="p-4 bg-gray-800 border-t border-gray-700 pb-8">
            <div class="flex gap-2 relative">
                <input id="chat-input" type="text" placeholder="Escribe tu consulta..." class="flex-1 bg-gray-900 border border-gray-600 text-white text-sm rounded-xl px-4 py-3 focus:border-indigo-500 pr-10">
                <button onclick="window.sendChatMessage()" class="btn-press absolute right-2 top-2 bottom-2 bg-indigo-600 text-white w-10 rounded-lg flex items-center justify-center shadow-lg">
                    <i class="fas fa-paper-plane text-xs"></i>
                </button>
            </div>
        </div>
    </div>

    <div id="modal-options" class="fixed inset-0 z-[60] bg-black/90 hidden flex items-center justify-center p-6 backdrop-blur-sm">
        <div class="bg-gray-800 w-full max-w-sm rounded-3xl p-6 border border-gray-700 shadow-2xl animate-pop">
            <div class="flex justify-between items-start mb-6 border-b border-gray-700 pb-4">
                <div>
                    <h3 id="modal-title" class="text-xl font-black text-white leading-tight">CLIENTE</h3>
                    <p class="text-[10px] text-gray-400 uppercase font-bold tracking-widest mt-1">Registrar Novedad</p>
                </div>
                <button onclick="window.closeModal()" class="w-8 h-8 bg-gray-700/50 rounded-full text-white flex items-center justify-center hover:bg-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="grid grid-cols-2 gap-3 mb-5">
                <button onclick="window.saveVisit('Stock')" class="btn-press bg-gray-700/50 border border-gray-600 p-4 rounded-xl text-left hover:bg-gray-700 hover:border-blue-500/50 transition-colors group">
                    <i class="fas fa-box text-blue-400 mb-2 text-xl group-hover:scale-110 transition-transform block"></i> 
                    <span class="text-[10px] font-bold text-gray-300 group-hover:text-white uppercase">Tiene Stock</span>
                </button>
                <button onclick="window.saveVisit('Dinero')" class="btn-press bg-gray-700/50 border border-gray-600 p-4 rounded-xl text-left hover:bg-gray-700 hover:border-red-500/50 transition-colors group">
                    <i class="fas fa-wallet text-red-400 mb-2 text-xl group-hover:scale-110 transition-transform block"></i> 
                    <span class="text-[10px] font-bold text-gray-300 group-hover:text-white uppercase">Sin Dinero</span>
                </button>
                <button onclick="window.saveVisit('Cerrado')" class="btn-press bg-gray-700/50 border border-gray-600 p-4 rounded-xl text-left hover:bg-gray-700 hover:border-yellow-500/50 transition-colors group">
                    <i class="fas fa-store-slash text-yellow-400 mb-2 text-xl group-hover:scale-110 transition-transform block"></i> 
                    <span class="text-[10px] font-bold text-gray-300 group-hover:text-white uppercase">Cerrado</span>
                </button>
                <button onclick="window.saveVisit('Volver')" class="btn-press bg-gray-700/50 border border-gray-600 p-4 rounded-xl text-left hover:bg-gray-700 hover:border-purple-500/50 transition-colors group">
                    <i class="fas fa-clock text-purple-400 mb-2 text-xl group-hover:scale-110 transition-transform block"></i> 
                    <span class="text-[10px] font-bold text-gray-300 group-hover:text-white uppercase">Volver Luego</span>
                </button>
            </div>

            <div class="relative mb-5">
                <i class="fas fa-pen absolute left-3 top-3 text-gray-500 text-xs"></i>
                <textarea id="visit-obs" class="w-full bg-gray-900 border border-gray-600 rounded-xl p-3 pl-8 text-sm text-white h-24 focus:border-blue-500 resize-none" placeholder="Escribe una nota adicional..."></textarea>
            </div>

            <button onclick="window.saveVisit('Nota General')" class="btn-press w-full bg-white text-gray-900 font-black py-4 rounded-xl shadow-lg shadow-white/10 active:scale-95 flex items-center justify-center gap-2">
                <i class="fas fa-save text-blue-600"></i> GUARDAR REPORTE
            </button>
        </div>
    </div>

    <script>
        // === CONFIGURACIÓN ===
        // Reemplaza esto con tu URL real del Worker si cambia
        const WORKER_URL = 'https://frosty-term-20ea.santamariapablodaniel.workers.dev/';

        // === ESTADO GLOBAL ===
        const state = {
            user: JSON.parse(localStorage.getItem('ml_user')) || null,
            location: null,
            db: { clients: [], zones: [], ia: null },
            route: { active: [], completed: new Set() },
            selection: new Set(),
            viewMode: 'list', // 'list' | 'focus'
            currentClientId: null
        };

        // === UTILS DOM ===
        const el = (id) => document.getElementById(id);
        const toggleLoader = (show) => el('loader').classList.toggle('hidden', !show);
        
        // Limpiador de texto para HTML seguro
        const escapeHtml = (unsafe) => {
            if (!unsafe) return '';
            return String(unsafe)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        };

        const cleanName = (str) => {
            if (!str) return 'Cliente';
            return String(str).trim();
        };

        // Toast de Notificación
        function showToast(msg, type = 'error') {
            const cont = el('toast-container');
            const div = document.createElement('div');
            div.className = `toast ${type}`;
            div.innerHTML = type === 'success' 
                ? `<i class="fas fa-check-circle mr-2"></i>${msg}` 
                : `<i class="fas fa-exclamation-circle mr-2"></i>${msg}`;
            cont.appendChild(div);
            setTimeout(() => {
                div.style.opacity = '0';
                div.style.transform = 'translateY(-10px)';
                setTimeout(() => div.remove(), 300);
            }, 3000);
        }

        // === API CALL (CON TIMEOUT AUMENTADO) ===
        async function apiCall(action, payload) {
            const controller = new AbortController();
            
            // TIMEOUT CRÍTICO: 
            // Para 'chatbot' damos 90 segundos porque Gemini tarda
            // Para login/data damos 30 segundos
            const timeLimit = (action === 'chatbot' || action === 'chat_bot') ? 90000 : 30000;
            const timeout = setTimeout(() => controller.abort(), timeLimit);

            try {
                const res = await fetch(WORKER_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action, payload }),
                    signal: controller.signal
                });

                clearTimeout(timeout);
                
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                
                // Intentamos parsear JSON
                const text = await res.text();
                let json;
                try {
                    json = JSON.parse(text);
                } catch (e) {
                    throw new Error("Respuesta inválida del servidor");
                }

                if (json.status !== 'success') throw new Error(json.message || 'Error desconocido');
                
                return json.data;

            } catch (err) {
                clearTimeout(timeout);
                if (err.name === 'AbortError') {
                    throw new Error('El servidor tardó demasiado en responder. Intenta de nuevo.');
                }
                throw new Error(err.message.includes('fetch') ? 'Sin conexión a internet' : err.message);
            }
        }

        // === INICIALIZACIÓN ===
        document.addEventListener('DOMContentLoaded', () => {
            // Listeners globales
            el('btn-login')?.addEventListener('click', handleLogin);
            
            el('login-pass')?.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') handleLogin();
            });
            
            el('chat-input')?.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') window.sendChatMessage();
            });

            // Geolocalización
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition(
                    p => { 
                        state.location = { lat: p.coords.latitude, lng: p.coords.longitude };
                        if(state.route.active.length) renderRoute(); // Actualizar distancias
                    },
                    e => console.log('Geo error (es normal si no hay HTTPS o permiso)', e),
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 }
                );
            }

            // Router simple
            if (state.user) {
                initApp();
            } else {
                switchView('view-login');
            }
        });

        // === LÓGICA DE VISTAS ===
        window.switchView = (id) => {
            document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
            const target = el(id);
            if(target) target.classList.add('active');
        };

        // === LOGIN ===
        async function handleLogin() {
            const u = el('login-user').value.trim();
            const p = el('login-pass').value.trim();
            if (!u || !p) return showToast('Ingrese usuario y pin', 'error');

            toggleLoader(true);
            try {
                const data = await apiCall('login', { user: u, pass: p });
                state.user = data;
                localStorage.setItem('ml_user', JSON.stringify(data));
                showToast(`Hola ${data.user}`, 'success');
                initApp();
            } catch (e) {
                showToast(e.message, 'error');
            } finally {
                toggleLoader(false);
            }
        }

        window.logout = () => {
            localStorage.removeItem('ml_user');
            location.reload();
        };

        // === APP CORE ===
        function initApp() {
            switchView('view-dashboard');
            loadAppData();
        }

        async function loadAppData() {
            toggleLoader(true);
            try {
                const data = await apiCall('get_app_data', { vendedor: state.user.vendedor });
                
                state.db.clients = data.clientes || [];
                state.db.zones = data.zonas || [];
                
                renderZonesDashboard();
                
                // IA Sugerencia
                if (data.sugerencia_ia?.sugerencias?.rutas_sugeridas?.length > 0) {
                    const rutas = data.sugerencia_ia.sugerencias.rutas_sugeridas.join(', ');
                    el('ia-text').innerHTML = `Hoy te recomiendo visitar: <b>${rutas}</b>`;
                    el('btn-accept-ia').onclick = () => window.acceptIARoute(rutas);
                    el('ia-suggestion-box').classList.remove('hidden');
                }

                el('lbl-saludo').innerText = `HOLA, ${String(state.user.user).toUpperCase()}`;

            } catch (e) {
                showToast('Error cargando datos: ' + e.message);
            } finally {
                toggleLoader(false);
            }
        }

        // === DASHBOARD & ZONAS ===
        function renderZonesDashboard() {
            const grid = el('zones-grid');
            grid.innerHTML = '';
            
            state.db.zones.forEach(z => {
                const btn = document.createElement('div');
                const isCrit = z.criticos > 0;
                btn.className = `p-5 rounded-2xl border cursor-pointer transition-all relative overflow-hidden group ${isCrit ? 'bg-red-900/10 border-red-500/30' : 'bg-gray-800 border-gray-700'}`;
                
                btn.onclick = () => toggleZoneSelection(z.nombre, btn);
                
                btn.innerHTML = `
                    <div class="flex justify-between items-start relative z-10">
                        <div>
                            <h3 class="font-bold text-lg text-white uppercase tracking-tight">${z.nombre}</h3>
                            <p class="text-xs text-gray-400 mt-1 font-medium">${z.total_clientes} Clientes</p>
                        </div>
                        ${isCrit ? '<div class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></div>' : ''}
                    </div>
                    ${isCrit ? `<div class="mt-3 inline-block px-2 py-1 bg-red-500/20 rounded text-[10px] font-bold text-red-400 uppercase">⚠️ ${z.criticos} Críticos</div>` : ''}
                    <div class="absolute inset-0 border-2 border-blue-500 rounded-2xl opacity-0 scale-95 transition-all group-[.selected]:opacity-100 group-[.selected]:scale-100 pointer-events-none"></div>
                `;
                grid.appendChild(btn);
            });
        }

        function toggleZoneSelection(name, btn) {
            if (state.selection.has(name)) {
                state.selection.delete(name);
                btn.classList.remove('selected');
            } else {
                state.selection.add(name);
                btn.classList.add('selected');
            }
            updateFooter();
        }

        function updateFooter() {
            const c = state.selection.size;
            const f = el('footer-dashboard');
            if (c > 0) {
                f.classList.remove('hidden');
                el('btn-start-lbl').innerText = `INICIAR RUTA (${c})`;
            } else {
                f.classList.add('hidden');
            }
        }

        window.startRoute = () => {
            const keys = Array.from(state.selection);
            // Filtramos clientes que coincidan con la localidad_key
            state.route.active = state.db.clients.filter(c => keys.includes(c.localidad_key));
            startRouteCommon();
        };

        window.acceptIARoute = (str) => {
             const keys = str.split(',').map(s => s.trim().toUpperCase());
             state.route.active = state.db.clients.filter(c => keys.some(k => (c.localidad_key||'').toUpperCase().includes(k)));
             startRouteCommon();
        };

        function startRouteCommon() {
            if(!state.route.active.length) return showToast('No hay clientes en esta selección');
            renderRoute();
            switchView('view-route');
        }

        // === RUTA (LISTA & FOCUS) ===
        window.toggleViewMode = () => {
            state.viewMode = state.viewMode === 'list' ? 'focus' : 'list';
            el('icon-view-mode').className = state.viewMode === 'list' ? 'fas fa-crop-alt' : 'fas fa-list';
            renderRoute();
        };

        function renderRoute() {
            const container = el('route-container');
            container.innerHTML = '';
            
            const pendientes = state.route.active.filter(c => !state.route.completed.has(String(c.id)));
            el('route-count').innerText = `${pendientes.length} PENDIENTES`;

            if (pendientes.length === 0) {
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full text-center mt-20 animate-pop">
                        <div class="w-24 h-24 bg-green-500/10 rounded-full flex items-center justify-center mb-4 border border-green-500/20">
                            <i class="fas fa-flag-checkered text-4xl text-green-500"></i>
                        </div>
                        <h3 class="text-2xl font-black text-white">¡Ruta Terminada!</h3>
                        <p class="text-gray-400 mt-2 text-sm">Buen trabajo hoy.</p>
                        <button onclick="window.switchView('view-dashboard')" class="mt-8 text-blue-400 font-bold bg-blue-500/10 px-6 py-3 rounded-xl hover:bg-blue-500/20">Volver al Inicio</button>
                    </div>`;
                return;
            }

            const listToRender = state.viewMode === 'focus' ? [pendientes[0]] : pendientes;

            listToRender.forEach((c, idx) => {
                let distInfo = '';
                if (state.location && c.lat && c.lng) {
                    const km = getDistKm(state.location.lat, state.location.lng, c.lat, c.lng);
                    const mins = Math.round((km / 25) * 60); // 25km/h promedio
                    distInfo = `
                        <div class="flex items-center gap-3 mt-3 bg-gray-900/50 p-2 rounded-lg border border-gray-700/50">
                            <div class="text-xs font-bold text-blue-400 flex items-center gap-1"><i class="fas fa-route"></i> ${km} km</div>
                            <div class="text-xs font-bold text-yellow-400 flex items-center gap-1"><i class="fas fa-clock"></i> ~${mins} min</div>
                        </div>
                    `;
                }

                const isFocus = state.viewMode === 'focus';
                const cardClass = isFocus 
                    ? 'h-[75vh] flex flex-col justify-between bg-gray-800 p-6 rounded-3xl shadow-2xl border border-gray-700 animate-slide-in relative overflow-hidden' 
                    : 'bg-gray-800 p-5 mb-4 rounded-2xl shadow-md border border-gray-700 animate-pop relative';

                const nameSize = isFocus ? 'text-3xl' : 'text-lg';
                const dias = c.dias_sin_comprar || 999;
                let barColor = 'bg-green-500';
                if(dias > 30) barColor = 'bg-yellow-500';
                if(dias > 60) barColor = 'bg-red-500';

                const html = `
                    <div class="absolute top-0 left-0 bottom-0 w-1 ${barColor}"></div>
                    ${isFocus ? `<div class="absolute -right-6 -top-6 text-[120px] font-black text-white/5 pointer-events-none">${state.route.active.indexOf(c) + 1}</div>` : ''}
                    
                    <div>
                        <div class="flex justify-between items-start">
                            <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest bg-gray-900/50 px-2 py-1 rounded inline-block mb-2">#${c.id} • ${c.localidad}</span>
                            <span class="text-xs font-bold text-gray-300 bg-gray-700 px-2 py-1 rounded">${dias} Días</span>
                        </div>
                        <h2 class="${nameSize} font-black text-white leading-tight uppercase mt-1">${cleanName(c.nombre)}</h2>
                        <div class="flex items-center gap-2 mt-2 text-gray-400 text-sm">
                            <i class="fas fa-map-pin text-gray-500"></i>
                            <span class="truncate">${c.direccion || 'Sin dirección'}</span>
                        </div>
                        ${distInfo}
                    </div>

                    <div class="${isFocus ? 'grid grid-cols-1 gap-4 mt-6' : 'grid grid-cols-5 gap-2 mt-5'}">
                        <button onclick="window.quickSale('${c.id}')" class="btn-press ${isFocus ? 'py-6 text-xl' : 'col-span-4 py-3 text-sm'} bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-xl shadow-lg shadow-blue-900/20 flex items-center justify-center gap-2">
                            <i class="fas fa-check-circle"></i> VENTA EXITOSA
                        </button>
                        <button onclick="window.openModal('${c.id}')" class="btn-press ${isFocus ? 'py-4 bg-gray-700' : 'col-span-1 py-3 bg-gray-700'} text-white font-bold rounded-xl flex items-center justify-center hover:bg-gray-600 border border-gray-600">
                             ${isFocus ? '<span class="mr-2 text-sm">OTRA NOVEDAD</span>' : ''} <i class="fas fa-edit"></i>
                        </button>
                    </div>
                `;

                const card = document.createElement('div');
                card.className = cardClass;
                card.innerHTML = html;
                container.appendChild(card);
            });
        }

        // === DISTANCIA ===
        function getDistKm(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2-lat1)*Math.PI/180;
            const dLon = (lon2-lon1)*Math.PI/180; 
            const a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180) * Math.sin(dLon/2)*Math.sin(dLon/2);
            return (R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a))).toFixed(1);
        }

        // === ACCIONES DE REGISTRO ===
        window.quickSale = async (id) => {
            await registerAction(id, 'pedido', 'Venta exitosa', 'Rápida');
        };

        window.saveVisit = async (motivo) => {
            if (!state.currentClientId) return;
            const obs = el('visit-obs').value;
            await registerAction(state.currentClientId, 'visita', motivo, obs);
            window.closeModal();
        };

        async function registerAction(id, tipo, motivo, obs) {
            // Optimista UI: Marcar como completado inmediatamente
            state.route.completed.add(String(id));
            renderRoute();
            
            try {
                await apiCall('registrar_movimiento', {
                    vendedor: state.user.vendedor,
                    clienteId: id,
                    tipo: tipo,
                    motivo: motivo,
                    observacion: obs
                });
                showToast(`${motivo} registrado`, 'success');
            } catch (e) {
                showToast('Guardado offline (Ocurrió error de red)', 'error');
                console.error(e);
                // NOTA: Aquí podrías implementar lógica de cola offline real si quisieras
            }
        }

        // === MODALES ===
        window.openModal = (id) => {
            state.currentClientId = id;
            const cli = state.db.clients.find(c => String(c.id) === String(id));
            el('modal-title').innerText = cli ? cleanName(cli.nombre) : 'CLIENTE';
            el('visit-obs').value = '';
            el('modal-options').classList.remove('hidden');
        };
        window.closeModal = () => el('modal-options').classList.add('hidden');

        // === CHATBOT LÓGICA (FIXED) ===
        window.toggleAIChat = (show) => {
            const m = el('modal-ai-chat');
            if(show) { 
                m.classList.remove('translate-y-full'); 
                setTimeout(() => el('chat-input').focus(), 300); 
            } else { 
                m.classList.add('translate-y-full'); 
            }
        };

        window.sendChatMessage = async () => {
            const inp = el('chat-input');
            const txt = inp.value.trim();
            if(!txt) return;
            
            appendChat(txt, 'user');
            inp.value = '';

            // Mostrar "Escribiendo..."
            el('typing-indicator').classList.remove('hidden');
            const chatBox = el('chat-messages');
            chatBox.scrollTop = chatBox.scrollHeight;

            try {
                const res = await apiCall('chatbot', { vendedor: state.user.vendedor, mensaje: txt });
                appendChat(res.respuesta, 'bot');
            } catch (e) {
                appendChat('⚠️ La IA tardó demasiado o no hay conexión. Intenta de nuevo.', 'bot');
            } finally {
                el('typing-indicator').classList.add('hidden');
            }
        };

        function appendChat(text, role) {
            const c = el('chat-messages');
            const d = document.createElement('div');
            d.className = `chat-bubble chat-${role} animate-pop`;
            
            if (role === 'bot') {
                d.innerHTML = detectAndFormatOrder(text);
            } else {
                d.innerHTML = escapeHtml(text).replace(/\n/g, '<br>');
            }
            
            c.appendChild(d);
            c.scrollTop = c.scrollHeight;
        }

        // Formateador de Pedidos en Chat
        function detectAndFormatOrder(text) {
            // Si detecta "Total:" o estructura de lista con precios
            if (text.toLowerCase().includes('total:') || (text.includes('$') && text.includes('- '))) {
                const lines = text.split('\n');
                let html = '<div class="ticket-container"><div class="ticket-header">Ticket de Pedido</div>';
                let rawOrder = ""; 

                lines.forEach(line => {
                    const l = line.trim();
                    if(!l) return;
                    rawOrder += l + "\n";
                    
                    if(l.toLowerCase().startsWith('total:')) {
                        html += `<div class="ticket-total"><span>TOTAL</span> <span>${escapeHtml(l.split(':')[1])}</span></div>`;
                    } else if (l.startsWith('-')) {
                        const parts = l.substring(1).split('$');
                        const item = parts[0].trim();
                        const price = parts.length > 1 ? '$' + parts[1].trim() : '';
                        html += `<div class="ticket-row"><span>${escapeHtml(item)}</span> <span>${escapeHtml(price)}</span></div>`;
                    } else {
                        html += `<div class="text-xs text-gray-500 mb-1">${escapeHtml(l)}</div>`;
                    }
                });

                const safeText = rawOrder.replace(/'/g, "\\'");
                html += `<button onclick="window.copyOrderText('${safeText}', this)" class="btn-copy-order"><i class="fas fa-copy"></i> COPIAR PEDIDO</button>`;
                html += '</div>';
                return html;
            }
            return escapeHtml(text).replace(/\n/g, '<br>');
        }

        window.copyOrderText = (text, btn) => {
            navigator.clipboard.writeText(text).then(() => {
                const originalContent = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check"></i> COPIADO';
                btn.classList.add('copied');
                setTimeout(() => {
                    btn.innerHTML = originalContent;
                    btn.classList.remove('copied');
                }, 2000);
            }).catch(err => showToast('Error al copiar', 'error'));
        };

    </script>
</body>
</html>

```
