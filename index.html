<!DOCTYPE html>
<html lang="es" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Mercado Limpio App</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'sans-serif'] },
          colors: {
            dark: { bg: '#0f172a', card: '#1e293b', text: '#f8fafc' },
            light: { bg: '#f1f5f9', card: '#ffffff', text: '#1e293b' }
          }
        }
      }
    }
  </script>

  <style>
    body { overflow: hidden; -webkit-tap-highlight-color: transparent; transition: background-color 0.3s, color 0.3s; }
    .no-scrollbar::-webkit-scrollbar { display: none; }

    .btn-press:active { transform: scale(0.96); transition: 0.1s; }
    @keyframes popIn { 0% { opacity: 0; transform: scale(0.9); } 100% { opacity: 1; transform: scale(1); } }
    .animate-pop { animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }

    .view-section { display: none; height: 100vh; flex-direction: column; }
    .view-section.active { display: flex; }

    .chat-bubble { max-width: 85%; padding: 12px 16px; border-radius: 18px; margin-bottom: 8px; font-size: 0.95rem; line-height: 1.4; word-wrap: break-word; }
    html:not(.dark) .chat-user { background: #2563eb; color: white; align-self: flex-end; border-bottom-right-radius: 2px; margin-left: auto; }
    html:not(.dark) .chat-bot { background: #ffffff; color: #1e293b; align-self: flex-start; border-bottom-left-radius: 2px; border: 1px solid #e2e8f0; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    html.dark .chat-user { background: #3b82f6; color: white; align-self: flex-end; border-bottom-right-radius: 2px; margin-left: auto; }
    html.dark .chat-bot { background: #334155; color: #e2e8f0; align-self: flex-start; border-bottom-left-radius: 2px; border: 1px solid #475569; }

    .ticket-box { font-family: monospace; padding: 10px; border-radius: 12px; margin-top: 6px; font-size: 0.85rem; border: 2px dashed; }
    html:not(.dark) .ticket-box { background: #f8fafc; color: #334155; border-color: #cbd5e1; }
    html.dark .ticket-box { background: #0b1224; color: #cbd5e1; border-color: #475569; }

    .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; padding: 10px 20px; border-radius: 50px; font-weight: bold; pointer-events: none; opacity: 0; transition: 0.3s; display: flex; align-items: center; gap: 8px; box-shadow: 0 10px 20px rgba(0,0,0,0.3); }

    .btn-copy-order { margin-top:10px; width:100%; padding:10px 12px; border-radius:12px; font-weight:900; font-size:12px; display:flex; justify-content:center; gap:8px; background:#2563eb; color:#fff; }
    html.dark .btn-copy-order { background:#3b82f6; }

    .typing-row { display:flex; align-items:center; gap:6px; }
    .typing-dot { width:6px; height:6px; border-radius:50%; opacity:.7; }
    html:not(.dark) .typing-dot { background:#334155; }
    html.dark .typing-dot { background:#e2e8f0; }
    @keyframes bounceDot { 0%, 80%, 100% { transform: translateY(0); opacity: .5; } 40% { transform: translateY(-4px); opacity: 1; } }
    .d1 { animation: bounceDot 1s infinite; }
    .d2 { animation: bounceDot 1s infinite .15s; }
    .d3 { animation: bounceDot 1s infinite .30s; }

    .opp-card { border-radius:16px; padding:12px; border:1px solid; }
    html:not(.dark) .opp-card { background:#ffffff; border-color:#e2e8f0; }
    html.dark .opp-card { background:#0f172a; border-color:#334155; }
    .opp-title { font-weight:900; font-size:13px; text-transform: uppercase; }
    .opp-sub { font-size:12px; opacity:.8; margin-top:2px; }
    .opp-actions { display:grid; grid-template-columns: 1fr 1fr; gap:8px; margin-top:10px; }
    .opp-btn { padding:10px 10px; border-radius:14px; font-weight:900; font-size:12px; display:flex; justify-content:center; align-items:center; gap:8px; border:1px solid transparent; }
    .opp-btn-primary { background:#16a34a; color:white; }
    .opp-btn-secondary { background:transparent; border-color:#64748b; color:#e2e8f0; }
    html:not(.dark) .opp-btn-secondary { color:#334155; border-color:#cbd5e1; }
    .opp-meta { margin-top:8px; font-size:11px; opacity:.8; display:flex; gap:10px; flex-wrap:wrap; }

    .chip { font-size:10px; font-weight:900; letter-spacing:.12em; text-transform:uppercase; border-radius:999px; padding:6px 10px; border:1px solid; display:flex; align-items:center; gap:8px; }
    html:not(.dark) .chip { background:#fff; border-color:#e2e8f0; color:#0f172a; }
    html.dark .chip { background:#0b1224; border-color:#334155; color:#e2e8f0; }
  </style>
</head>

<body class="bg-light-bg dark:bg-dark-bg text-light-text dark:text-dark-text">

  <div id="loader" class="fixed inset-0 z-[100] bg-black/80 flex flex-col items-center justify-center hidden backdrop-blur-sm">
    <div class="w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
    <p class="mt-4 text-xs font-bold text-blue-400 tracking-widest animate-pulse">CARGANDO...</p>
  </div>

  <div id="toast" class="toast bg-slate-800 text-white border border-slate-600"></div>

  <!-- LOGIN -->
  <section id="view-login" class="view-section active justify-center p-8 bg-slate-900 relative">
    <div class="w-full max-w-sm text-center mx-auto z-10">
      <div class="w-20 h-20 bg-blue-600 rounded-2xl mx-auto flex items-center justify-center mb-6 shadow-2xl shadow-blue-500/30 rotate-3">
        <i class="fas fa-box text-3xl text-white"></i>
      </div>
      <h1 class="text-3xl font-black mb-2 text-white">MERCADO<span class="text-blue-500">LIMPIO</span></h1>
      <p class="text-slate-400 text-xs font-bold uppercase tracking-[0.3em] mb-10">Ventas & Logística</p>

      <input id="login-user" type="text" class="w-full bg-slate-800 border border-slate-700 rounded-xl p-4 mb-3 text-center font-bold uppercase placeholder-slate-500 text-white focus:border-blue-500 outline-none" placeholder="USUARIO">
      <input id="login-pass" type="password" inputmode="numeric" class="w-full bg-slate-800 border border-slate-700 rounded-xl p-4 mb-6 text-center font-bold uppercase placeholder-slate-500 text-white focus:border-blue-500 outline-none" placeholder="PIN">

      <button onclick="handleLogin()" class="btn-press w-full bg-blue-600 p-4 rounded-xl font-bold shadow-lg shadow-blue-900/40 text-white">INGRESAR</button>
    </div>
  </section>

  <!-- DASHBOARD -->
  <section id="view-dashboard" class="view-section bg-slate-50 dark:bg-slate-950">
    <div class="px-6 pt-10 pb-4 bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-800 sticky top-0 z-10 flex justify-between items-end">
      <div>
        <p class="text-[10px] text-blue-500 font-bold uppercase mb-1">Bienvenido</p>
        <h2 class="text-2xl font-black leading-none">HOLA, <span id="lbl-saludo">...</span></h2>
      </div>
      <div class="flex gap-2">
        <button onclick="toggleTheme()" class="w-9 h-9 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-500 dark:text-slate-400 flex items-center justify-center border border-slate-200 dark:border-slate-700">
          <i class="fas fa-adjust"></i>
        </button>
        <button onclick="logout()" class="w-9 h-9 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-500 dark:text-slate-400 hover:text-red-500 flex items-center justify-center border border-slate-200 dark:border-slate-700">
          <i class="fas fa-power-off text-xs"></i>
        </button>
      </div>
    </div>

    <div class="flex-1 overflow-y-auto p-4 pb-24 no-scrollbar">
      <p class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-3 ml-1">Zonas Disponibles</p>
      <div id="zones-grid" class="grid grid-cols-2 gap-3"></div>
    </div>

    <div id="footer-dashboard" class="p-4 bg-white dark:bg-slate-900 border-t border-slate-200 dark:border-slate-800 fixed bottom-0 w-full hidden z-20">
      <button onclick="startRoute()" class="btn-press w-full bg-blue-600 text-white py-4 rounded-xl font-bold shadow-lg flex justify-center items-center gap-2">
        <i class="fas fa-location-arrow"></i> <span id="btn-start-lbl">INICIAR</span>
      </button>
    </div>

    <button onclick="toggleAIChat(true)" class="fixed bottom-6 right-6 w-14 h-14 bg-indigo-600 rounded-full shadow-xl flex items-center justify-center z-30 btn-press text-white border-2 border-white dark:border-slate-700">
      <i class="fas fa-headset text-xl"></i>
    </button>
  </section>

  <!-- RUTA -->
  <section id="view-route" class="view-section bg-slate-100 dark:bg-slate-950">
    <!-- HEADER CORREGIDO: incluye route-count -->
    <div class="px-4 py-3 bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-800 sticky top-0 z-10 flex justify-between items-center shadow-sm h-16">
      <button onclick="switchView('view-dashboard')" class="w-10 h-10 bg-slate-50 dark:bg-slate-800 rounded-xl text-slate-500 dark:text-slate-400 border border-slate-200 dark:border-slate-700">
        <i class="fas fa-chevron-left"></i>
      </button>

      <div class="flex items-center gap-2">
        <div class="flex items-center gap-2 bg-slate-100 dark:bg-slate-800 px-3 py-1 rounded-full border border-slate-200 dark:border-slate-700">
          <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
          <span id="route-count" class="text-sm font-bold">0</span>
        </div>

        <div id="chip-jornada" class="chip">
          <i class="fas fa-sun"></i>
          <span id="chip-jornada-txt">JORNADA</span>
        </div>
      </div>

      <div class="flex items-center gap-2">
        <button onclick="openFinishModal()" class="w-10 h-10 bg-red-50 dark:bg-red-900/20 rounded-xl text-red-600 dark:text-red-400 border border-red-200 dark:border-red-900/40">
          <i class="fas fa-flag-checkered"></i>
        </button>

        <button onclick="toggleViewMode()" class="w-10 h-10 bg-slate-50 dark:bg-slate-800 rounded-xl text-blue-500 border border-slate-200 dark:border-slate-700">
          <i id="icon-view-mode" class="fas fa-list"></i>
        </button>
      </div>
    </div>

    <div class="px-4 py-2 bg-slate-50 dark:bg-slate-900 border-b border-slate-200 dark:border-slate-800 flex justify-center gap-4 text-[10px] font-bold text-slate-500 uppercase">
      <div class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-green-500"></span> Al día</div>
      <div class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-yellow-500"></span> +30 Días</div>
      <div class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-red-500"></span> +60 Días</div>
    </div>

    <div id="route-container" class="flex-1 overflow-y-auto p-4 pb-20 no-scrollbar relative space-y-3"></div>
  </section>

  <!-- MODAL FINALIZAR -->
  <div id="modal-finish" class="fixed inset-0 z-[90] bg-black/70 hidden items-center justify-center p-4 backdrop-blur-sm">
    <div class="bg-white dark:bg-slate-900 w-full max-w-sm rounded-3xl p-6 shadow-2xl animate-pop border border-slate-200 dark:border-slate-700">
      <div class="flex items-start justify-between">
        <div>
          <h3 class="text-lg font-black dark:text-white">Finalizar jornada</h3>
          <p id="finish-sub" class="text-xs text-slate-500 dark:text-slate-400 mt-1">...</p>
        </div>
        <button onclick="closeFinishModal()" class="w-10 h-10 rounded-xl bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 border border-slate-200 dark:border-slate-700">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="mt-4 space-y-3">
        <button onclick="finishJornada(true)" class="btn-press w-full py-3 rounded-xl font-black bg-red-600 text-white flex items-center justify-center gap-2">
          <i class="fas fa-check-double"></i> Finalizar y marcar pendientes “No llegué”
        </button>

        <button onclick="finishJornada(false)" class="btn-press w-full py-3 rounded-xl font-black bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-200 border border-slate-200 dark:border-slate-700">
          Finalizar sin marcar pendientes
        </button>

        <button onclick="closeFinishModal()" class="btn-press w-full py-3 rounded-xl font-black bg-transparent text-slate-500 dark:text-slate-400">
          Cancelar
        </button>
      </div>
    </div>
  </div>

  <!-- MODAL SUGGESTIONS -->
  <div id="modal-suggestions" class="fixed inset-0 z-50 bg-black/60 flex items-center justify-center hidden p-4 backdrop-blur-sm">
    <div class="bg-white dark:bg-slate-800 w-full max-w-sm rounded-3xl p-6 shadow-2xl animate-pop">
      <div class="text-center mb-6">
        <h3 class="text-xl font-black dark:text-white">Plan Sugerido</h3>
        <p class="text-sm text-slate-500 dark:text-slate-400">Selecciona las zonas para hoy:</p>
      </div>
      <div id="suggestions-list" class="space-y-2 mb-6 max-h-60 overflow-y-auto"></div>
      <div class="grid grid-cols-2 gap-3">
        <button onclick="el('modal-suggestions').classList.add('hidden')" class="btn-press py-3 rounded-xl font-bold bg-slate-100 dark:bg-slate-700 text-slate-500 dark:text-slate-300">Omitir</button>
        <button onclick="applySuggestions()" class="btn-press py-3 rounded-xl font-bold bg-blue-600 text-white">Confirmar</button>
      </div>
    </div>
  </div>

  <!-- CHAT -->
  <div id="modal-chat" class="fixed inset-0 z-50 bg-black/50 hidden flex flex-col justify-end sm:justify-center items-center backdrop-blur-sm">
    <div id="chat-panel" class="bg-slate-50 dark:bg-slate-950 w-full sm:max-w-md h-[80vh] sm:rounded-3xl rounded-t-3xl shadow-2xl flex flex-col transform translate-y-full transition-transform duration-300">
      <div class="p-4 bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-800 flex justify-between items-center rounded-t-3xl">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-full bg-indigo-600 flex items-center justify-center text-white"><i class="fas fa-robot"></i></div>
          <h3 class="font-bold text-sm dark:text-white">Mercado Limpio</h3>
        </div>
        <button onclick="toggleAIChat(false)" class="w-8 h-8 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-500 flex items-center justify-center"><i class="fas fa-times"></i></button>
      </div>

      <div id="chat-msgs" class="flex-1 overflow-y-auto p-4 flex flex-col gap-3">
        <div class="chat-bubble chat-bot">Hola, soy el soporte de Mercado Limpio. ¿Qué necesitas?</div>
      </div>

      <div class="p-4 bg-white dark:bg-slate-900 border-t border-slate-200 dark:border-slate-800 pb-6">
        <div class="flex gap-2 bg-slate-100 dark:bg-slate-800 p-1.5 rounded-2xl border border-slate-200 dark:border-slate-700">
          <input id="chat-in" type="text" placeholder="Escribe tu consulta..." class="flex-1 bg-transparent border-0 px-3 text-sm dark:text-white outline-none">
          <button onclick="sendChat()" class="w-10 h-10 bg-blue-600 rounded-xl text-white flex items-center justify-center"><i class="fas fa-paper-plane text-xs"></i></button>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL REG -->
  <div id="modal-reg" class="fixed inset-0 z-[60] bg-black/80 hidden flex items-center justify-center p-6 backdrop-blur-sm">
    <div class="bg-white dark:bg-slate-800 w-full max-w-sm rounded-3xl p-6 shadow-2xl animate-pop">
      <h3 id="reg-title" class="text-xl font-black mb-1 dark:text-white">CLIENTE</h3>
      <div id="reg-info" class="text-xs text-slate-500 mb-4">...</div>
      <div class="grid grid-cols-2 gap-3 mb-4">
        <button onclick="selectReason('Stock', this)" class="reason-btn btn-press bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 p-4 rounded-xl text-left">
          <i class="fas fa-box text-blue-500 block mb-2 text-xl"></i><span class="text-[10px] font-bold uppercase text-slate-600 dark:text-slate-300">Tiene Stock</span>
        </button>
        <button onclick="selectReason('Dinero', this)" class="reason-btn btn-press bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 p-4 rounded-xl text-left">
          <i class="fas fa-wallet text-red-500 block mb-2 text-xl"></i><span class="text-[10px] font-bold uppercase text-slate-600 dark:text-slate-300">Sin Dinero</span>
        </button>
        <button onclick="selectReason('Cerrado', this)" class="reason-btn btn-press bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 p-4 rounded-xl text-left">
          <i class="fas fa-store-slash text-yellow-500 block mb-2 text-xl"></i><span class="text-[10px] font-bold uppercase text-slate-600 dark:text-slate-300">Cerrado</span>
        </button>
        <button onclick="selectReason('Volver', this)" class="reason-btn btn-press bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 p-4 rounded-xl text-left">
          <i class="fas fa-clock text-purple-500 block mb-2 text-xl"></i><span class="text-[10px] font-bold uppercase text-slate-600 dark:text-slate-300">Volver</span>
        </button>
      </div>
      <textarea id="reg-obs" class="w-full bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl p-3 text-sm h-20 mb-4 resize-none dark:text-white outline-none" placeholder="Nota opcional..."></textarea>
      <div class="flex gap-3">
        <button onclick="el('modal-reg').classList.add('hidden')" class="flex-1 py-3 bg-slate-100 dark:bg-slate-700 rounded-xl font-bold dark:text-white">Cancelar</button>
        <button onclick="commitSave()" class="flex-1 py-3 bg-slate-900 dark:bg-blue-600 text-white rounded-xl font-bold">GUARDAR</button>
      </div>
    </div>
  </div>

  <!-- MODAL PEDIDO -->
  <div id="modal-order" class="fixed inset-0 z-[80] bg-black/70 hidden items-center justify-center p-4 backdrop-blur-sm">
    <div class="bg-white dark:bg-slate-900 w-full sm:max-w-lg rounded-3xl p-5 shadow-2xl animate-pop border border-slate-200 dark:border-slate-700">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-[10px] font-black uppercase tracking-widest text-blue-500">Último pedido</p>
          <h3 id="order-title" class="text-lg font-black dark:text-white">Cliente</h3>
        </div>
        <button onclick="closeOrderModal()" class="w-10 h-10 rounded-xl bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 border border-slate-200 dark:border-slate-700">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="mt-4">
        <div class="ticket-box">
          <div id="order-ticket" style="white-space: pre-wrap;"></div>
        </div>
      </div>

      <div class="mt-4 grid grid-cols-2 gap-3">
        <button onclick="copyCurrentOrder()" class="btn-press py-3 rounded-xl font-black bg-blue-600 text-white flex items-center justify-center gap-2">
          <i class="fas fa-copy"></i> Copiar
        </button>
        <button onclick="closeOrderModal()" class="btn-press py-3 rounded-xl font-black bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-200 border border-slate-200 dark:border-slate-700">
          Cerrar
        </button>
      </div>
    </div>
  </div>

  <script>
    const WORKER = 'https://frosty-term-20ea.santamariapablodaniel.workers.dev/';
    const OUTBOX_KEY = 'ml_outbox_v1';

    // Jornada persistente por vendedor
    const JDAY = () => new Date().toISOString().slice(0, 10); // yyyy-mm-dd
    const nowTurno = () => (new Date().getHours() >= 14 ? 'Tarde' : 'Mañana');

    const state = {
      user: JSON.parse(localStorage.getItem('ml_user')),
      db: {},
      route: { active: [], done: new Set() },
      sel: new Set(),
      mode: 'list',
      cliId: null,
      tempReason: null,
      location: null,
      currentOrder: { title: '', ticket: '' },
      outboxFlushing: false,
      jornada: null
    };

    const JKEY = () => `ml_active_jornada_${(state.user?.vendedor || 'NA')}`;
    const el = id => document.getElementById(id);

    const toast = (m, t) => {
      const d = el('toast');
      if (!d) return;
      d.innerHTML = t === 'error'
        ? `<i class="fas fa-exclamation-circle text-red-400"></i> ${m}`
        : `<i class="fas fa-check-circle text-green-400"></i> ${m}`;
      d.style.opacity = 1;
      d.style.top = '30px';
      setTimeout(() => { d.style.opacity = 0; d.style.top = '20px'; }, 2500);
    };

    async function api(act, pl) {
      const ctrl = new AbortController();
      setTimeout(() => ctrl.abort(), 45000);
      const r = await fetch(WORKER, { method: 'POST', body: JSON.stringify({ action: act, payload: pl }), signal: ctrl.signal });
      const j = await r.json();
      if (j.status !== 'success') throw new Error(j.message || 'Error');
      return j.data;
    }

    document.addEventListener('DOMContentLoaded', () => {
      if (localStorage.getItem('ml_theme') === 'light') document.documentElement.classList.remove('dark');
      if (state.user) init(); else switchView('view-login');

      if (navigator.geolocation) navigator.geolocation.watchPosition(updateDistances, null, { enableHighAccuracy: true });

      const chatIn = el('chat-in');
      if (chatIn) chatIn.addEventListener('keydown', (e) => { if (e.key === 'Enter') sendChat(); });

      window.addEventListener('online', () => flushOutbox());
      setTimeout(() => flushOutbox(), 1500);
    });

    function displayName(cli) {
      if (!cli) return '';
      const a = String(cli.apellido || '').trim();
      const n = String(cli.nombre || '').trim();
      const full = String(cli.nombre_full || '').trim();
      const merged = [n, a].filter(Boolean).join(' ').trim();
      return (full || merged || n || a || 'SIN NOMBRE').trim();
    }

    function toggleTheme() {
      const html = document.documentElement;
      if (html.classList.contains('dark')) { html.classList.remove('dark'); localStorage.setItem('ml_theme', 'light'); }
      else { html.classList.add('dark'); localStorage.setItem('ml_theme', 'dark'); }
    }

    function switchView(id) {
      document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
      const node = el(id);
      if (node) node.classList.add('active');
    }

    async function handleLogin() {
      const u = el('login-user')?.value?.trim() || '';
      const p = el('login-pass')?.value?.trim() || '';
      if (!u || !p) return toast('Faltan datos', 'error');

      el('loader')?.classList.remove('hidden');
      try {
        const d = await api('login', { user: u, pass: p });
        state.user = d;
        localStorage.setItem('ml_user', JSON.stringify(d));
        init();
      } catch (e) {
        toast(e.message, 'error');
      } finally {
        el('loader')?.classList.add('hidden');
      }
    }
    function logout() { localStorage.removeItem('ml_user'); location.reload(); }

    // ========== Jornada local ==========
    function loadJornadaLocal() {
      try {
        const raw = localStorage.getItem(JKEY());
        if (!raw) return null;
        const j = JSON.parse(raw);
        if (!j || j.status !== 'ACTIVE') return null;
        if (j.date !== JDAY()) return null;
        return j;
      } catch (_) { return null; }
    }

    function saveJornadaLocal(j) {
      try { localStorage.setItem(JKEY(), JSON.stringify(j)); } catch (_) {}
    }

    function clearJornadaLocal() {
      try { localStorage.removeItem(JKEY()); } catch (_) {}
    }

    function setChipJornada() {
      const chip = el('chip-jornada');
      const txt = el('chip-jornada-txt');
      if (!chip || !txt) return;

      const j = state.jornada;
      const turno = j?.turno || nowTurno();
      const zonas = (j?.zonas || []).slice(0, 2).join(', ');
      const icon = chip.querySelector('i');

      if (turno === 'Tarde') { if (icon) icon.className = 'fas fa-moon'; }
      else { if (icon) icon.className = 'fas fa-sun'; }

      txt.textContent = j && j.status === 'ACTIVE'
        ? `${turno} · ${zonas || 'Ruta'}`
        : `${turno} · sin jornada`;
    }

    async function startJornadaBackend(zonas, turno) {
      const payload = { vendedor: state.user.vendedor, zonas: zonas, turno: turno };
      try { return await api('start_jornada', payload); }
      catch (_) { enqueueOutbox('start_jornada', payload); return null; }
    }

    async function finalizeJornadaBackend(jornadaId, marcarPendientes, pendientes) {
      const payload = { vendedor: state.user.vendedor, jornadaId, marcarPendientes, pendientes };
      try { return await api('finalizar_jornada', payload); }
      catch (_) { enqueueOutbox('finalizar_jornada', payload); return null; }
    }

    async function registrarPendientesBatch(pendientes) {
      const items = pendientes.map(cid => ({
        clienteId: String(cid),
        tipo: 'visita',
        motivo: 'No llegue',
        observacion: 'Cierre de jornada con pendientes'
      }));
      const payload = { vendedor: state.user.vendedor, items };
      try { return await api('registrar_batch', payload); }
      catch (_) { enqueueOutbox('registrar_batch', payload); return null; }
    }

    function resumeFromJornadaLocal(j) {
      const byId = new Map((state.db.clientes || []).map(c => [String(c.id), c]));
      const active = [];
      (j.clientIds || []).forEach(id => { if (byId.has(String(id))) active.push(byId.get(String(id))); });

      if (!active.length && j.zonas?.length) {
        active.push(...(state.db.clientes || []).filter(c => j.zonas.some(z => String(z).toUpperCase() === String(c.localidad_key).toUpperCase())));
      }

      state.route.active = active;
      state.route.done = new Set((j.doneIds || []).map(String));
      renderRoute();
      switchView('view-route');
      toast('Reanudando jornada…', 'success');
    }

    // ========== Init ==========
    async function init() {
      switchView('view-dashboard');
      const lbl = el('lbl-saludo');
      if (lbl) lbl.innerText = (state.user?.user || '').toUpperCase();

      el('loader')?.classList.remove('hidden');
      try {
        const d = await api('get_app_data', { vendedor: state.user.vendedor });
        state.db = d;

        renderGrid();

        const localJ = loadJornadaLocal();
        if (!localJ && d.sugerencia_ia?.sugerencias?.rutas_sugeridas?.length) {
          showSuggestions(d.sugerencia_ia.sugerencias.rutas_sugeridas);
        }

        if (localJ) {
          state.jornada = localJ;
          setChipJornada();
          resumeFromJornadaLocal(localJ);
        } else {
          state.jornada = { status: 'ACTIVE', date: JDAY(), turno: d.jornada_activa?.turno || nowTurno(), zonas: d.jornada_activa?.zonas || [] };
          setChipJornada();
        }

        flushOutbox();
      } catch (e) {
        toast('Error cargando', 'error');
      } finally {
        el('loader')?.classList.add('hidden');
      }
    }

    // ========== GRID ==========
    function renderGrid() {
      const g = el('zones-grid');
      if (!g) return;
      g.innerHTML = '';

      (state.db.zonas || []).forEach(z => {
        const crit = z.criticos > 0;
        const d = document.createElement('div');
        d.className = `p-4 rounded-2xl border transition-all cursor-pointer relative overflow-hidden bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700 shadow-sm hover:border-blue-500`;
        d.onclick = () => toggleSel(z.nombre, d);

        const last = z.ultima_visita ? `${z.ultima_visita}${z.ultimo_turno ? ` (${String(z.ultimo_turno)[0]})` : ''}` : '';
        const days = (z.dias_desde !== "" && z.dias_desde != null) ? `${z.dias_desde}d` : '';

        d.innerHTML = `
          <h3 class="font-bold text-sm uppercase dark:text-white truncate">${escapeHtml(String(z.nombre || ''))}</h3>
          <div class="flex justify-between items-end mt-3">
            <span class="text-xs text-slate-500 font-medium bg-slate-100 dark:bg-slate-700 px-2 py-1 rounded-lg">${escapeHtml(String(z.total_clientes || 0))} Clientes</span>
            ${crit ? '<i class="fas fa-exclamation-circle text-red-500 animate-pulse"></i>' : '<i class="fas fa-map-pin text-slate-300"></i>'}
          </div>
          ${last ? `<div class="mt-2 text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase tracking-widest">Última: ${escapeHtml(last)} ${days ? `· ${escapeHtml(days)}` : ''}</div>` : `<div class="mt-2 text-[10px] font-bold text-slate-400 uppercase tracking-widest">Última: —</div>`}
          <div class="sel-overlay absolute top-2 right-2 hidden"><i class="fas fa-check-circle text-blue-600 text-xl bg-white rounded-full"></i></div>
          <div class="sel-border absolute inset-0 border-2 border-blue-600 rounded-2xl hidden pointer-events-none"></div>
        `;
        g.appendChild(d);
      });
    }

    function toggleSel(n, div) {
      const ov = div.querySelector('.sel-overlay');
      const bd = div.querySelector('.sel-border');

      if (state.sel.has(n)) { state.sel.delete(n); ov?.classList.add('hidden'); bd?.classList.add('hidden'); }
      else { state.sel.add(n); ov?.classList.remove('hidden'); bd?.classList.remove('hidden'); }

      const c = state.sel.size;
      el('footer-dashboard')?.classList.toggle('hidden', c === 0);
      const b = el('btn-start-lbl');
      if (b) b.innerText = `INICIAR (${c})`;
    }

    function showSuggestions(list) {
      const c = el('suggestions-list');
      if (!c) return;
      c.innerHTML = '';

      list.forEach(loc => {
        const b = document.createElement('div');
        b.className = 'w-full p-3 rounded-xl bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 flex justify-between items-center mb-2 cursor-pointer';
        b.onclick = function () {
          const i = this.querySelector('i');
          if (state.sel.has(loc)) { state.sel.delete(loc); if (i) i.className = 'far fa-circle text-slate-400 text-lg'; this.classList.remove('border-blue-500'); }
          else { state.sel.add(loc); if (i) i.className = 'fas fa-check-circle text-blue-600 text-lg'; this.classList.add('border-blue-500'); }
          const c2 = state.sel.size;
          el('footer-dashboard')?.classList.toggle('hidden', c2 === 0);
          const b2 = el('btn-start-lbl');
          if (b2) b2.innerText = `INICIAR (${c2})`;
        };
        b.innerHTML = `<span class="font-bold text-sm dark:text-white">${escapeHtml(String(loc))}</span><i class="far fa-circle text-slate-400 text-lg"></i>`;
        c.appendChild(b);
      });

      el('modal-suggestions')?.classList.remove('hidden');
    }

    function applySuggestions() {
      if (state.sel.size > 0) startRoute();
      el('modal-suggestions')?.classList.add('hidden');
    }

    // ========== START ROUTE ==========
    async function startRoute() {
      const k = Array.from(state.sel).map(x => String(x).toUpperCase());
      if (!k.length) return;

      state.route.active = (state.db.clientes || []).filter(c => k.some(sel => String(sel) === String(c.localidad_key).toUpperCase()));
      state.route.done = new Set();

      const clientIds = state.route.active.map(c => String(c.id));
      const turno = nowTurno();

      const jLocal = {
        date: JDAY(),
        turno,
        zonas: k,
        clientIds,
        doneIds: [],
        jornadaId: null,
        startedAt: Date.now(),
        status: 'ACTIVE'
      };
      state.jornada = jLocal;
      saveJornadaLocal(jLocal);
      setChipJornada();

      const r = await startJornadaBackend(k, turno);
      if (r && r.jornadaId) {
        state.jornada.jornadaId = r.jornadaId;
        saveJornadaLocal(state.jornada);
      }

      renderRoute();
      switchView('view-route');
    }

    // ========== ROUTE ==========
    function syncJornadaDoneLocal() {
      if (!state.jornada || state.jornada.status !== 'ACTIVE') return;
      state.jornada.doneIds = Array.from(state.route.done).map(String);
      saveJornadaLocal(state.jornada);
    }

    function renderRoute() {
      const c = el('route-container');
      if (!c) return;

      c.innerHTML = '';
      const pends = (state.route.active || []).filter(x => !state.route.done.has(String(x.id)));

      setChipJornada();

      const rc = el('route-count');
      if (rc) rc.innerText = String(pends.length);

      if (!pends.length) {
        c.innerHTML = '<div class="text-center mt-20 opacity-50"><i class="fas fa-clipboard-check text-6xl text-slate-300 mb-4"></i><h3 class="text-xl font-bold dark:text-white">¡Ruta Completada!</h3></div>';
        if (rc) rc.innerText = '0';
        return;
      }

      const list = state.mode === 'focus' ? [pends[0]] : pends;

      list.forEach((cli) => {
        const days = Number(cli.dias_sin_comprar ?? 999);
        let col = days > 60 ? 'bg-red-500' : (days > 30 ? 'bg-yellow-500' : 'bg-green-500');

        const name = displayName(cli).toUpperCase();

        const div = document.createElement('div');
        div.id = `card-${cli.id}`;
        div.className = state.mode === 'focus'
          ? 'h-[75vh] flex flex-col justify-between bg-white dark:bg-slate-900 p-6 rounded-3xl border border-slate-200 dark:border-slate-700 relative overflow-hidden shadow-xl'
          : 'bg-white dark:bg-slate-900 p-4 rounded-2xl border border-slate-200 dark:border-slate-700 relative shadow-sm';

        div.innerHTML = `
          <div class="absolute left-0 top-0 bottom-0 w-1.5 ${col}"></div>
          <div class="flex justify-between pl-3 mb-1">
            <span class="text-[10px] font-bold text-slate-400 uppercase">#${escapeHtml(String(cli.id))}</span>
            <span class="text-[10px] bg-slate-100 dark:bg-slate-800 px-2 py-0.5 rounded text-slate-500 font-bold">${escapeHtml(String(days))} días</span>
          </div>
          <h2 class="${state.mode === 'focus' ? 'text-3xl' : 'text-lg'} font-black uppercase leading-tight dark:text-white pl-3">${escapeHtml(name)}</h2>
          <p class="text-slate-500 text-xs mt-1 truncate pl-3 flex items-center gap-1"><i class="fas fa-location-dot text-slate-300"></i> ${escapeHtml(String(cli.direccion || ''))}</p>
          <div id="dist-${cli.id}" class="text-xs font-bold text-blue-600 mt-3 h-4 pl-3" data-lat="${escapeHtml(String(cli.lat || ''))}" data-lng="${escapeHtml(String(cli.lng || ''))}">...</div>
          <div class="grid grid-cols-4 gap-2 mt-4 pl-3">
            <button onclick="quickSale('${escapeAttr(String(cli.id))}')" class="col-span-3 bg-slate-900 dark:bg-blue-600 py-3 rounded-xl font-bold text-white shadow-md active:scale-95 flex justify-center items-center gap-2"><i class="fas fa-check"></i> Venta</button>
            <button onclick="openReg('${escapeAttr(String(cli.id))}')" class="col-span-1 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-600 dark:text-white rounded-xl active:scale-95"><i class="fas fa-ellipsis-h"></i></button>
          </div>
        `;
        c.appendChild(div);
      });

      updateDistances();
      syncJornadaDoneLocal();
    }

    function updateDistances(pos) {
      if (pos) state.location = { lat: pos.coords.latitude, lng: pos.coords.longitude };
      if (!state.location) return;

      document.querySelectorAll('[id^="dist-"]').forEach(node => {
        const lat = node.getAttribute('data-lat');
        const lng = node.getAttribute('data-lng');
        if (lat && lng && isFinite(Number(lat)) && isFinite(Number(lng))) {
          const km = getKm(state.location.lat, state.location.lng, Number(lat), Number(lng));
          node.innerHTML = `<i class="fas fa-route"></i> ${km} km <span class="text-slate-400 font-normal ml-2">~${Math.round(km / 20 * 60)} min</span>`;
        } else node.innerHTML = '';
      });
    }

    function getKm(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
      return (R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a))).toFixed(1);
    }

    // ========== FINALIZAR ==========
    function openFinishModal() {
      const pendingIds = (state.route.active || [])
        .filter(c => !state.route.done.has(String(c.id)))
        .map(c => String(c.id));

      const zonas = (state.jornada?.zonas || Array.from(state.sel)).join(', ') || '—';
      const sub = el('finish-sub');
      if (sub) sub.innerText = pendingIds.length
        ? `Zonas: ${zonas}. Quedan ${pendingIds.length} clientes pendientes.`
        : `Zonas: ${zonas}. No quedan pendientes.`;

      const m = el('modal-finish');
      if (m) { m.classList.remove('hidden'); m.classList.add('flex'); }
    }

    function closeFinishModal() {
      const m = el('modal-finish');
      if (m) { m.classList.add('hidden'); m.classList.remove('flex'); }
    }

    async function finishJornada(marcarPendientes) {
      closeFinishModal();

      const j = state.jornada;
      if (!j || j.status !== 'ACTIVE') { toast('No hay jornada activa', 'error'); return; }

      const pendingIds = (state.route.active || [])
        .filter(c => !state.route.done.has(String(c.id)))
        .map(c => String(c.id));

      j.status = 'CLOSED';
      saveJornadaLocal(j);

      if (marcarPendientes && pendingIds.length) {
        await registrarPendientesBatch(pendingIds);
        pendingIds.forEach(id => state.route.done.add(String(id)));
      }

      if (j.jornadaId) await finalizeJornadaBackend(j.jornadaId, marcarPendientes, pendingIds);
      else enqueueOutbox('finalizar_jornada', { vendedor: state.user.vendedor, jornadaId: "", marcarPendientes, pendientes: pendingIds });

      clearJornadaLocal();
      state.jornada = null;
      setChipJornada();

      state.route.active = [];
      state.route.done = new Set();
      state.sel = new Set();
      renderGrid();
      switchView('view-dashboard');

      toast('Jornada finalizada', 'success');
      flushOutbox();
    }

    // ========== REGISTROS ==========
    function openReg(id) {
      state.cliId = id;
      state.tempReason = null;
      const c = (state.db.clientes || []).find(x => String(x.id) == String(id));
      const title = el('reg-title');
      if (title) title.innerText = displayName(c).toUpperCase();
      const obs = el('reg-obs');
      if (obs) obs.value = '';

      let info = `<span class="text-green-600 font-bold">Cliente Activo</span>`;
      if (c && Number(c.dias_sin_comprar) > 60) info = `<span class="text-red-500 font-bold bg-red-50 px-2 py-1 rounded border border-red-100">⚠️ CRÍTICO: +60 DÍAS</span>`;
      const ri = el('reg-info');
      if (ri) ri.innerHTML = info;

      el('modal-reg')?.classList.remove('hidden');
    }

    function selectReason(r, b) {
      state.tempReason = r;
      document.querySelectorAll('.reason-btn').forEach(btn => btn.classList.remove('ring-2', 'ring-blue-500'));
      b.classList.add('ring-2', 'ring-blue-500');
    }

    function quickSale(id) {
      doRegOptimistic(id, 'pedido', 'Venta OK', 'Rápida');
    }

    function commitSave() {
      if (!state.tempReason && !(el('reg-obs')?.value || '')) return toast('Ingresa motivo', 'error');
      const id = state.cliId;
      const reason = state.tempReason || 'Nota';
      const obs = el('reg-obs')?.value || '';

      el('modal-reg')?.classList.add('hidden');
      doRegOptimistic(id, 'visita', reason, obs);
    }

    function doRegOptimistic(id, tipo, motivo, observacion) {
      const cid = String(id);

      state.route.done.add(cid);
      renderRoute();
      syncJornadaDoneLocal();

      const payload = { vendedor: state.user.vendedor, clienteId: cid, tipo, motivo, observacion };
      sendInBackground('registrar_movimiento', payload);
    }

    async function sendInBackground(action, payload) {
      try {
        await api(action, payload);
        toast('Guardado', 'success');
        flushOutbox();
      } catch (e) {
        enqueueOutbox(action, payload);
        toast('Sin señal: quedó en cola', 'error');
      }
    }

    // ========== OUTBOX ==========
    function enqueueOutbox(action, payload) {
      const list = getOutbox();
      list.push({ action, payload, ts: Date.now() });
      localStorage.setItem(OUTBOX_KEY, JSON.stringify(list));
    }

    function getOutbox() {
      try {
        const raw = localStorage.getItem(OUTBOX_KEY);
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr : [];
      } catch (_) { return []; }
    }

    async function flushOutbox() {
      if (state.outboxFlushing) return;
      const list = getOutbox();
      if (!list.length) return;

      state.outboxFlushing = true;
      try {
        await api('ping', {});

        let remaining = [...list];
        const sent = [];

        for (const item of list) {
          try {
            await api(item.action, item.payload);
            sent.push(item);
            remaining.shift();
          } catch (_) {
            break;
          }
        }

        localStorage.setItem(OUTBOX_KEY, JSON.stringify(remaining));
        if (sent.length) toast(`Sync OK: ${sent.length}`, 'success');
      } catch (_) {
      } finally {
        state.outboxFlushing = false;
      }
    }

    function toggleViewMode() {
      state.mode = state.mode === 'list' ? 'focus' : 'list';
      renderRoute();
    }

    // ========== CHAT ==========
    function toggleAIChat(s) {
      const m = el('modal-chat'), p = el('chat-panel');
      if (!m || !p) return;

      if (s) {
        m.classList.remove('hidden');
        setTimeout(() => p.classList.remove('translate-y-full'), 10);
        setTimeout(() => el('chat-in')?.focus(), 250);
      } else {
        p.classList.add('translate-y-full');
        setTimeout(() => m.classList.add('hidden'), 300);
      }
    }

    async function sendChat() {
      const i = el('chat-in');
      const t = (i?.value || '').trim();
      if (!t) return;

      addMsg(t, 'user');
      i.value = '';

      const typingEl = addTyping();

      try {
        const res = await api('chatbot', { vendedor: state.user.vendedor, mensaje: t });
        const r = res.respuesta || {};

        removeTyping(typingEl);

        if (r.type === 'ticket') {
          addMsg(r.text || 'Listo.', 'bot');
          addTicket(r.data || '');
        } else if (r.type === 'route') {
          addMsg(r.text || 'Dale.', 'bot');
          addRouteBtn(r.data || '');
        } else {
          addMsg(r.text || "No entendí.", 'bot');
          maybeRenderOpportunities(r.data);
        }
      } catch (_) {
        removeTyping(typingEl);
        addMsg('Error de conexión', 'bot');
      }
    }

    function addMsg(h, r) {
      const box = el('chat-msgs');
      if (!box) return;
      const d = document.createElement('div');
      d.className = `chat-bubble chat-${r} animate-pop`;
      d.innerText = h;
      box.appendChild(d);
      box.scrollTop = box.scrollHeight;
    }

    function addTyping() {
      const box = el('chat-msgs');
      if (!box) return null;
      const d = document.createElement('div');
      d.className = 'chat-bubble chat-bot animate-pop';
      d.innerHTML = `
        <div class="typing-row">
          <span class="typing-dot d1"></span>
          <span class="typing-dot d2"></span>
          <span class="typing-dot d3"></span>
          <span style="font-weight:800; opacity:.75; font-size:12px;">Escribiendo...</span>
        </div>
      `;
      box.appendChild(d);
      box.scrollTop = box.scrollHeight;
      return d;
    }

    function removeTyping(node) {
      try { if (node && node.parentNode) node.parentNode.removeChild(node); } catch (_) {}
    }

    function addTicket(items) {
      const ticket = String(items || '');
      const box = el('chat-msgs');
      if (!box) return;

      const d = document.createElement('div');
      d.className = 'animate-pop';
      d.innerHTML = `
        <div class="ticket-box">
          <div class="text-[11px] font-black uppercase tracking-widest mb-2 opacity-70">PEDIDO RECUPERADO</div>
          <div style="white-space: pre-wrap;">${escapeHtml(ticket)}</div>
          <button class="btn-copy-order" type="button"><i class="fas fa-copy"></i> COPIAR</button>
        </div>
      `;
      d.querySelector('button').addEventListener('click', (ev) => {
        copyPlainText(ticket);
        const btn = ev.currentTarget;
        const prev = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-check"></i> COPIADO';
        btn.style.background = '#10b981';
        setTimeout(() => { btn.innerHTML = prev; btn.style.background = ''; }, 1500);
      });

      box.appendChild(d);
      box.scrollTop = box.scrollHeight;
    }

    function addRouteBtn(zone) {
      const z = String(zone || '').trim();
      if (!z) return;
      const box = el('chat-msgs');
      if (!box) return;

      const d = document.createElement('div');
      d.className = 'animate-pop';
      d.innerHTML = `<button type="button" class="w-full bg-green-600 text-white p-3 rounded-xl font-bold mt-2 shadow-md btn-press"><i class="fas fa-map-signs"></i> IR A ${escapeHtml(z)}</button>`;
      d.querySelector('button').addEventListener('click', () => acceptIARoute(z));

      box.appendChild(d);
      box.scrollTop = box.scrollHeight;
    }

    function acceptIARoute(z) {
      toggleAIChat(false);
      state.sel = new Set([String(z).toUpperCase()]);
      startRoute();
    }

    function maybeRenderOpportunities(data) {
      if (!data) return;

      let obj = null;
      if (typeof data === 'string') {
        const s = data.trim();
        if (!s) return;
        try { obj = JSON.parse(s); } catch (_) { return; }
      } else if (typeof data === 'object') obj = data;

      if (!obj || !Array.isArray(obj.suggestions) || obj.suggestions.length === 0) return;

      const box = el('chat-msgs');
      if (!box) return;

      const wrap = document.createElement('div');
      wrap.className = 'animate-pop';
      const zone = obj.zone ? String(obj.zone) : 'Zona';

      wrap.innerHTML = `
        <div class="ticket-box">
          <div class="text-[11px] font-black uppercase tracking-widest mb-2 opacity-70">OPORTUNIDADES — ${escapeHtml(zone)}</div>
          <div id="opp-list" class="space-y-2"></div>
        </div>
      `;

      const list = wrap.querySelector('#opp-list');
      obj.suggestions.forEach((sug) => {
        const clienteId = String(sug.clienteId || '');
        const nombre = String(sug.clienteNombre || '');
        const dias = sug.diasSinComprar ?? '';
        const avg = sug.avgDias ?? null;
        const fecha = String(sug.ultimoPedidoFecha || '');
        const ticket = String(sug.ultimoPedidoTicket || '');

        const card = document.createElement('div');
        card.className = 'opp-card';
        card.innerHTML = `
          <div class="opp-title">#${escapeHtml(clienteId)} ${escapeHtml(nombre)}</div>
          <div class="opp-sub">Último: ${escapeHtml(fecha)} · ${escapeHtml(String(dias))} días sin comprar${avg ? ` · prom ${escapeHtml(String(avg))}d` : ''}</div>
          <div class="opp-meta">
            <span><i class="fas fa-clock"></i> ${escapeHtml(String(dias))}d</span>
            ${avg ? `<span><i class="fas fa-chart-line"></i> prom ${escapeHtml(String(avg))}d</span>` : ``}
          </div>
          <div class="opp-actions">
            <button type="button" class="opp-btn opp-btn-primary"><i class="fas fa-receipt"></i> Ver último pedido</button>
            <button type="button" class="opp-btn opp-btn-secondary"><i class="fas fa-location-crosshairs"></i> Ir a cliente</button>
          </div>
        `;

        const btnView = card.querySelectorAll('button')[0];
        const btnGo = card.querySelectorAll('button')[1];

        btnView.addEventListener('click', () => openOrderModal(`#${clienteId} ${nombre}`, ticket));
        btnGo.addEventListener('click', () => goToClient(clienteId));

        list.appendChild(card);
      });

      box.appendChild(wrap);
      box.scrollTop = box.scrollHeight;
    }

    function goToClient(clienteId) {
      const id = String(clienteId || '').trim();
      if (!id) return;

      const cli = (state.db?.clientes || []).find(c => String(c.id) === id);
      if (!cli) { addMsg(`No tengo ese cliente cargado ahora. (Cargá la zona donde está #${id})`, 'bot'); return; }

      if (state.route.active && state.route.active.length) {
        state.route.active = state.route.active.filter(c => String(c.id) !== id);
        state.route.active.unshift(cli);
        state.route.done.delete(id);
        renderRoute();
        toggleAIChat(false);
        switchView('view-route');
        toast(`Cliente #${id} al frente`, 'success');
        return;
      }

      state.sel = new Set([String(cli.localidad_key || cli.localidad || '').toUpperCase()]);
      startRoute();
      toggleAIChat(false);
      toast(`Ruta: ${cli.localidad || ''}`, 'success');
    }

    function openOrderModal(title, ticket) {
      state.currentOrder.title = String(title || '');
      state.currentOrder.ticket = String(ticket || '');

      const ot = el('order-title'); if (ot) ot.innerText = state.currentOrder.title || 'Pedido';
      const ok = el('order-ticket'); if (ok) ok.innerText = state.currentOrder.ticket || '';

      const m = el('modal-order');
      if (m) { m.classList.remove('hidden'); m.classList.add('flex'); }
    }

    function closeOrderModal() {
      const m = el('modal-order');
      if (m) { m.classList.add('hidden'); m.classList.remove('flex'); }
    }

    function copyCurrentOrder() {
      copyPlainText(state.currentOrder.ticket || '');
      toast('Pedido copiado', 'success');
    }

    function copyPlainText(txt) {
      const t = String(txt || '');
      try {
        if (navigator.clipboard && window.isSecureContext) navigator.clipboard.writeText(t);
        else {
          const area = document.createElement('textarea');
          area.value = t;
          document.body.appendChild(area);
          area.select();
          document.execCommand('copy');
          document.body.removeChild(area);
        }
      } catch (_) {}
    }

    function escapeHtml(str) {
      return String(str || '')
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }
    function escapeAttr(str) {
      return String(str || '').replaceAll("'", "\\'").replaceAll('"', '&quot;');
    }
  </script>
</body>
</html>
