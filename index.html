<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>üß† App de Vendedores Inteligente</title>

  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/png" sizes="32x32" href="ml-favicon-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="ml-favicon-16.png">
  <link rel="apple-touch-icon" href="ml-icon-192.png">
  <meta name="theme-color" content="#007aff">

  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-messaging-compat.js"></script>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* ====== Tema 2026 + modo oscuro ====== */
 
    :root{
      --azul:#007aff; --azul2:#005fcc; --ok:#00c851; --no:#ff4444;
      --bg:#f4f6f8; --card:#fff; --txt:#222; --borde:#e6e9ef; --sombra:rgba(0,0,0,.1);
    }
    body[data-dark="true"]{
      --azul:#58a6ff; --azul2:#1f6feb; --bg:#0d1117; --card:#111827; --txt:#e6edf3; --borde:#1f2937; --sombra:rgba(255,255,255,.06);
    }

    /* ====== Base ====== */
    html,body{margin:0;height:100%}
    body{
      font-family: "Inter", system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background:var(--bg); color:var(--txt);
      display:flex; flex-direction:column; align-items:center; min-height:100dvh; overflow-x:hidden;
      transition:background .3s,color .3s;
    }
    header{
      width:100%; background:var(--azul); color:#fff; padding:14px; text-align:center;
      position:sticky; top:0; z-index:999;
      box-shadow:0 2px 10px rgba(0,0,0,.2);
    }
    header h1{margin:0; font-size:1.3rem}
    .modo-toggle{position:absolute; right:12px; top:12px; cursor:pointer;
      font-size:1.2rem}

    main{width:100%; max-width:780px; padding:10px; margin-bottom:86px}
    h2{ text-align:center; margin:10px 0;
      color:var(--azul) }

    /* ====== Login ====== */
    #login{ position:fixed; inset:0; background:linear-gradient(135deg,#007aff,#00b4d8);
      display:flex; flex-direction:column; align-items:center;
      justify-content:center; color:#fff; z-index:10000; }
    .login-card{ background:#fff; color:#222; border-radius:15px; padding:20px; width:85%; max-width:350px; text-align:center;
      box-shadow:0 4px 12px rgba(0,0,0,.2);
    }
    .login-card input{ font-size:1.4rem; padding:10px; text-align:center; margin:10px 0; border:2px solid var(--azul); border-radius:10px;
      width:80% }
    .teclado-numerico button{ width:30%; margin:5px; padding:10px; font-size:1.2rem; border:none; border-radius:10px; background:var(--azul); color:#fff; cursor:pointer;
      transition:.2s }
    .teclado-numerico button:hover{ background:var(--azul2) }
    #error{ color:#ff3737;
      min-height:1.1em }

    /* ====== Menu bottom ====== */
    .menu{ display:flex; justify-content:space-around; background:var(--card); width:100%;
      border-top:1px solid var(--borde); position:fixed; bottom:0; left:0; z-index:1000; }
    .menu button{ flex:1; padding:10px; border:none; background:transparent; font-size:1rem; cursor:pointer;
      transition:.2s }
    .menu button.activo{ background:var(--azul); color:#fff; font-weight:700 }

    /* ====== Secciones ====== */
    .seccion{ display:none;
      animation:fade .25s ease }
    .seccion.visible{ display:block }
    @keyframes fade{ from{opacity:0; transform:translateY(6px)} to{opacity:1;
      transform:translateY(0)} }

    /* ====== Cards ====== */
    .cliente{
      background:var(--card);
      border-radius:12px; padding:14px; margin:10px 0; box-shadow:0 2px 8px var(--sombra); border:1px solid var(--borde);
    }
    .cliente h3{ margin:0 0 6px 0; color:var(--azul) }
    .cliente .fila{ display:flex; gap:10px; align-items:center;
      flex-wrap:wrap }
    .cliente .acciones{ margin-top:8px; display:flex; gap:6px; flex-wrap:wrap }
    .cliente button{ background:var(--azul); color:#fff; border:none;
      border-radius:8px; padding:8px 12px; cursor:pointer }
    .cliente button:hover{ background:var(--azul2) }
    .btn-secundario{ background:#00b894 }
    .btn-lock{ background:#6b7280 }
    .cliente[draggable="true"]{ cursor:grab }
    .cliente.bloqueado{ opacity:.85;
      filter:saturate(.8) }

    .badge{ background:#eef2ff; color:#2c3e50; padding:2px 8px; border-radius:999px; font-size:.85rem;
      border:1px solid var(--borde) }

    /* ====== Contenedores ====== */
    #mapaFull{ height:68vh; width:100%; border-radius:12px; overflow:hidden;
      box-shadow:0 2px 8px var(--sombra) }
    .panel-resumen{ text-align:center; background:var(--card); padding:15px; border-radius:12px; box-shadow:0 2px 8px var(--sombra); border:1px solid var(--borde);
      margin-bottom:20px }
    canvas{ max-width:320px; margin:auto }

    /* ====== Toast ====== */
    .toast{
      position:fixed;
      bottom:20px; left:50%; transform:translateX(-50%);
      background:var(--azul); color:#fff; padding:10px 16px; border-radius:10px; box-shadow:0 4px 14px rgba(0,0,0,.25);
      z-index:9999; opacity:0;
      animation:pop .2s forwards, fadeout .2s forwards 2.6s;
    }
    @keyframes pop{ to{ opacity:1;
      transform:translateX(-50%) translateY(0) } }
    @keyframes fadeout{ to{ opacity:0 } }
  </style>
</head>

<body>
  <div id="login">
    <div class="login-card">
      <h1>üß† App de Vendedores</h1>
      <h2>üîê Ingres√° tu c√≥digo</h2>
      <input type="password" id="clave" maxlength="4" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
      <div class="teclado-numerico">
        <button onclick="agregarDigito('1')">1</button><button onclick="agregarDigito('2')">2</button><button onclick="agregarDigito('3')">3</button>
        <button onclick="agregarDigito('4')">4</button><button onclick="agregarDigito('5')">5</button><button onclick="agregarDigito('6')">6</button>
        <button onclick="agregarDigito('7')">7</button><button onclick="agregarDigito('8')">8</button><button onclick="agregarDigito('9')">9</button>
     
       <button onclick="borrarDigito()">‚å´</button><button onclick="agregarDigito('0')">0</button><button onclick="login()">‚úîÔ∏è</button>
      </div>
      <p id="error"></p>
    </div>
  </div>

  <header>
    <h1 id="titulo">üß† App de Vendedores</h1>
    <div class="modo-toggle" onclick="toggleModoOscuro()">üåô</div>
  </header>

  <main>
    <section id="seccion-ruta" class="seccion visible">
      <h2>üó∫Ô∏è Ruta del D√≠a</h2>
      <div id="estado" style="text-align:center;
      margin:6px 0 10px"></div>
      <div id="contenedor"></div>
    </section>

    <section id="seccion-mapa" class="seccion">
      <h2>üìç Mapa</h2>
      <div id="mapaFull"></div>
    </section>

    <section id="seccion-calendario" class="seccion">
      <h2>üìÖ Calendario</h2>
      <div id="contenedorCalendario"></div>
    </section>

    <section id="seccion-resumen" class="seccion">
      <h2>üìà Resumen</h2>
      <div 
      id="contenedorResumen" class="panel-resumen"></div>
      <canvas id="graficoResumen"></canvas>
    </section>
  </main>

  <div class="menu">
    <button id="btnRuta" class="activo" onclick="mostrarSeccion('ruta')">üó∫Ô∏è Ruta</button>
    <button id="btnMapa" onclick="mostrarSeccion('mapa')">üìç Mapa</button>
    <button id="btnCalendario" onclick="mostrarSeccion('calendario')">üìÖ</button>
    <button id="btnResumen" onclick="mostrarSeccion('resumen')">üìà</button>
    <button id="btnLogout" onclick="logout()">üö™</button>
  </div>

<script>
    /* ================================
       ‚öôÔ∏è Config principal
    ================================ */
    const vendedores = { "0001": "Mart√≠n", "0002": "Lucas", "0003": "Mercado Limpio" };
    // igual a tu app
    const URL_API_BASE = "https://script.google.com/macros/s/AKfycbzqPMRir2VCB_C_EUsa0o8-eYCRDM4AQLsY3Jx_5jRKkYi-D2WgTEkTFrBIRFugT5MW/exec";
    // tu endpoint
    let clientesData = [];
    let posicionActual = null;
    let mapaFull = null;
    let dragSrc = null;

    /* ================================
       üîê Login
    ================================ */
    function agregarDigito(n){const i=document.getElementById("clave");
    if(i.value.length<4) i.value+=n;}
    function borrarDigito(){const i=document.getElementById("clave"); i.value=i.value.slice(0,-1);}
    function login(){
      const c=document.getElementById("clave").value.trim();
      const e=document.getElementById("error");
      if(!vendedores[c]){ e.textContent="‚ùå Clave incorrecta"; return; }
      localStorage.setItem("vendedorClave", c);
      document.getElementById("login").style.display="none";
      mostrarApp();
    }
    function logout(){ localStorage.removeItem("vendedorClave"); location.reload(); }
    window.onload=()=>{
      const c=localStorage.getItem("vendedorClave");
      if(c && vendedores[c]){ document.getElementById("login").style.display="none"; mostrarApp(); }
    };
    /* ================================
       üß≠ Navegaci√≥n de secciones
    ================================ */
    function mostrarSeccion(s){
      document.querySelectorAll(".seccion").forEach(sec=>sec.classList.remove("visible"));
      document.getElementById("seccion-"+s).classList.add("visible");
      document.querySelectorAll(".menu button").forEach(b=>b.classList.remove("activo"));
      const btn=document.querySelector(`[onclick="mostrarSeccion('${s}')"]`); if(btn) btn.classList.add("activo");
      if(s==="mapa") renderMapaFull();
    }

    /* ================================
       üöÄ App
    ================================ */
    async function mostrarApp(){
      const clave=localStorage.getItem("vendedorClave");
      const nombre=vendedores[clave];
      document.getElementById("titulo").textContent=`üëã Hola, ${nombre}`;
      mostrarSeccion("ruta");
      await cargarRuta(clave);
      await cargarResumen(clave);
      await cargarCalendario();
      inicializarNotificaciones(clave);
      // FCM se inicializa aqu√≠
    }

    /* ================================
       üìç Distancia (Haversine)
    ================================ */
    const toRad = (d)=> d*Math.PI/180;
    function distanciaKm(aLat,aLng,bLat,bLng){
      const R=6371, dLat=toRad(bLat-aLat), dLng=toRad(bLng-aLng);
      const A = Math.sin(dLat/2)**2 + Math.cos(toRad(aLat))*Math.cos(toRad(bLat))*Math.sin(dLng/2)**2;
      return R*2*Math.atan2(Math.sqrt(A), Math.sqrt(1-A));
    }

    /* ================================
       üóÇÔ∏è Orden + bloqueo por cliente
    ================================ */
    function keyOrden(){ return "ordenClientes_"+localStorage.getItem("vendedorClave");
    }
    function keyLock(){ return "clientesLock_"+localStorage.getItem("vendedorClave"); }
    function cargarOrden(){ try{ return JSON.parse(localStorage.getItem(keyOrden())||"[]"); }catch{ return [];
    } }
    function guardarOrden(ids){ localStorage.setItem(keyOrden(), JSON.stringify(ids)); }
    function locks(){ try{ return JSON.parse(localStorage.getItem(keyLock())||"{}");
    }catch{ return {}; } }
    function setLock(id, val){ const m=locks(); m[id]=val; localStorage.setItem(keyLock(), JSON.stringify(m));
    }

    /* ================================
       üöó Cargar ruta
    ================================ */
    async function cargarRuta(clave){
      const cont=document.getElementById("contenedor");
      cont.innerHTML="‚è≥ Cargando clientes...";
      try{
        const [r1, predR] = await Promise.all([
          fetch(`${URL_API_BASE}?accion=getRutaDelDiaPorVendedor&clave=${clave}`),
          fetch(`${URL_API_BASE}?accion=getPrediccionesVendedor&clave=${clave}`)
        ]);
        clientesData = await r1.json();
        const pred = await predR.json();

        // estado header
        const ahora = new Date().toLocaleString("es-AR", { timeZone:"America/Argentina/Buenos_Aires" });
        document.getElementById("estado").textContent = `Ruta cargada (${clientesData.length} clientes) ‚Äî √öltima actualizaci√≥n: ${ahora}`;
        // aplicar orden guardado
        const orden = cargarOrden();
        if(orden.length){
          const map = new Map(clientesData.map(c=>[String(c.numero), c]));
          clientesData = orden.map(id=>map.get(String(id))).filter(Boolean)
            .concat(clientesData.filter(c=>!orden.includes(String(c.numero))));
        }

        // tomar ubicaci√≥n actual (para distancias)
        if(navigator.geolocation){
          navigator.geolocation.getCurrentPosition(pos=>{
            posicionActual = { lat:pos.coords.latitude, lng:pos.coords.longitude };
            renderClientes();
          }, ()=>renderClientes(), { enableHighAccuracy:true, maximumAge:15000, timeout:8000 });
        }else{
          renderClientes();
        }

        // panel de IA/resumen r√°pido en la secci√≥n Resumen si quer√©s usarlo
        // (tu backend ya env√≠a `mensaje`, `tasa`, etc)
        if(pred && pred.mensaje){
          // se muestra en cargarResumen para unificar
        }

      }catch(e){
        console.error(e);
        cont.innerHTML="‚ùå Error al cargar clientes.";
      }
    }

    /* ================================
       üß± Render de tarjetas + drag&drop
    ================================ */
    function renderClientes(){
      const cont=document.getElementById("contenedor");
      cont.innerHTML="";

      const mlocks = locks();

      clientesData.forEach((c, idx)=>{
        const card = document.createElement("div");
        card.className = "cliente";
        card.id = "c_"+c.numero;
        const tieneGeo = typeof c.lat==="number" && typeof c.lng==="number";
        const dist = (posicionActual && tieneGeo) ? distanciaKm(posicionActual.lat,posicionActual.lng,c.lat,c.lng) : null;

        const lock = !!mlocks[c.numero];
        card.classList.toggle("bloqueado", lock);
        card.setAttribute("draggable", String(!lock));

  
    card.innerHTML = `
  <h3>${c.nombre}</h3>
  <div class="fila">
    <span>üìç ${c.direccion || ""}${c.localidad ? ", "+c.localidad : ""}</span>
    ${dist!==null ? `<span class="badge">üìè ${dist.toFixed(1)} km</span>` : ""}
  </div>
  <div class="fila" style="margin-top:6px">
    <label><input type="checkbox" id="visitado-${c.numero}"> Visitado</label>
    <label><input type="checkbox" id="compro-${c.numero}"> Compr√≥</label>
  </div>
  <textarea id="coment-${c.numero}" placeholder="Comentario..." rows="2" style="width:100%;margin-top:6px"></textarea>
  <div class="acciones">
    <button onclick="registrarVisita(${c.numero})">üíæ Guardar</button>
    <button class="btn-secundario" onclick="irCliente(${tieneGeo?c.lat:"null"},${tieneGeo?c.lng:"null"})">üöó Ir</button>
    <button class="btn-lock" onclick="toggleLock(${c.numero})">${lock ? "üîí Bloqueado" : "üîì Bloquear"}</button>
  </div>
`;

        // Drag & Drop
        card.addEventListener("dragstart", (ev)=>{ dragSrc = idx; ev.dataTransfer.effectAllowed="move"; });
        card.addEventListener("dragover", (ev)=>{ ev.preventDefault(); ev.dataTransfer.dropEffect="move"; });
        card.addEventListener("drop", (ev)=>{
          ev.preventDefault();
          const target = Array.from(cont.children).indexOf(card);
          if(dragSrc===null || dragSrc===target) return;
          const moved = clientesData.splice(dragSrc,1)[0];
          clientesData.splice(target,0,moved);
          dragSrc = null;
          // guardar orden
          guardarOrden(clientesData.map(x=>String(x.numero)));
 
           renderClientes();
        });

        cont.appendChild(card);
      });
    }

    function toggleLock(numero){
      const m=locks();
      const now = !m[numero];
      setLock(numero, now);
      toast(now?"üîí Tarjeta bloqueada":"üîì Tarjeta desbloqueada");
      renderClientes();
    }

    /* ================================
       üó∫Ô∏è Mapa (vista separada)
    ================================ */
    function renderMapaFull(){
      const el = document.getElementById("mapaFull");
      if(!el) return;
      el.innerHTML = "";
      mapaFull = L.map("mapaFull").setView([-34.7,-58.4], 11);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(mapaFull);

      const group = [];
      clientesData.forEach(c=>{
        if(typeof c.lat==="number" && typeof c.lng==="number"){
          const mk = L.marker([c.lat, c.lng]).addTo(mapaFull).bindPopup(c.nombre);
          group.push(mk);
        }
      });
      if(group.length){ const gl = L.featureGroup(group); mapaFull.fitBounds(gl.getBounds().pad(0.3)); }

      if(posicionActual){
        L.marker([posicionActual.lat,posicionActual.lng],{
          icon: L.icon({ iconUrl:"https://cdn-icons-png.flaticon.com/512/684/684908.png", iconSize:[32,32] })
        }).addTo(mapaFull).bindPopup("üìç Est√°s aqu√≠");
      }else if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(pos=>{
          posicionActual={lat:pos.coords.latitude,lng:pos.coords.longitude};
          renderMapaFull();
        });
      }
    }

    /* ==================================
       INICIO DE LA SECCI√ìN CORREGIDA
       (Aqu√≠ estaba el SyntaxError que romp√≠a todo)
    ================================== */
    function irCliente(lat, lng) {
      if (!lat || !lng) {
        alert("üìç Este cliente no tiene coordenadas.");
        return;
      }
      
      // Usamos la URL est√°ndar de Google Maps para direcciones
      const baseUrl = "https://www.google.com/maps/dir/?api=1";
      // Usamos backticks (`) y ${} para insertar las variables
      const destino = `&destination=${lat},${lng}&travelmode=driving`;

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
          // Si tenemos la ubicaci√≥n, armamos la URL con origen y destino
          const origen = `&origin=${pos.coords.latitude},${pos.coords.longitude}`;
          window.open(`${baseUrl}${origen}${destino}`, "_blank");
        }, () => {
          // Si falla la geolocalizaci√≥n (ej. no dio permiso), abre solo el destino
          window.open(`${baseUrl}${destino}`, "_blank");
        });
      } else {
        // Si el navegador no soporta geolocalizaci√≥n, abre solo el destino
        window.open(`${baseUrl}${destino}`, "_blank");
      }
    }
    /* ================================
       FIN DE LA SECCI√ìN CORREGIDA
    ================================ */

    /* ================================
       üíæ Registrar visita (+ offline)
    ================================ */
    function getClientePorNumero(num){ return clientesData.find(x=>String(x.numero)===String(num));
    }

    async function registrarVisita(numero){
      const c = getClientePorNumero(numero);
      if(!c){ toast("‚ùå Cliente no encontrado"); return; }
      const visitado = document.getElementById(`visitado-${numero}`).checked;
      const compro   = document.getElementById(`compro-${numero}`).checked;
      const comentario = (document.getElementById(`coment-${numero}`).value||"").trim();
      const vendedor = localStorage.getItem("vendedorClave");
      const params = new URLSearchParams({
        accion:"registrarVisita",
        numero:c.numero, nombre:c.nombre, direccion:c.direccion||"", localidad:c.localidad||"",
        visitado, compro, comentario, vendedor
      });
      try{
        const r = await fetch(`${URL_API_BASE}?${params.toString()}`);
        const js = await r.json();
        toast(js.estado || "‚úÖ Visita registrada");
        // marcar en UI
        if(visitado) document.getElementById(`visitado-${numero}`).checked = true;
      }catch{
        // offline queue
        queueOffline({ t:"visita", params:Object.fromEntries(params) });
        toast("üì∂ Sin conexi√≥n. Guardado offline y se sincroniza despu√©s.");
      }
    }

    function queueOffline(item){
      const k="offlineQueue";
      let q=[];
      try{ q=JSON.parse(localStorage.getItem(k)||"[]"); }catch{}
      q.push(item); localStorage.setItem(k, JSON.stringify(q));
    }

    async function syncOffline(){
      if(!navigator.onLine) return;
      const k="offlineQueue"; let q=[];
      try{ q=JSON.parse(localStorage.getItem(k)||"[]");
      }catch{}
      if(!q.length) return;

      const rest=[];
      // reintentos fallidos
      for(const it of q){
        try{
          if(it.t==="visita"){
            const p = new URLSearchParams(it.params);
            const r = await fetch(`${URL_API_BASE}?${p.toString()}`);
            await r.json();
          }
        }catch{ rest.push(it);
        }
      }
      localStorage.setItem(k, JSON.stringify(rest));
      if(q.length && rest.length===0) toast("‚úÖ Sincronizaci√≥n completada");
    }
    window.addEventListener("online", syncOffline);

    /* ================================
       üìà Resumen + gr√°fico
    ================================ */
    async function cargarResumen(clave){
      const cont=document.getElementById("contenedorResumen");
      cont.innerHTML="‚è≥ Analizando desempe√±o...";
      try{
        const [r1,r2]=await Promise.all([
          fetch(`${URL_API_BASE}?accion=getResumenVendedor&clave=${clave}`),
          fetch(`${URL_API_BASE}?accion=getPrediccionesVendedor&clave=${clave}`)
        ]);
        const res=await r1.json(), ana=await r2.json();
        cont.innerHTML = `
          <h3>${res.fecha||""}</h3>
          <p>üö∂ Visitas: <b>${res.totalHoy||0}</b> ‚Äî üõí Compraron: <b>${res.compraronHoy||0}</b></p>
          <p>üéØ Tasa: <b>${res.tasa||0}%</b> ‚Äî ‚è±Ô∏è Frecuencia: <b>${res.frecuenciaProm||"N/D"}</b> d√≠as</p>
          <p>ü§ñ ${ana.mensaje||""}</p>
        `;
        const ctx=document.getElementById("graficoResumen").getContext("2d");
        new Chart(ctx,{type:"doughnut",data:{labels:["Compraron","No compraron"],datasets:[{data:[res.compraronHoy||0,(res.totalHoy||0)-(res.compraronHoy||0)],backgroundColor:["#00c851","#ff4444"]}]} ,options:{plugins:{legend:{display:false}}}});
      }catch(e){
        console.error(e); cont.innerHTML="‚ùå Error al cargar resumen.";
      }
    }

    /* ================================
       üìÖ Calendario
    ================================ */
    async function cargarCalendario(){
      const cont = document.getElementById("contenedorCalendario");
      const clave=localStorage.getItem("vendedorClave");
      if(!clave){ cont.innerHTML="‚ö†Ô∏è Debes iniciar sesi√≥n primero."; return; }
      cont.innerHTML="‚è≥ Cargando calendario...";
      try{
        const resp = await fetch(`${URL_API_BASE}?accion=getCalendarioVisitas&clave=${clave}`);
        const data = await resp.json();
        if(!data || !data.length){ cont.innerHTML="üì≠ No hay visitas programadas."; return; }
        let html = `<div class="panel-resumen">`;
        data.forEach(f=>{
          html += `<div style="display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--borde);padding:8px 0">
            <div><b>${f.fecha}</b> ‚Äî ${f.dia}<br><span>üìç ${f.localidad||""}</span></div>
            <div style="font-size:1.1rem">${f.compro?"‚úÖ":"‚ùå"}</div>
          </div>`;
        });
        html += `</div>`;
        cont.innerHTML = html;
      }catch(e){ console.error(e); cont.innerHTML="‚ùå Error al cargar calendario.";
      }
    }

/* ==================================================
   üîî REGISTRO DE TOKEN FIREBASE (PUSH)
   -------------------------------------------------- */
async function registrarTokenPush() {
  try {
    if (!("Notification" in window) || !("serviceWorker" in navigator)) {
      console.log("‚ö†Ô∏è Notificaciones no soportadas en este dispositivo.");
      return;
    }

    const permiso = await Notification.requestPermission();
    if (permiso !== "granted") {
      console.log("‚ö†Ô∏è El usuario no permiti√≥ notificaciones.");
      return;
    }

    // Registrar Service Worker
    const reg = await navigator.serviceWorker.register("service-worker.js");

    // Obtener token desde Firebase (usando el SW registrado)
    const messaging = firebase.messaging();
    const token = await messaging.getToken({ serviceWorkerRegistration: reg });

    if (!token) {
      console.warn("‚ö†Ô∏è No se pudo obtener el token FCM.");
      return;
    }

    const vendedor = localStorage.getItem("vendedorClave");
    if (!vendedor) return;

    console.log("üì¨ Token generado:", token);

    // ‚úÖ ENVIAR TOKEN AL CLOUDFLARE WORKER (CORRECTO PARA EVITAR CORS)
    await fetch(`${URL_API_BASE}/guardarToken`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ vendedor, token })
    });

    console.log("‚úÖ Token enviado correctamente al servidor");

  } catch (e) {
    console.error("‚ùå Error al registrar token:", e);
  }
}




    /* ================================
       üåô Modo oscuro
    ================================ */
    function toggleModoOscuro(){
      const dark = document.body.getAttribute("data-dark")==="true";
      document.body.setAttribute("data-dark", !dark);
      localStorage.setItem("modoOscuro", String(!dark));
    }
    if(localStorage.getItem("modoOscuro")==="true"){ document.body.setAttribute("data-dark", "true");
    }

    /* ================================
       üí¨ Toast
    ================================ */
    function toast(msg){
      const t = document.createElement("div");
      t.className = "toast"; t.textContent = msg;
      document.body.appendChild(t);
      setTimeout(()=>t.remove(), 2900);
    }

    /* ================================
       üîÅ Sincronizaci√≥n al iniciar
    ================================ */
    (async function bootstrap(){
      await syncOffline();
    })();
  </script>
</body>
</html>
